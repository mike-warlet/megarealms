<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MegaRealms - On-Chain MMORPG</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
body{background:#111;color:#ccc;font-family:'Press Start 2P',monospace;overflow:hidden;height:100vh;display:flex;justify-content:center;align-items:center;}
#start-screen{text-align:center;padding:40px;max-width:620px;}
#start-screen h1{font-size:28px;color:#f0c040;text-shadow:2px 2px #000,0 0 20px rgba(240,192,64,.3);margin-bottom:8px;}
#start-screen .sub{font-size:9px;color:#888;margin-bottom:24px;}
#start-screen label{display:block;font-size:9px;text-align:left;margin:10px 0 5px;color:#aaa;}
#start-screen input{width:100%;padding:10px;background:#1a1a2e;border:2px solid #444;color:#f0c040;font-family:inherit;font-size:11px;border-radius:4px;}
#start-screen input:focus{outline:none;border-color:#f0c040;}
.vgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0 16px;}
.vc{background:linear-gradient(135deg,#16142a,#0e0c1e);border:2px solid #3a3050;border-radius:8px;padding:12px;cursor:pointer;text-align:center;transition:.2s;box-shadow:0 2px 8px rgba(0,0,0,.4);}
.vc:hover{border-color:#8070b0;box-shadow:0 2px 12px rgba(128,112,176,.2);}
.vc.sel{border-color:#f0c040;background:linear-gradient(135deg,#1e1a30,#141028);box-shadow:0 0 16px rgba(240,192,64,.15);}
.vc .vi{font-size:24px;margin-bottom:4px;}.vc .vn{font-size:9px;color:#f0c040;}.vc .vd{font-size:6px;color:#777;margin-top:3px;line-height:1.4;}
.btn-go{background:linear-gradient(135deg,#f0c040,#c49a20);color:#111;border:2px solid #e0b030;padding:14px 40px;font-family:inherit;font-size:12px;border-radius:6px;cursor:pointer;margin-top:12px;box-shadow:0 4px 16px rgba(240,192,64,.3);transition:.2s;text-shadow:0 1px 0 rgba(255,255,255,.2);}
.btn-go:hover:not(:disabled){box-shadow:0 4px 24px rgba(240,192,64,.5);transform:translateY(-1px);}
.btn-go:disabled{opacity:0.3;cursor:default;}
#game-screen{display:none;width:100vw;height:100vh;flex-direction:column;background:#2a2a2a;}
#top-bar{height:48px;background:linear-gradient(180deg,#3e3428,#2a2420);border-bottom:2px solid #c9a959;display:flex;align-items:center;padding:0 10px;gap:10px;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.5);}
.bg{display:flex;align-items:center;gap:4px;}
.bl{font-size:7px;color:#aaa;min-width:18px;}
.bc{width:110px;height:16px;background:#0a0a0a;border:2px solid #666;border-radius:3px;overflow:hidden;position:relative;box-shadow:inset 0 2px 4px rgba(0,0,0,.6);}
.bf{height:100%;border-radius:1px;}.bf.hp{background:linear-gradient(180deg,#f44,#c22,#a11);box-shadow:0 0 6px rgba(255,60,60,.4);}
.bf.mp{background:linear-gradient(180deg,#44f,#22c,#11a);box-shadow:0 0 6px rgba(60,60,255,.4);}
.bf.xp{background:linear-gradient(180deg,#fa4,#c82,#a61);box-shadow:0 0 6px rgba(255,170,40,.4);}
.bt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:6px;color:#fff;text-shadow:1px 1px #000;}
.sb{font-size:7px;color:#ddd;}.sb b{color:#f0c040;}
#wbtn{margin-left:auto;background:#333;border:1px solid #555;color:#ccc;font-family:inherit;font-size:6px;padding:5px 8px;border-radius:3px;cursor:pointer;}
#wbtn:hover{border-color:#f0c040;}
#mid{display:flex;flex:1;overflow:hidden;}
#gc{image-rendering:pixelated;image-rendering:crisp-edges;background:#000;display:block;}
#side{width:260px;background:linear-gradient(180deg,#2a2420,#1e1a16);border-left:2px solid #c9a959;display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;box-shadow:-3px 0 10px rgba(0,0,0,.5);}
.pt{font-size:7px;color:#c9a959;padding:6px 8px 4px;border-bottom:1px solid #4a3a20;background:rgba(0,0,0,.2);text-shadow:0 1px 2px rgba(0,0,0,.5);cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center;}
.pt .arrow{font-size:6px;transition:transform .2s;}.pt.collapsed .arrow{transform:rotate(-90deg);}
.collapsible{overflow:hidden;transition:max-height .25s ease;max-height:600px;}.collapsible.hidden{max-height:0;padding:0 !important;border:none !important;}
.eg{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;padding:4px 16px;justify-items:center;}
.es{width:42px;height:42px;background:linear-gradient(180deg,#2a2828,#1a1818);border:2px solid #555;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;position:relative;box-shadow:inset 0 2px 6px rgba(0,0,0,.7);}
.es:hover{border-color:#aaa;box-shadow:inset 0 0 8px rgba(255,255,255,.1);}.es.f{border-color:#c9a959;background:linear-gradient(180deg,#3a3020,#2a2010);box-shadow:inset 0 0 8px rgba(201,169,89,.2);}
.es .sl{position:absolute;bottom:-1px;font-size:4px;color:#888;text-shadow:0 0 2px #000;}
.ig{display:grid;grid-template-columns:repeat(6,1fr);gap:2px;padding:6px;}
.is{width:34px;height:34px;background:linear-gradient(135deg,#1a1820,#12101a);border:1px solid #3a3535;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:13px;cursor:pointer;position:relative;transition:border-color .15s,box-shadow .15s;}
.is:hover{border-color:#c9a959;box-shadow:0 0 6px rgba(201,169,89,.3);}
.is .q{position:absolute;bottom:0;right:1px;font-size:5px;color:#f0c040;}
.is .tip{display:none;position:absolute;bottom:105%;left:50%;transform:translateX(-50%);background:#000;color:#ccc;padding:3px 6px;font-size:5px;white-space:nowrap;border:1px solid #555;border-radius:2px;z-index:10;}
.is:hover .tip{display:block;}
#spell-bar{display:flex;gap:3px;padding:4px 6px;border-top:1px solid #333;flex-wrap:wrap;}
.sp-slot{width:34px;height:34px;background:linear-gradient(135deg,#1a1828,#10101a);border:2px solid #3a3060;border-radius:4px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;position:relative;transition:border-color .15s,box-shadow .15s;}
.sp-slot:hover{border-color:#a080f0;box-shadow:0 0 8px rgba(160,128,240,.3);}
.sp-slot .si2{font-size:12px;}.sp-slot.cd{opacity:.3;border-color:#222;}
#quest-panel{border-top:1px solid #333;padding:4px 8px;max-height:140px;overflow-y:auto;}
.qt{font-size:5px;color:#aaa;line-height:1.8;cursor:pointer;padding:2px 4px;border-radius:3px;}.qt:hover{background:rgba(255,255,255,0.05);}.qt b{color:#f0c040;}.qt .qp{color:#4f4;}
.qb-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:200;justify-content:center;align-items:center;}
.qb-box{background:linear-gradient(180deg,#1e1a30,#12101e);border:2px solid #8060c0;border-radius:8px;min-width:340px;max-width:420px;max-height:80vh;padding:12px;color:#e0d8c0;font-family:monospace;overflow-y:auto;box-shadow:0 0 30px rgba(120,80,200,0.4);}
.qb-title{text-align:center;color:#c8a0f0;font-size:12px;font-weight:bold;margin-bottom:8px;}
.qb-cat{color:#8060c0;font-size:7px;font-weight:bold;margin:8px 0 4px;padding-bottom:2px;border-bottom:1px solid #3a2060;}
.qb-item{display:flex;align-items:center;justify-content:space-between;padding:5px 6px;margin:2px 0;background:rgba(120,80,200,0.08);border:1px solid rgba(120,80,200,0.2);border-radius:4px;font-size:6px;cursor:default;}
.qb-item:hover{border-color:#8060c0;background:rgba(120,80,200,0.15);}
.qb-item .qb-name{color:#e0d0f0;font-weight:bold;font-size:7px;}
.qb-item .qb-desc{color:#999;font-size:5px;margin-top:1px;}
.qb-item .qb-reward{color:#f0c040;font-size:5px;}
.qb-item .qb-lvl{color:#888;font-size:5px;}
.qb-accept{background:#3a2060;border:1px solid #8060c0;color:#c8a0f0;font-family:inherit;font-size:6px;padding:3px 8px;border-radius:3px;cursor:pointer;white-space:nowrap;}
.qb-accept:hover{background:#5030a0;}

.hk-cfg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:110;justify-content:center;align-items:center;}
.hk-cfg.show{display:flex;}
#hk-panel{background:#1a1a2a;border:2px solid #c9a959;border-radius:6px;padding:16px;max-width:360px;width:90%;max-height:80vh;overflow-y:auto;}
#hk-panel h3{font-size:10px;color:#f0c040;margin-bottom:8px;text-align:center;}
.hk-row{display:flex;align-items:center;justify-content:space-between;padding:4px 0;border-bottom:1px solid #222;font-size:6px;color:#ccc;}
.hk-row .hk-name{flex:1;}.hk-row .hk-key{background:#222;border:1px solid #555;border-radius:3px;padding:2px 8px;font-size:7px;color:#f0c040;cursor:pointer;min-width:40px;text-align:center;}
.hk-row .hk-key.editing{border-color:#f0c040;background:#332200;animation:pulse .8s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes premGlow{0%,100%{box-shadow:0 1px 4px rgba(240,192,64,0.4);}50%{box-shadow:0 1px 10px rgba(240,192,64,0.8);}}
@keyframes realmGlow{0%,100%{box-shadow:0 1px 4px rgba(64,192,128,0.4);}50%{box-shadow:0 1px 10px rgba(64,192,128,0.8);}}
.sp-slot .sk{font-size:4px;color:#a080f0;position:absolute;top:1px;left:2px;font-weight:bold;cursor:pointer;}
#player-panel{padding:4px 8px;max-height:60px;overflow-y:auto;}
.pe{font-size:6px;color:#4f4;padding:2px 0;}
#bot{height:80px;background:linear-gradient(180deg,#1a1816,#111010);border-top:2px solid #c9a959;display:flex;flex-direction:column;flex-shrink:0;box-shadow:0 -2px 8px rgba(0,0,0,.5);}
#chat-log{flex:1;overflow-y:auto;padding:4px 10px;}
.mg{font-size:6px;line-height:1.6;}
.mg.combat{color:#e44;}.mg.loot{color:#f0c040;}.mg.system{color:#6af;}.mg.heal{color:#4e4;}.mg.level{color:#fa3;font-size:7px;}.mg.quest{color:#d4f;}.mg.spell{color:#f8f;}
#chat-input{display:flex;border-top:1px solid #333;}
#chat-in{flex:1;background:#111;border:none;color:#ccc;font-family:inherit;font-size:7px;padding:4px 8px;outline:none;}
#shop-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;justify-content:center;align-items:center;}
#shop-p{background:#1a1a2a;border:2px solid #c9a959;border-radius:6px;padding:16px;max-width:420px;width:90%;max-height:80vh;overflow-y:auto;}
#shop-p h3{font-size:10px;color:#f0c040;margin-bottom:10px;text-align:center;}
.si{display:flex;align-items:center;gap:6px;padding:5px;border:1px solid #333;border-radius:3px;margin-bottom:3px;cursor:pointer;font-size:14px;}
.si:hover{background:#2a2a3a;border-color:#c9a959;}
.si .sn{font-size:7px;color:#ccc;}.si .sd{font-size:5px;color:#777;}.si .sp{font-size:7px;color:#f0c040;margin-left:auto;}.si .sa{font-size:5px;color:#8af;margin-top:1px;}.si{position:relative;}.si-tip{display:none;position:absolute;left:50%;top:100%;transform:translateX(-50%);background:#1a1a2e;border:1px solid #c9a959;border-radius:4px;padding:6px 8px;z-index:100;min-width:140px;font-size:6px;color:#ccc;white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,.8);}.si:hover .si-tip{display:block;}.si-tip .tt-name{font-size:7px;color:#f0c040;font-weight:bold;margin-bottom:3px;}.si-tip .tt-stat{color:#8af;}.si-tip .tt-desc{color:#999;margin-top:2px;font-style:italic;}
.scl{display:block;margin:8px auto 0;background:#444;border:1px solid #666;color:#ccc;padding:5px 14px;font-family:inherit;font-size:7px;border-radius:3px;cursor:pointer;}
#death-ov{display:none;position:fixed;inset:0;background:rgba(80,0,0,.75);z-index:200;justify-content:center;align-items:center;flex-direction:column;backdrop-filter:blur(3px);}
#death-ov h2{font-size:22px;color:#f44;margin-bottom:10px;text-shadow:0 0 20px rgba(255,60,60,.6);}
#death-ov p{font-size:9px;color:#daa;margin-bottom:20px;}
#death-ov button{background:linear-gradient(135deg,#c33,#900);border:2px solid #f66;color:#fff;padding:10px 28px;font-family:inherit;font-size:10px;border-radius:6px;cursor:pointer;box-shadow:0 4px 16px rgba(255,60,60,.3);transition:.2s;}
#death-ov button:hover{box-shadow:0 4px 24px rgba(255,60,60,.5);transform:translateY(-1px);}
#tgt{position:fixed;top:56px;left:8px;background:rgba(10,5,0,.92);border:2px solid #a33;border-radius:6px;padding:8px 12px;display:none;z-index:50;box-shadow:0 2px 12px rgba(180,50,50,.3);}
#tgt .tn{font-size:8px;color:#f66;margin-bottom:4px;text-shadow:0 0 4px rgba(255,60,60,.4);}
#tgt .tb{width:130px;height:8px;background:#200;border:1px solid #533;border-radius:3px;overflow:hidden;}
#tgt .tf{height:100%;background:linear-gradient(90deg,#e33,#f66);transition:width .2s;box-shadow:0 0 4px rgba(255,60,60,.4);}
#mm-wrap{display:none;position:fixed;top:56px;right:270px;z-index:50;}
#mm{border:2px solid #c9a959;border-radius:4px;box-shadow:0 2px 12px rgba(0,0,0,.6);display:block;}
#mm-zoom{position:absolute;top:4px;left:4px;display:flex;flex-direction:column;gap:2px;z-index:51;}
#mm-zoom button{width:20px;height:20px;background:rgba(0,0,0,.75);border:1px solid #c9a959;border-radius:3px;color:#f0c040;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:inherit;padding:0;line-height:1;}
#mm-zoom button:hover{background:rgba(60,40,0,.9);border-color:#f0c040;}
#floor-ind{position:fixed;top:56px;left:140px;background:rgba(0,0,0,.9);border:2px solid #c9a959;border-radius:6px;padding:6px 14px;font-size:9px;color:#f0c040;z-index:50;text-shadow:0 0 6px rgba(240,192,64,.5);display:flex;align-items:center;gap:6px;}
#floor-ind .fi-icon{font-size:14px;}
#floor-ind .fi-name{font-size:7px;color:#aaa;margin-top:2px;}
#floor-ind.f0{border-color:#4a4;} #floor-ind.f0 .fi-icon{color:#4f4;}
#floor-ind.f1{border-color:#a86;} #floor-ind.f1 .fi-icon{color:#da6;}
#floor-ind.f2{border-color:#a33;} #floor-ind.f2 .fi-icon{color:#f44;}
#floor-ind.f3{border-color:#a60;} #floor-ind.f3 .fi-icon{color:#f80;}
#floor-ind.f4{border-color:#84a;} #floor-ind.f4 .fi-icon{color:#c4f;}
#floor-ind.f5{border-color:#a22;} #floor-ind.f5 .fi-icon{color:#f00;}
#floor-ind.f6{border-color:#84a;} #floor-ind.f6 .fi-icon{color:#a4f;}
#floor-ind.f7{border-color:#a4a;} #floor-ind.f7 .fi-icon{color:#c4f;}
#floor-ind.f8{border-color:#a40;} #floor-ind.f8 .fi-icon{color:#f40;}
#floor-ind.f9{border-color:#a00;} #floor-ind.f9 .fi-icon{color:#f00;}
#floor-trans{position:fixed;inset:0;z-index:300;pointer-events:none;display:flex;flex-direction:column;justify-content:center;align-items:center;opacity:0;transition:opacity .3s;}
#floor-trans.active{opacity:1;pointer-events:all;}
#floor-trans .ft-bg{position:absolute;inset:0;}
#floor-trans .ft-text{position:relative;z-index:1;font-size:14px;color:#f0c040;text-shadow:0 0 20px rgba(240,192,64,.6);margin-bottom:8px;}
#floor-trans .ft-sub{position:relative;z-index:1;font-size:8px;color:#ccc;}
#skill-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;justify-content:center;align-items:center;}
#skill-p{background:#1a1a2a;border:2px solid #c9a959;border-radius:6px;padding:16px;max-width:300px;width:90%;}
#skill-p h3{font-size:10px;color:#f0c040;margin-bottom:10px;text-align:center;}
.skr{display:flex;justify-content:space-between;padding:4px 0;font-size:7px;border-bottom:1px solid #222;}
.skr .skn{color:#aaa;}.skr .skv{color:#f0c040;}
.save-slot{display:flex;align-items:center;gap:8px;background:linear-gradient(135deg,#16142a,#0e0c1e);border:2px solid #3a3050;border-radius:6px;padding:8px 10px;margin-bottom:6px;cursor:pointer;transition:.2s;}
.save-slot:hover{border-color:#c9a959;box-shadow:0 0 10px rgba(201,169,89,.15);}
.save-slot .sv-icon{font-size:20px;min-width:28px;text-align:center;}
.save-slot .sv-info{flex:1;}.save-slot .sv-name{font-size:8px;color:#f0c040;}.save-slot .sv-detail{font-size:6px;color:#888;margin-top:2px;}
.save-slot .sv-del{background:none;border:1px solid #633;color:#f66;font-family:inherit;font-size:6px;padding:3px 6px;border-radius:3px;cursor:pointer;margin-left:auto;}
.save-slot .sv-del:hover{background:#411;border-color:#f44;}
.save-slot.empty{border-style:dashed;opacity:.5;}.save-slot.empty:hover{opacity:.8;}
#save-ind{position:fixed;top:56px;right:8px;background:rgba(0,0,0,.9);border:1px solid #4f4;border-radius:4px;padding:4px 10px;font-size:7px;color:#4f4;z-index:50;opacity:0;transition:opacity .3s;pointer-events:none;}
#save-ind.show{opacity:1;}
#save-ind.synced{border-color:#4af;color:#4af;}
.sk-row{display:flex;align-items:center;padding:3px 2px;border-bottom:1px solid #2a2a20;font-size:6px;}
.sk-name{color:#c9a959;min-width:48px;}
.sk-lv{color:#f0c040;min-width:16px;text-align:right;font-weight:bold;}
.sk-bar{flex:1;height:5px;background:#1a1a1a;border:1px solid #444;border-radius:2px;margin:0 4px;overflow:hidden;}
.sk-fill{height:100%;background:linear-gradient(90deg,#4a9a4a,#6aba6a);border-radius:1px;transition:width .3s;}
.sk-train{font-size:5px;color:#fa3;margin-left:2px;}
#chain-btns{display:none;margin-top:8px;gap:4px;}
#chain-btns button{background:linear-gradient(135deg,#224,#112);border:1px solid #448;color:#8af;font-family:inherit;font-size:7px;padding:6px 10px;border-radius:4px;cursor:pointer;flex:1;}
#chain-btns button:hover{border-color:#8af;box-shadow:0 0 8px rgba(128,170,255,.2);}
.tab-bar{display:flex;gap:4px;margin-bottom:10px;}
.tab-btn{flex:1;background:#12122a;border:2px solid #333;border-radius:4px 4px 0 0;padding:8px;font-family:inherit;font-size:8px;color:#888;cursor:pointer;text-align:center;}
.tab-btn.active{border-color:#c9a959;color:#f0c040;background:#1a1a3e;}
#tab-new,#tab-load{display:none;}
#tab-new.active,#tab-load.active{display:block;}
#prem-ind{font-size:7px;padding:4px 8px;border-radius:3px;margin-left:4px;}
#prem-ind.active{color:#f0c040;border:1px solid #f0c040;background:rgba(240,192,64,.1);}
#prem-ind.free{color:#666;border:1px solid #444;background:rgba(0,0,0,.2);}
#floor-ind.f10{border-color:#f0c040;} #floor-ind.f10 .fi-icon{color:#f0c040;}
#floor-ind.f11{border-color:#f80;} #floor-ind.f11 .fi-icon{color:#f80;}
#floor-ind.f12{border-color:#f44;} #floor-ind.f12 .fi-icon{color:#f44;}
#floor-ind.f13{border-color:#c4f;} #floor-ind.f13 .fi-icon{color:#c4f;}
#bless-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;justify-content:center;align-items:center;}
#bless-p{background:#1a1a2a;border:2px solid #f0c040;border-radius:6px;padding:16px;max-width:360px;width:90%;max-height:80vh;overflow-y:auto;}
#bless-p h3{font-size:10px;color:#f0c040;margin-bottom:10px;text-align:center;}
.bless-item{display:flex;align-items:center;justify-content:space-between;padding:5px;border:1px solid #333;border-radius:3px;margin-bottom:3px;font-size:7px;}
.bless-item .bn{color:#ccc;flex:1;}.bless-item .bp{color:#f0c040;}.bless-item button{background:#224;border:1px solid #448;color:#8af;font-family:inherit;font-size:6px;padding:3px 8px;border-radius:3px;cursor:pointer;margin-left:4px;}
.bless-item button:hover{border-color:#8af;}
.bless-item.owned{border-color:#4f4;}.bless-item.owned .bn{color:#4f4;}
#prem-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;justify-content:center;align-items:center;}
#prem-p{background:#1a1a2a;border:2px solid #f0c040;border-radius:6px;padding:16px;max-width:380px;width:90%;}
#prem-p h3{font-size:10px;color:#f0c040;margin-bottom:10px;text-align:center;}
.prem-info{font-size:7px;color:#ccc;line-height:2;padding:4px 0;}
.prem-info b{color:#f0c040;}
.prem-buy{display:block;margin:10px auto 0;background:linear-gradient(135deg,#f0c040,#c49a20);color:#111;border:2px solid #e0b030;padding:10px 24px;font-family:inherit;font-size:9px;border-radius:6px;cursor:pointer;box-shadow:0 4px 16px rgba(240,192,64,.3);}
.prem-buy:hover{box-shadow:0 4px 24px rgba(240,192,64,.5);}
#prem-ind{font-size:7px;padding:4px 8px;border-radius:3px;margin-left:4px;}
#prem-ind.active{color:#f0c040;border:1px solid #f0c040;background:rgba(240,192,64,.1);}
#prem-ind.free{color:#666;border:1px solid #444;background:rgba(0,0,0,.2);}
#floor-ind.f10{border-color:#f0c040;} #floor-ind.f10 .fi-icon{color:#f0c040;}
#ctx-menu{display:none;position:fixed;z-index:500;background:linear-gradient(180deg,#1e1a2e,#12101a);border:2px solid #c9a959;border-radius:6px;min-width:140px;box-shadow:0 4px 20px rgba(0,0,0,.8);overflow:hidden;font-family:'Press Start 2P',monospace;}
#ctx-menu .ctx-header{font-size:6px;color:#f0c040;padding:6px 10px 4px;border-bottom:1px solid #333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;background:rgba(240,192,64,.05);}
#ctx-menu .ctx-opt{font-size:7px;color:#ccc;padding:6px 10px;cursor:pointer;display:flex;align-items:center;gap:6px;transition:background .1s,color .1s;}
#ctx-menu .ctx-opt:hover{background:rgba(201,169,89,.15);color:#f0c040;}
#ctx-menu .ctx-opt .ctx-icon{font-size:10px;min-width:14px;text-align:center;}
#ctx-menu .ctx-sep{height:1px;background:#333;margin:2px 0;}
#ctx-menu .ctx-opt.danger{color:#f66;}#ctx-menu .ctx-opt.danger:hover{background:rgba(255,60,60,.15);color:#f44;}
#terms-screen{text-align:center;padding:30px;max-width:600px;overflow-y:auto;max-height:90vh;}
#terms-screen h1{font-size:22px;color:#f0c040;text-shadow:2px 2px #000,0 0 20px rgba(240,192,64,.3);margin-bottom:6px;}
#terms-screen .sub{font-size:8px;color:#888;margin-bottom:16px;}
#terms-screen .terms-box{text-align:left;background:rgba(0,0,0,.4);border:1px solid #333;border-radius:6px;padding:14px;margin:10px 0;max-height:320px;overflow-y:auto;font-size:7px;color:#aaa;line-height:2;}
#terms-screen .terms-box h2{font-size:9px;color:#f0c040;margin:10px 0 6px;}
#terms-screen .terms-box h2:first-child{margin-top:0;}
#terms-screen .terms-box p{margin-bottom:6px;}
#terms-screen .terms-box ul{margin:4px 0 8px 16px;list-style:disc;}
#terms-screen .terms-box li{margin-bottom:3px;}
.chk-agree{display:flex;align-items:center;gap:8px;justify-content:center;margin:12px 0;font-size:7px;color:#ccc;cursor:pointer;}
.chk-agree input{width:16px;height:16px;cursor:pointer;accent-color:#f0c040;}
#btn-agree{background:linear-gradient(135deg,#f0c040,#c49a20);color:#111;border:2px solid #e0b030;padding:12px 36px;font-family:inherit;font-size:11px;border-radius:6px;cursor:pointer;box-shadow:0 4px 16px rgba(240,192,64,.3);transition:.2s;text-shadow:0 1px 0 rgba(255,255,255,.2);}
#btn-agree:hover:not(:disabled){box-shadow:0 4px 24px rgba(240,192,64,.5);transform:translateY(-1px);}
#btn-agree:disabled{opacity:0.3;cursor:default;}
#login-screen{display:none;text-align:center;padding:40px;max-width:500px;}
#login-screen h1{font-size:24px;color:#f0c040;text-shadow:2px 2px #000,0 0 20px rgba(240,192,64,.3);margin-bottom:6px;}
#login-screen .sub{font-size:8px;color:#888;margin-bottom:24px;}
.wallet-btn{display:flex;align-items:center;gap:10px;background:linear-gradient(135deg,#1a1a3e,#0e0e2e);border:2px solid #3a3060;border-radius:8px;padding:14px 20px;margin:8px auto;cursor:pointer;transition:.2s;width:100%;max-width:360px;}
.wallet-btn:hover{border-color:#f0c040;box-shadow:0 0 16px rgba(240,192,64,.15);}
.wallet-btn .wb-icon{font-size:24px;}.wallet-btn .wb-name{font-size:10px;color:#f0c040;}.wallet-btn .wb-desc{font-size:6px;color:#777;margin-top:2px;}
#login-status{font-size:7px;color:#888;margin-top:16px;min-height:20px;}
</style>
</head>
<body>
<div id="terms-screen">
  <h1>MegaRealms</h1>
  <p class="sub">On-Chain MMORPG on MegaETH</p>
  <div class="terms-box">
    <h2>Welcome to MegaRealms Beta</h2>
    <p>This project is currently in <b style="color:#f80;">BETA</b> and under active development. By proceeding, you acknowledge and accept the following terms:</p>
    <h2>Risk Disclosure</h2>
    <ul>
      <li>This is an experimental project in beta phase. Bugs, instabilities and data loss may occur at any time.</li>
      <li>There is no guarantee of continuous operation, stability or preservation of game progress.</li>
      <li>The project may be discontinued, significantly changed or reset (wiped) without prior notice.</li>
      <li>Any blockchain interaction is entirely at your own risk. On-chain transactions are irreversible.</li>
      <li>We are not responsible for financial losses, loss of tokens, NFTs or any digital assets.</li>
    </ul>
    <h2>Disclaimer</h2>
    <ul>
      <li>The game is provided "as is", without warranties of any kind, express or implied.</li>
      <li>The developers shall not be liable for any direct, indirect, incidental or consequential damages arising from use.</li>
      <li>You are solely responsible for the security of your crypto wallet and private keys.</li>
      <li>We do not provide financial advice. No element of the game constitutes an investment offer.</li>
    </ul>
    <h2>Terms of Use</h2>
    <ul>
      <li>The use of hacks, bots, exploits or any tool that alters the game's functionality is prohibited.</li>
      <li>We reserve the right to ban accounts that violate these terms.</li>
      <li>Your game data is stored locally in the browser and linked to your wallet address.</li>
      <li>By connecting your wallet, you confirm that you are the rightful owner of the address.</li>
      <li>These terms may be updated at any time. Continued use implies acceptance.</li>
    </ul>
    <h2>Data Protection</h2>
    <p>We only collect your wallet's public address for character linking. We do not collect personal data, passwords or private keys.</p>
  </div>
  <label class="chk-agree"><input type="checkbox" id="chk-terms"> I have read and agree to the terms above and acknowledge the risks</label>
  <button id="btn-agree" disabled>Continue</button>
</div>
<div id="login-screen">
  <h1>MegaRealms</h1>
  <p class="sub">Connect your wallet to play</p>
  <div class="wallet-btn" id="btn-metamask">
    <span class="wb-icon">ü¶ä</span>
    <div><div class="wb-name">MetaMask</div><div class="wb-desc">Most popular Web3 wallet</div></div>
  </div>
  <div class="wallet-btn" id="btn-rabby">
    <span class="wb-icon">üê∞</span>
    <div><div class="wb-name">Rabby Wallet</div><div class="wb-desc">Secure multi-chain wallet</div></div>
  </div>
  <div class="wallet-btn" id="btn-walletconnect">
    <span class="wb-icon">üîó</span>
    <div><div class="wb-name">Other Wallet</div><div class="wb-desc">Any EVM-compatible wallet</div></div>
  </div>
  <div id="login-status"></div>
  <div style="margin-top:20px;border-top:1px solid #333;padding-top:14px;">
    <div class="wallet-btn" id="btn-skip-wallet" style="border-color:#633;opacity:.7;">
      <span class="wb-icon">üõ†</span>
      <div><div class="wb-name" style="color:#f66;">Skip (Dev Mode)</div><div class="wb-desc">Continue without wallet ‚Äî testing only</div></div>
    </div>
  </div>
</div>
<div id="start-screen" style="display:none;">
  <h1>MegaRealms</h1>
  <p class="sub">On-Chain MMORPG on MegaETH</p>
  <div id="wallet-info" style="font-size:6px;color:#4f4;margin-bottom:12px;"></div>
  <div id="char-list-view">
    <div style="font-size:9px;color:#c9a959;margin-bottom:10px;">Your Characters</div>
    <div id="save-slots" style="max-height:320px;overflow-y:auto;margin-bottom:10px;"></div>
    <button class="btn-go" id="btn-new-char" style="font-size:9px;padding:10px 24px;width:100%;background:linear-gradient(135deg,#224,#112);color:#8af;border:2px solid #448;">+ New Character</button>
  </div>
  <div id="tab-new" style="display:none;">
    <button id="btn-back-list" style="background:none;border:1px solid #555;color:#aaa;font-family:inherit;font-size:7px;padding:4px 12px;border-radius:3px;cursor:pointer;margin-bottom:12px;">&#9664; Back</button>
    <label>Character Name</label>
    <input type="text" id="cn" placeholder="Enter your name..." maxlength="16">
    <label>Vocation</label>
    <div class="vgrid">
      <div class="vc" data-v="knight"><div class="vi">&#9876;</div><div class="vn">Knight</div><div class="vd">High HP, melee combat</div></div>
      <div class="vc" data-v="paladin"><div class="vi">&#127993;</div><div class="vn">Paladin</div><div class="vd">Balanced, ranged attacks</div></div>
      <div class="vc" data-v="mage"><div class="vi">&#9733;</div><div class="vn">Mage</div><div class="vd">High mana, devastating spells &amp; healing</div></div>
    </div>
    <button class="btn-go" id="bgo" disabled>Start Adventure</button>
  </div>
</div>
<div id="save-ind">Saving...</div>
<div id="game-screen">
  <div id="top-bar">
    <div class="bg"><span class="bl">HP</span><div class="bc"><div class="bf hp" id="hpb"></div><div class="bt" id="hpt">0/0</div></div></div>
    <div class="bg"><span class="bl">MP</span><div class="bc"><div class="bf mp" id="mpb"></div><div class="bt" id="mpt">0/0</div></div></div>
    <div class="bg"><span class="bl">XP</span><div class="bc" style="width:80px"><div class="bf xp" id="xpb"></div><div class="bt" id="xpt">0%</div></div></div>
    <div class="sb">Lv <b id="lvt">1</b></div>
    <div class="sb">&#9733; <b id="glt">100</b></div>
    <button id="buy-gold-btn" onclick="msg('$REALM token shop coming soon!','system');" style="background:linear-gradient(135deg,#40c080,#20a060);border:1px solid #30b070;color:#fff;font-family:inherit;font-size:5px;font-weight:bold;padding:3px 7px;border-radius:4px;cursor:pointer;text-shadow:0 1px 2px rgba(0,0,0,0.4);box-shadow:0 1px 4px rgba(64,192,128,0.4);animation:realmGlow 2s ease-in-out infinite;">&#128176; BUY GOLD</button>
    <button id="prem-buy-btn" onclick="openPremPanel()" style="background:linear-gradient(135deg,#f0c040,#d4a020);border:1px solid #e0b030;color:#1a1a10;font-family:inherit;font-size:5px;font-weight:bold;padding:3px 7px;border-radius:4px;cursor:pointer;text-shadow:0 1px 0 rgba(255,255,255,0.3);box-shadow:0 1px 4px rgba(240,192,64,0.4);animation:premGlow 2s ease-in-out infinite;">&#9733; PREMIUM</button>
    <div id="floor-ind" class="f0"><span class="fi-icon">&#9728;</span><div><b id="fl-name">Surface</b><div class="fi-name">Floor 0</div></div></div>
    <button id="wbtn">Connect Wallet</button><span id="prem-ind" class="free">FREE</span>
    <button id="chain-sync" style="display:none;background:#224;border:1px solid #448;color:#8af;font-family:inherit;font-size:6px;padding:5px 8px;border-radius:3px;cursor:pointer;">&#9939; Sync</button>
  </div>
  <div id="mid">
    <canvas id="gc"></canvas>
    <div id="side">
      <div class="pt" data-toggle="eqg">EQUIPMENT <span class="arrow">&#9660;</span></div>
      <div class="eg collapsible" id="eqg"></div>
      <div class="pt" data-toggle="spell-bar">SPELLS <span class="arrow">&#9660;</span></div>
      <div id="spell-bar" class="collapsible"></div>
      <div class="pt" data-toggle="skill-panel">SKILLS <span class="arrow">&#9660;</span></div>
      <div id="skill-panel" class="collapsible" style="padding:4px 6px;"></div>
      <div class="pt" data-toggle="ivg">INVENTORY <span class="arrow">&#9660;</span></div>
      <div class="ig collapsible" id="ivg"></div>
      <div class="pt" data-toggle="quest-panel" style="display:flex;justify-content:space-between;align-items:center;">
        <span>QUESTS <span class="arrow">&#9660;</span></span>
        <span id="quest-avail-btn" onclick="event.stopPropagation();openQuestBoard();" style="font-size:5px;background:#3a2060;color:#c8a0f0;border:1px solid #8060c0;border-radius:3px;padding:1px 5px;cursor:pointer;margin-right:2px;">Available</span>
      </div>
      <div id="quest-panel" class="collapsible"></div>
      <div class="pt" data-toggle="player-panel">PLAYERS <span class="arrow">&#9660;</span></div>
      <div id="player-panel" class="collapsible"></div>
    </div>
  </div>
  <div id="bot">
    <div id="chat-log"></div>
    <div id="chat-input"><input type="text" id="chat-in" placeholder="Type here... (Enter to send)"></div>
  </div>
</div>
<div id="tgt"><div class="tn"></div><div class="tb"><div class="tf"></div></div></div>
<div id="shop-ov"><div id="shop-p"><h3>Shop</h3><div id="sitems"></div><button class="scl" id="scl">Close [ESC]</button></div></div>
<div id="death-ov"><h2>You Died!</h2><p id="death-msg">Lost 10% of XP.</p><button id="bresp">Respawn</button></div>
<div id="skill-ov"><div id="skill-p"><h3>Skills (K)</h3><div id="skill-list"></div><button class="scl" id="skcl">Close</button></div></div>
<div class="hk-cfg" id="hk-ov"><div id="hk-panel"><h3>Configure Hotkeys (H)</h3><div id="hk-list"></div><button class="scl" id="hkcl">Close</button></div></div>
<div id="bless-ov"><div id="bless-p"><h3>Blessings (Premium)</h3><div id="bless-list"></div><button class="scl" id="blcl">Close [ESC]</button></div></div>
<div id="prem-ov"><div id="prem-p"><h3>Premium Account</h3><div id="prem-info"></div></div></div>
<div id="mm-wrap"><div id="mm-zoom"><button id="mm-zin" title="Zoom In">+</button><button id="mm-zout" title="Zoom Out">-</button></div><canvas id="mm" width="300" height="240"></canvas></div>
<div id="ctx-menu"><div class="ctx-header" id="ctx-title"></div><div id="ctx-opts"></div></div>
<div id="floor-trans"><div class="ft-bg"></div><div class="ft-text" id="ft-text"></div><div class="ft-sub" id="ft-sub"></div></div>

<script>
'use strict';
// Anti-exploit: integrity hash
function _hash(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return h;}
function _integrityCheck(){
  if(!G.player)return;
  const p=G.player;
  const expected=_hash(p.name+p.voc+p.lv);
  if(p._ck&&p._ck!==expected){msg('Save integrity error detected! Character may be corrupted.','combat');p.gold=Math.min(p.gold,p.lv*1000);p.xp=0;}
  p._ck=expected;
}
let _lastGold=0,_lastXp=0,_goldRate=0,_xpRate=0;
function _rateCheck(){
  if(!G.player)return;
  const p=G.player;
  const goldDiff=p.gold-_lastGold;
  const xpDiff=p.xp-_lastXp;
  if(goldDiff>5000){_goldRate++;if(_goldRate>10){msg('Anomalous gold gain detected!','combat');p.gold=_lastGold;_goldRate=0;}}else{_goldRate=Math.max(0,_goldRate-1);}
  if(xpDiff>10000){_xpRate++;if(_xpRate>10){msg('Anomalous XP gain detected!','combat');p.xp=_lastXp;_xpRate=0;}}else{_xpRate=Math.max(0,_xpRate-1);}
  _lastGold=p.gold;_lastXp=p.xp;
}
// Anti-tamper: Protect critical functions
const _origIsPrem=null;
Object.defineProperty(window,'_bypassPrem',{get:()=>{msg('Exploit attempt detected!','combat');return false;},set:()=>{}});

// ============ CONFIG ============
const TS=32,VW=25,VH=17,MW=2000,MH=1600,WCOOL=140,ACOOL=1800,FLOORS=34;
const TT={G:0,D:1,W:2,TR:3,WL:4,FL:5,SA:6,CV:7,CW:8,DR:9,TM:10,SW:11,IC:12,LV:13,SU:14,SD:15,MT:16,SWAMP:17,BRIDGE:18,FARM:19};
const WALK=new Set([TT.G,TT.D,TT.FL,TT.SA,TT.CV,TT.DR,TT.TM,TT.IC,TT.SU,TT.SD,TT.SW,TT.SWAMP,TT.BRIDGE,TT.FARM]);

// ============ SPRITE SHEET SYSTEM ============
const spriteCache={};
let SHEET=null;
const SM={
  bat:[0,0],bear:[1,0],brick1:[2,0],brick2:[3,0],bug:[4,0],bush1:[5,0],
  cave1:[6,0],cave2:[7,0],cave_rat:[8,0],cavewall1:[9,0],cavewall2:[10,0],
  cobble1:[11,0],cobble2:[12,0],croc:[13,0],dirt1:[14,0],dirt2:[15,0],
  dirt3:[0,1],flower1:[1,1],grass1:[2,1],grass2:[3,1],grass3:[4,1],
  grass4:[5,1],grass5:[6,1],ice1:[7,1],ice2:[8,1],knight:[9,1],
  lava1:[10,1],lava2:[11,1],lion:[12,1],lizard:[13,1],mountain:[14,1],
  orc:[15,1],pig:[0,2],rabbit:[1,2],rat:[2,2],sand1:[3,2],sand2:[4,2],
  scorpion:[5,2],skeleton:[6,2],snake:[7,2],spider:[8,2],stone1:[9,2],
  stone2:[10,2],swamp:[11,2],temple:[12,2],tree1:[13,2],tree2:[14,2],
  troll:[15,2],wasp:[0,3],water1:[1,3],water2:[2,3],wolf:[3,3],
  wolf2:[4,3],wood1:[5,3],wood2:[6,3],
};
function drawSpr(ctx,name,dx,dy,dw,dh){
  if(!SHEET||!SM[name])return;
  const[c,r]=SM[name];
  ctx.drawImage(SHEET,c*32,r*32,32,32,dx,dy,dw||32,dh||32);
}
function createSprite(w,h,drawFn){const c=document.createElement('canvas');c.width=w;c.height=h;drawFn(c.getContext('2d'),w,h);return c;}
function px(ctx,x,y,w,h,col){ctx.fillStyle=col;ctx.fillRect(x,y,w||1,h||1);}
function sheetSprite(name){return createSprite(32,32,(c)=>{if(SHEET&&SM[name])drawSpr(c,name,0,0);});}
function darken(hex,amt){let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgb(${Math.max(0,r-amt)},${Math.max(0,g-amt)},${Math.max(0,b-amt)})`;}
function lighten(hex,amt){let r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`rgb(${Math.min(255,r+amt)},${Math.min(255,g+amt)},${Math.min(255,b+amt)})`;}

// ============ TILE SPRITES (OLD - Fallback) ============
function buildTileSpritesOLD(){
  const tiles={};
  const c=(n,d)=>createSprite(TS,TS,d);
  tiles[TT.G]=c(TT.G,(ctx)=>{
    px(ctx,0,0,32,32,'#3a7d2f');px(ctx,4,8,4,4,'#4a9d3f');px(ctx,12,6,3,5,'#4a9d3f');px(ctx,18,12,5,3,'#4a9d3f');px(ctx,8,18,6,2,'#4a9d3f');px(ctx,22,20,4,4,'#4a9d3f');px(ctx,2,24,3,4,'#4a9d3f');px(ctx,14,22,4,3,'#4a9d3f');px(ctx,26,8,3,3,'#4a9d3f');
    ctx.fillStyle='#2a6d2f';for(let i=0;i<5;i++){const x=Math.random()*32|0,y=Math.random()*32|0;px(ctx,x,y,1,1,'#2a6d2f');}
  });
  tiles[TT.D]=c(TT.D,(ctx)=>{
    px(ctx,0,0,32,32,'#8b7355');px(ctx,2,4,6,6,'#6b5345');px(ctx,10,3,5,8,'#6b5345');px(ctx,18,5,7,5,'#6b5345');px(ctx,4,14,8,4,'#6b5345');px(ctx,15,12,6,6,'#6b5345');px(ctx,24,16,6,5,'#6b5345');px(ctx,6,24,10,5,'#6b5345');
    ctx.fillStyle='#a68f69';for(let i=0;i<8;i++){px(ctx,Math.random()*32|0,Math.random()*32|0,1,1,'#a68f69');}
  });
  tiles[TT.W]=c(TT.W,(ctx)=>{
    px(ctx,0,0,32,32,'#1e4d9b');px(ctx,6,6,20,20,'#2563d4');px(ctx,8,8,4,4,'#4a95ff');px(ctx,20,10,3,3,'#4a95ff');px(ctx,12,18,5,4,'#4a95ff');px(ctx,24,14,4,5,'#4a95ff');px(ctx,4,20,3,3,'#4a95ff');px(ctx,14,26,6,3,'#4a95ff');ctx.strokeStyle='#0d2649';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(4,14);ctx.lineTo(28,14);ctx.stroke();ctx.beginPath();ctx.moveTo(2,22);ctx.lineTo(30,22);ctx.stroke();
  });
  tiles[TT.TR]=c(TT.TR,(ctx)=>{
    px(ctx,0,0,32,32,'#2d5016');px(ctx,6,2,5,12,'#8b4513');px(ctx,6,14,5,18,'#1a4d0a');px(ctx,2,10,4,20,'#2a8a3a');px(ctx,14,4,4,24,'#4a9a4a');px(ctx,20,8,5,22,'#3a7a3a');ctx.fillStyle='#5aaa5a';ctx.beginPath();ctx.moveTo(8,8);ctx.lineTo(4,14);ctx.lineTo(12,14);ctx.fill();ctx.beginPath();ctx.moveTo(16,6);ctx.lineTo(12,16);ctx.lineTo(20,16);ctx.fill();
  });
  tiles[TT.WL]=c(TT.WL,(ctx)=>{
    px(ctx,0,0,32,32,'#654321');ctx.fillStyle='#444';for(let y=0;y<4;y++){for(let x=0;x<4;x++){if((x+y)%2===0)px(ctx,2+x*8,2+y*8,6,6,'#555');}}ctx.fillStyle='#777';ctx.lineWidth=2;for(let i=0;i<4;i++){ctx.strokeRect(2+i*8,2,6,30);}
  });
  tiles[TT.FL]=c(TT.FL,(ctx)=>{
    px(ctx,0,0,32,32,'#d4af37');px(ctx,0,0,32,2,'#8b6914');px(ctx,0,30,32,2,'#8b6914');px(ctx,0,0,2,32,'#8b6914');px(ctx,30,0,2,32,'#8b6914');ctx.fillStyle='#c9a959';for(let y=4;y<28;y+=8){for(let x=4;x<28;x+=8){px(ctx,x,y,4,4,'#c9a959');}}
  });
  tiles[TT.SA]=c(TT.SA,(ctx)=>{
    px(ctx,0,0,32,32,'#e8c75a');px(ctx,3,4,5,5,'#d4a937');px(ctx,10,8,4,4,'#d4a937');px(ctx,18,6,6,3,'#d4a937');px(ctx,6,16,7,4,'#d4a937');px(ctx,16,14,5,5,'#d4a937');px(ctx,24,10,5,4,'#d4a937');px(ctx,8,24,6,4,'#d4a937');px(ctx,20,20,6,6,'#d4a937');
  });
  tiles[TT.CV]=c(TT.CV,(ctx)=>{
    px(ctx,0,0,32,32,'#4a3c2a');px(ctx,6,8,8,8,'#654321');px(ctx,16,10,8,6,'#654321');px(ctx,8,18,6,8,'#654321');px(ctx,18,20,8,8,'#654321');ctx.strokeStyle='#2a1810';ctx.lineWidth=1;for(let i=0;i<4;i++){ctx.strokeRect(6+i*6,10,5,6);}
  });
  tiles[TT.CW]=c(TT.CW,(ctx)=>{
    px(ctx,0,0,32,32,'#8b7765');ctx.fillStyle='#654321';ctx.beginPath();ctx.moveTo(16,2);ctx.lineTo(28,10);ctx.lineTo(28,22);ctx.lineTo(16,30);ctx.lineTo(4,22);ctx.lineTo(4,10);ctx.fill();ctx.strokeStyle='#4a3c2a';ctx.lineWidth=2;ctx.stroke();ctx.fillStyle='#a68f69';ctx.beginPath();ctx.moveTo(16,8);ctx.lineTo(22,12);ctx.lineTo(22,18);ctx.lineTo(16,22);ctx.lineTo(10,18);ctx.lineTo(10,12);ctx.fill();
  });
  tiles[TT.DR]=c(TT.DR,(ctx)=>{
    px(ctx,0,0,32,32,'#4a4a4a');ctx.fillStyle='#666';ctx.beginPath();ctx.moveTo(16,4);ctx.lineTo(28,12);ctx.lineTo(28,28);ctx.lineTo(4,28);ctx.lineTo(4,12);ctx.fill();ctx.fillStyle='#ffff00';ctx.font='bold 12px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‚Üë',16,16);ctx.strokeStyle='#ffaa00';ctx.lineWidth=2;ctx.strokeRect(8,10,16,14);
  });
  tiles[TT.TM]=c(TT.TM,(ctx)=>{
    px(ctx,0,0,32,32,'#654321');px(ctx,6,4,8,6,'#8b7565');px(ctx,10,10,12,20,'#654321');ctx.fillStyle='#8b5a3c';ctx.beginPath();ctx.moveTo(4,14);ctx.lineTo(16,6);ctx.lineTo(28,14);ctx.fill();ctx.fillStyle='#a87c4d';ctx.beginPath();ctx.moveTo(6,18);ctx.lineTo(16,12);ctx.lineTo(26,18);ctx.fill();
  });
  tiles[TT.SW]=c(TT.SW,(ctx)=>{
    px(ctx,0,0,32,32,'#1e3a22');px(ctx,0,0,32,32,'rgba(100,200,80,0.3)');px(ctx,4,8,6,8,'#2d5a3a');px(ctx,12,4,8,10,'#2d5a3a');px(ctx,20,6,6,12,'#2d5a3a');px(ctx,6,18,8,8,'#2d5a3a');px(ctx,16,16,8,10,'#2d5a3a');px(ctx,24,12,6,14,'#2d5a3a');
    ctx.fillStyle='#4a7a5a';for(let i=0;i<6;i++){const x=Math.random()*28+2|0,y=Math.random()*28+2|0;px(ctx,x,y,1,1,'#4a7a5a');}
  });
  tiles[TT.IC]=c(TT.IC,(ctx)=>{
    px(ctx,0,0,32,32,'#b8e0ff');px(ctx,2,2,12,12,'#d4f0ff');px(ctx,18,4,10,10,'#d4f0ff');px(ctx,4,18,14,12,'#d4f0ff');px(ctx,20,14,8,14,'#d4f0ff');
    ctx.fillStyle='#ffffff';for(let i=0;i<8;i++){const x=Math.random()*32|0,y=Math.random()*32|0;px(ctx,x,y,2,2,'#ffffff');}
    ctx.strokeStyle='#6abaff';ctx.lineWidth=1;for(let i=0;i<3;i++){ctx.strokeRect(4+i*10,6,8,8);}
  });
  tiles[TT.LV]=c(TT.LV,(ctx)=>{
    px(ctx,0,0,32,32,'#4a2020');px(ctx,4,4,8,8,'#ff4444');px(ctx,14,6,10,10,'#ff6666');px(ctx,6,16,10,8,'#ff8844');px(ctx,18,14,8,10,'#ffaa44');
    ctx.fillStyle='#ff4400';ctx.beginPath();ctx.arc(8,8,4,0,Math.PI*2);ctx.fill();ctx.fillStyle='#ffaa00';ctx.beginPath();ctx.arc(20,10,3,0,Math.PI*2);ctx.fill();
  });
  tiles[TT.SU]=c(TT.SU,(ctx)=>{
    px(ctx,0,0,32,32,'#8b7565');ctx.fillStyle='#ffff00';ctx.font='bold 14px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‚Üë',16,16);ctx.strokeStyle='#ffaa00';ctx.lineWidth=3;ctx.strokeRect(6,10,20,14);
    ctx.fillStyle='#ffff99';ctx.font='bold 6px Arial';ctx.fillText('UP',16,6);
  });
  tiles[TT.SD]=c(TT.SD,(ctx)=>{
    px(ctx,0,0,32,32,'#8b7565');ctx.fillStyle='#ff6666';ctx.font='bold 14px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‚Üì',16,16);ctx.strokeStyle='#ff4444';ctx.lineWidth=3;ctx.strokeRect(6,10,20,14);
    ctx.fillStyle='#ff9999';ctx.font='bold 6px Arial';ctx.fillText('DN',16,26);
  });
  tiles[TT.MT]=c(TT.MT,(ctx)=>{
    px(ctx,0,0,32,32,'#696969');ctx.fillStyle='#8b8b8b';ctx.beginPath();ctx.moveTo(16,2);ctx.lineTo(28,16);ctx.lineTo(20,24);ctx.lineTo(12,24);ctx.lineTo(4,16);ctx.fill();ctx.fillStyle='#aaaaaa';ctx.beginPath();ctx.moveTo(16,6);ctx.lineTo(24,14);ctx.lineTo(18,20);ctx.lineTo(14,20);ctx.lineTo(8,14);ctx.fill();
  });
  tiles[TT.BRIDGE]=c(TT.BRIDGE,(ctx)=>{
    px(ctx,0,0,32,32,'#654321');px(ctx,4,6,6,20,'#8b6914');px(ctx,12,6,6,20,'#8b6914');px(ctx,20,6,6,20,'#8b6914');px(ctx,28,6,3,20,'#8b6914');ctx.fillStyle='#a68f69';ctx.lineWidth=1;ctx.strokeStyle='#4a3c2a';for(let y=8;y<28;y+=4){ctx.beginPath();ctx.moveTo(2,y);ctx.lineTo(30,y);ctx.stroke();}
  });
  tiles[TT.FARM]=c(TT.FARM,(ctx)=>{
    px(ctx,0,0,32,32,'#8b6f47');px(ctx,2,2,28,28,'#a0826d');for(let y=0;y<4;y++){for(let x=0;x<4;x++){const sx=4+x*7,sy=4+y*7;px(ctx,sx,sy,5,5,'#8b6f47');ctx.fillStyle='#4a9a3a';ctx.beginPath();ctx.arc(sx+2,sy+1,1.5,0,Math.PI*2);ctx.fill();ctx.fillStyle='#5aaa4a';ctx.beginPath();ctx.arc(sx+4,sy+3,1,0,Math.PI*2);ctx.fill();}}
  });
  return tiles;
}

// ============ TILE SPRITES (Spritesheet) ============
function buildTileSprites(){
  const old=buildTileSpritesOLD();const sheetOK=SHEET&&SHEET.naturalWidth>0;
  spriteCache.grass=(sheetOK&&SM.grass1)?sheetSprite('grass1'):old[TT.G];
  spriteCache.grass2=(sheetOK&&SM.grass2)?sheetSprite('grass2'):old[TT.G];
  spriteCache.grass3=(sheetOK&&SM.grass3)?sheetSprite('grass3'):old[TT.G];
  spriteCache.dirt=(sheetOK&&SM.dirt1)?sheetSprite('dirt1'):old[TT.D];
  spriteCache.water=(sheetOK&&SM.water1)?sheetSprite('water1'):old[TT.W];
  spriteCache.tree=(sheetOK&&SM.tree1)?createSprite(32,32,(ctx)=>{ctx.drawImage(old[TT.G],0,0);drawSpr(ctx,'tree1',0,0);}):old[TT.TR];
  spriteCache.wall=(sheetOK&&SM.brick1)?sheetSprite('brick1'):old[TT.WL];
  spriteCache.floor=old[TT.FL];
  spriteCache.sand=(sheetOK&&SM.sand1)?sheetSprite('sand1'):old[TT.SA];
  spriteCache.cave=old[TT.CV];
  spriteCache.cavewall=old[TT.CW];
  spriteCache.door=old[TT.DR];
  spriteCache.temple=old[TT.TM];
  spriteCache.swamp=old[TT.SW];
  spriteCache.ice=old[TT.IC];
  spriteCache.lava=old[TT.LV];
  spriteCache.stairsup=old[TT.SU];
  spriteCache.stairsdown=old[TT.SD];
  spriteCache.mountain=old[TT.MT];
  spriteCache.bridge=old[TT.BRIDGE];
  spriteCache.farm=old[TT.FARM];
}

// ============ CHARACTER DRAWING ============
function drawTibiaChar(ctx,x,y,outfit,dir,isPlayer){
  ctx.save();ctx.translate(x,y);
  const sk='#e8c4a0',bc=outfit?outfit.body:'#888',lc=outfit?outfit.legs:'#555',bt=outfit?outfit.boots:'#333',hc=outfit?outfit.head:'#654321';
  px(ctx,10,2,12,8,sk);px(ctx,12,0,8,4,hc);px(ctx,10,10,12,8,bc);px(ctx,8,10,2,8,bc);px(ctx,22,10,2,8,bc);
  px(ctx,10,18,5,8,lc);px(ctx,17,18,5,8,lc);px(ctx,10,26,5,4,bt);px(ctx,17,26,5,4,bt);
  ctx.fillStyle='#000';ctx.beginPath();ctx.arc(13,6,1.2,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(19,6,1.2,0,Math.PI*2);ctx.fill();
  if(isPlayer){ctx.strokeStyle='#ff0';ctx.lineWidth=1;ctx.strokeRect(0,0,32,32);}
  ctx.restore();
}

// ============ MONSTER SPRITES ============
const MON_SPRITE_MAP={bug:'bug',rat:'rat',cave_rat:'cave_rat',snake:'snake',poison_spider:'spider',scorpion:'scorpion',wolf:'wolf',bear:'bear',deer:'pig',boar:'pig',troll:'troll',rotworm:'snake',skeleton:'skeleton',mummy:'skeleton',orc:'orc',orc_warrior:'orc',minotaur:'bear',giant_spider:'spider',cyclops:'troll',demon_skeleton:'skeleton',wyrm:'dragon',serpent_spawn:'snake',hydra:'dragon',dragon:'dragon',dragon_lord:'dragon',lich:'skeleton',warlock:'skeleton',demon:'troll',juggernaut:'bear',hellhound:'wolf',undead_dragon:'dragon'};

function drawMonster(ctx,x,y,type,hp,maxhp){
  ctx.save();ctx.translate(x,y);
  const draw=(name,fn)=>{if(SHEET&&SM[name])drawSpr(ctx,name,0,0,32,32);else fn&&fn();};
  switch(type){
    case 'bug':{if(!window._bugI){window._bugI=new Image();window._bugI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAw0lEQVR4nGNgGAWjYBSQCALc5P6TI0dzR5BrOSOpGoxS8Ft0bs4jksxkItUBUEuIEiMGEO1amwqN/wwMDAzf3nzDq45LhIuBgYGB4UjHDaLMJisEqAnwuhI5Yb0x4oL7DgYeHXnOwMDAwCBnI4ki/u3NNwaRc4iQ2rALd7oY8BBgwSeJ7HIbIw2Sshk+XyODwRsC6AXLGxINRtePK0QGbwigu3jkpQEGBrRygESDkfUO6nKA5LqAWDBk6oJRMApGwSgAAGLXQSVORNg2AAAAAElFTkSuQmCC';}if(window._bugI.complete)ctx.drawImage(window._bugI,0,0,32,32);else{px(ctx,10,10,12,14,'#3c7828');}}break;
    case 'rat':{if(!window._ratI){window._ratI=new Image();window._ratI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAA60lEQVR4nGNgGAWjYBQMMGCklcF3Vq3/D2OrhAUyovNhbCZaOYBYMOAOYCFW4aqlC/4TVsXAwMrKiiG2ftVSnHqJdgCp4DLDN6z8wLBolHRHMBEumD3tPwMDAwMXFxdRFqOHQGpWPgMDAwPD7GkTGRgYGBgkJSXhcha2Tow0CwEYgFmMbCkyH+4AXNkEBr59+4YuhBXw8/Pjlf/fNO0/Y13WwGVDZMsZGLCkAeSQQAZHPj4nygJCIUD3NIAO0NMA0bmAXJCQmoXXjgEvCUcdQHR13NPehJIWSirrGEmRxwUGPARGHTAKRsEoAADS9TvmlTy2lgAAAABJRU5ErkJggg==';}if(window._ratI.complete)ctx.drawImage(window._ratI,0,0,32,32);else{px(ctx,8,12,16,10,'#a09a96');}}break;
    case 'cave_rat':{if(!window._crI){window._crI=new Image();window._crI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAA60lEQVR4nGNgGAWjYBQMMGCklcFNUfH/Yey6ZQsZ0fkwNhOtHEAsGHAHsBCrMCU+6j9hVQwMv3//xhCLjwrFqZdoB5AK7jJ8w8pfuGw1SrojmAijQgP+MzAwMHBxcRFlMXoILLhxl4GBgYEhQUOZgYGBgYGfnx8uN2n6HEaahQAMwCxGthSZD3cArmwCA9++fUMXwgpYWVnxym8JiPrvs2HZwGVDZMsZGLCkAeSQQAY3fn8kygJCIUD3NIAO0NMA0bmAXLBs9Qa8dgx4STjqAKKrYzdHG5S0sGv/EUZS5HGBAQ+BUQeMglEwCgBMGEKqJBHq1AAAAABJRU5ErkJggg==';}if(window._crI.complete)ctx.drawImage(window._crI,0,0,32,32);else{px(ctx,8,12,16,10,'#5a5550');}}break;
    case 'snake':{if(!window._snkI){window._snkI=new Image();window._snkI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABCklEQVR4nGNgGAWjYBSMdMBILYPcFhj9xya+K+EcXjuYqOUAJAtRaEKA6g5wW2CEQjMwMDDc0dDAGjo0cQA6uKOh8V/lxg2c0UBzB6jcuME4oCEAcwQuORZSDXOcrYvTN+QAkh2AC/z+/RuFvz/1MlFZnOQo+Pj8I0l8qjuAX5KfJD4hQHRJaDMNkpJZWVkZzHV18ao9efkyPEqOZOFOgAwMdMoF+ADRifDbm28MXCJcDL9//2Y4cu4cnI8uTyogOgTQDSfEJxYQDAHzHuX/DAwMDL+//WZwtDEnyfD9R04SVDPgaQCvA2C+pyXAGQVGTXIYlhMTpKQCvHkUOQROltylWutpFIyCQQUAxeZQu6wuw4cAAAAASUVORK5CYII=';}if(window._snkI.complete)ctx.drawImage(window._snkI,0,0,32,32);else{px(ctx,6,8,20,20,'#40963c');}}break;
    case 'poison_spider':{if(!window._pspI){window._pspI=new Image();window._pspI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABKElEQVR4nO2VrXKDQBSFD51g0H2ImJia9glqiIjBoDExNTUYVA2mpqIqOgYTw0PExMTkIdBrVhDT7fBzL3uhZTKT2c8szC57zz17mAUcDofDcWM88xClz3VzosiPXn+5jDF7LaYW2bw/1fZVdkhlzQ449UZAWirkYfA7AsDh8yR2VuRA+LYiu02KCnn0CADIwwBJUWH38y7Fo1Q2lXLFfd9nN6XmOCdZB16TZe0HfJH/wpoBpRT54ZADzQx09wPabjzIdAJZrFujIY2+W+NY2P+TOvss1vjY9zvfxrpcv1zWkwVQIexab4pTIsqv86DlAB9C8RGYopQDf2FyCA3d7m37ARNDSKGVti+yILpwqEBKOh8lYExwbMwSwrlgO5TciFJmC6HjLrgCLMR+WsDWiiwAAAAASUVORK5CYII=';}if(window._pspI.complete)ctx.drawImage(window._pspI,0,0,32,32);else{px(ctx,1,11,28,18,'#506e32');}}break;
    case 'scorpion':{if(!window._scpI){window._scpI=new Image();window._scpI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABCElEQVR4nGNgGAWjYBSMggEGjOgCPQHK/2Hskg13MeTJAfjMZCFWIykOQteHD2A4AGYJKYYQA3A5HsMBJFj8f1qUBgMDAwND1rIbDAxYohObuegOITsNTIvSQHFo1rIbONXiM5OsRLal2Pz/o+cfUcTkJPkZfHpPkmwe3kSID8hJ8pOrFQUwkaphaYouzjSCT45qDqA2ICrOmrzl4D5TJhD0d5HSRt3WRwTNHxohgAwIxXP0nMskmTngIUAwG/43MvrfLPmGgYGBuDhlYEBNM4T0EAyBZsk3DLXPRYixlyxAlI9Iyd/DLw0QC0j1OQwQFQLRcy4zkmsBIUBxCFDqMJLSAC1DYuQCABMAXKPoe1YCAAAAAElFTkSuQmCC';}if(window._scpI.complete)ctx.drawImage(window._scpI,0,0,32,32);else{px(ctx,12,14,8,12,'#a5642d');}}break;
    case 'wolf':{if(!window._wlfI){window._wlfI=new Image();window._wlfI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABJElEQVR4nO2WoRKCQBCGfx3vDSgWi8WH8A0sRsdMoVAoFJOFYqFQLBbGaPENfAiLhWIhUwhY5Gbv5m44R84z8KVlObiff9mdAwYcM7LxUt8PmjY+HrORLgcAYxsCAGC9mBvlrAm43B9Gud5LEMe7pixLfu15HgCA5mgJJn0LoJuqckmyFz7aWgkAYL28KuOfCbjcVsqYMgGAMIx4i6TpQbAoiuJGfugbZtNpUzyf9ttQB90ceHcBdaCua36TMQbG2Ecb6NYXRcHjPD9xEYKaIAgFu/sU0CJ3QWcbUkdMkNfL/5SMICDLUr6YlsUmP/8J/06A8SjebtSDRCY/qyeeDucODAI6zwP0KAWoj1gmeR3OHRgEOBfQOYiqquolr8O5AwPOeQHiWF6fVRlszwAAAABJRU5ErkJggg==';}if(window._wlfI.complete)ctx.drawImage(window._wlfI,0,0,32,32);else{px(ctx,1,3,28,26,'#6e6e73');}}break;
    case 'bear':{if(!window._brI){window._brI=new Image();window._brI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAA9klEQVR4nGNgGGDASC2DKgKM/iPzOzacYyRGnolaDmBgYGCwMTIiWZ5mISAiwo8i/+bNRxQ+TUKAHEA1B4iI8MPxhnOPUOTm7LoMl+vYcI4ROX3QJARS3HTx8pEBCy0cwMDAwDBp62U4O8+bAge0x9v8J6SGEkCzEMjz1mW4ceM5g4aGJHkOaIoyp9jnhCxnYBgE2ZBgFPz+/Zsogwipq1t2EmuhN+AhMOoAkrOhTUAoXvkjG1aTZN6Ah8CoA0YdQHIuIDWVEwIDHgIEG6XojU0GBkSDklw5ZDDgITDqAIK54M3Hb1SXQwZEhUBK00QUmhpyowAGAKpXUZT4kiLbAAAAAElFTkSuQmCC';}if(window._brI.complete)ctx.drawImage(window._brI,0,0,32,32);else{px(ctx,6,1,24,29,'#825a37');}}break;
    case 'deer':{if(!window._drI){window._drI=new Image();window._drI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAA1ElEQVR4nGNgGAXDDaS4afxHZ2MTo5sjiBGniyNwWc5EC8u39KT8D3CzQRELcLNh2NKTguEImjiAFMBCbQNXNUX9x8ammwMYGBgYvn37RpQYAwMdoqBk0ga88jR3QE9eAF55oqOAmPgkBDrm7MIQo2suqEhxwxDDGwJ3Lu2D+/rchjk0cNJQKgdwZSNCIKFjAyPZDlDRc2JcUBFA0wpkwKNgwB1AdBqwicojyeAjyyYRpW7AQ2DUAXjzKDLoSXGEZ8eSOfsZSRHDBwY8BEYdMOqAUQAA4fJE/wKG/hIAAAAASUVORK5CYII=';}if(window._drI.complete)ctx.drawImage(window._drI,0,0,32,32);else{px(ctx,8,14,16,10,'#a07850');}}break;
    case 'boar':{if(!window._boaI){window._boaI=new Image();window._boaI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABCklEQVR4nGNgGAWjYBSMdMBIawu8zdX+w9hbT97CsI+J1g4gBEgOATcj5f+EVTEw8HOxMjAwMDB8+/0PLsbFivDv6iM3GBkYGBhYSHUAqQDZUmyAoAMyA2xQfHz30XOSHVH8jYuhl+sbVjmCUYDuAGLBmzdvcMrNXr+FQUBUhRGrA5DjWFKEn4GLi4sc+3E6QFdZDs6uW7iLccBzAUYa2HXuLiMDAwNDvJvRfwYGBoZv37DHHbXA4AsBWoPLdx8xMDAgyoEBCYHZ67fA2TQLAfTcs3DXOXiOWy2qAhcf8DQw6gCiakPkOp2BAbVexyWHTw8yGPAQGHUAUeXA848/SJbDpwcZDHgIjAIA2VVGcS2HH/AAAAAASUVORK5CYII=';}if(window._boaI.complete)ctx.drawImage(window._boaI,0,0,32,32);else{px(ctx,6,14,20,10,'#5f4632');}}break;
    case 'troll':{if(!window._trlI){window._trlI=new Image();window._trlI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABC0lEQVR4nO1VLReCQBAcfCaKxV9CoVgs5iuWyyaDiUAymAwkg8lgoljIZIuFf2AxWyhbMeEDOeDWj3fBmwR7e8Mwb24PsPh3OJxmEYlCpy8JEm3eAUfAL6ClVO5lAQBEhCRInnURiedztS73EgAQL+NefpYD1Y9U31/rHAzf3slAtJgosxMczs5HAuRRfrIdwBunoLTbk15tLYuzVt6vOlAG75bdlHWAlwltB2abWeG6rlYvESFdpzXucO7VXNieMgdghpCIOO1aUAqYhlOtideFBsc1V/YZn4TsEI7Go871/K7+0zYYd8AKsALYp4Cb8j4Yd4B1G/orvzEhL7uL01bX4TTugBVgBVg8AAptTzyReiEFAAAAAElFTkSuQmCC';}if(window._trlI.complete)ctx.drawImage(window._trlI,0,0,32,32);else{px(ctx,10,4,12,26,'#468246');}}break;
    case 'rotworm':{if(!window._rwI){window._rwI=new Image();window._rwI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABBUlEQVR4nGNgGAWjYBSMdMBIawtSooz+o4vNWXYObi8TrR0AAwFLz6HQMEDTEAgN0PjPz8WFIX7jxnOGI+eeMzIw0DEEkAHMcgYGBgYWahocFaqLEt+/f//Gqs7GSPI/zBFUdQAy4AplZfi47DfDx2/fMOSoEgLYUvc3JB9/W43d9+iAOmkggHytROWCvHhzvL7FJ8bAwMCwbPVlnPaQHALfvIkLWmIBhssqUmwo8i1yKUcMwBkCb9wwUy8tAM5cILILswRDBlysrAyTFp6kuCQdkJIQGcB9kLLAZhqyhMgRhkxkfsecIzSpNwZPCCCDlAU2FTD2nIQjHbR0wICHwCgYBaMAAIjTTlSTxvbdAAAAAElFTkSuQmCC';}if(window._rwI.complete)ctx.drawImage(window._rwI,0,0,32,32);else{px(ctx,4,10,26,16,'#786440');}}break;
    case 'skeleton':{if(!window._sklI){window._sklI=new Image();window._sklI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABG0lEQVR4nO1WrxOCMBT+8ExkLBSLhUKhUFYsZovFv9RioaxQKCsWi0XyKwuY9BiOueeJeCffHQdsb9/79n4MgH9HwF1wvZwa1/wiXrE4Zxzjy1k5nfvatDHnGAOA1pq75LMCACDPxONZlsXTGAesFAyB0QWwKrZbYGuxAQAci4NhFy8Tb963BNR1bZ2Poogt4K0U7LZ76/3rUJVsVCVZfd+FM1RVWRjkYRh6kRKR8Z5motfPb3ZBe+dd9SdVOkO+SjLD3sUF/EAEWAJUJRutNVwXtyhHjwDrY5SkuZHD+26744MJaDvtG+OKsaaAiEBEzv71RZqJ4M5nA9uBra1etZoLoxfhJGASMLoAVsvI4uB1zudiM+wv2YRP4gb/sYAfTDG3hgAAAABJRU5ErkJggg==';}if(window._sklI.complete)ctx.drawImage(window._sklI,0,0,32,32);else{px(ctx,11,3,10,27,'#e6e1d9');}}break;
    case 'mummy':{if(!window._mumI){window._mumI=new Image();window._mumI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABDUlEQVR4nGNgGOmAkVQNd86u/49PXsU4kCQzmUhRfOnwUryWE6sGGbCQovjjx48MHz9+JEULdcGlw0v/Xzq89L+GsuT/LQts/msoS/7HJkaKmSRFATIoab5LlBghQFKCObxlGlG+s/XJItpcktIAPz8/KcqJAmRHwagDqAWITiwnds4mKXtZuKcSZTZORaRaSAjgchDRuYDUEpDYHIPTAegW0iIL4nUAIQvnTJ+Owk/JzCTLAQOeC8hOA6FRUXjlKU4D6IDUNEBsoiWpLiAFEOvgwZcGkJtU3759g4vTvRxgYEAtvWheFCP7XM82GqvmfesnojjCKTCfEZ84MWDwpAFcvqY1GPAQGHXAKAAAdKJlwPgdKBQAAAAASUVORK5CYII=';}if(window._mumI.complete)ctx.drawImage(window._mumI,0,0,32,32);else{px(ctx,10,3,12,27,'#d2c3a5');}}break;
    case 'orc':{if(!window._orcI){window._orcI=new Image();window._orcI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABG0lEQVR4nGNgGAUjHTCSqiGgyeY/PvkNdUdIMpNoxVE9bv8ZGBgYvn37hlcdFxcXAwMDA8Oykl1Emc1ErANoBch2wPqob3j5NHdA4DIuvHxiAV0SYU/PRAw9JSX5jAwMFITAgswFDG8efWR48+gjw4LMBeQaQ74DfCoDsbJJBSzEKkwJMIIE4zlIYhNhYEVV8OYbiro5G84RFb04FaHHtci5bwxvjIhLaOhqRU5+ZGBgYGCYs/Uyhn1DtxwYdcCoA6gFiC4HHj3/yMCw9SNxahkYGLgYiMuyRNcFbubKeOsAdLDr5F242SneupDCCUs5QFJl5FZshOKIXb2Q0g6XODFgwNPAqANGHUB0ag1w1CApG27Yf2NoNMtHAQCzUFMoNypFZQAAAABJRU5ErkJggg==';}if(window._orcI.complete)ctx.drawImage(window._orcI,0,0,32,32);else{px(ctx,10,4,12,26,'#50823c');}}break;
    case 'orc_warrior':{if(!window._owI){window._owI=new Image();window._owI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABaElEQVR4nO1VoVaEQBS96zFNsZD3D7aQDCQDBcJu5Q8oFstukDCG3YDFYiVRNbBlgxaCFItli4U8hULF4JF1OMMyM3hEz+EW4HG5c3lv5j3gP4PSdUXpuuqjcfJTZnQxUSEvl9fc3xJCAABlWXK8zeZGWvdUxUATzYV1IF0CL7Sr3Mg6ebmRwQtt6X3RKwOyeEksztC5m9YlUjawJ88AgAevxCImdfzrmYC0fSqE9in4vrjoWRZKpwAA5tQ6Wt/HIBVqJslTBQCue8G9185A5EdgeQGWF4j8SFdG34C7WgjvVSG1CYXtdirmmtSpuUGw6iyx0ECz4+lCRqc2EJrmgbzbAgCY7XBkxpjUwoZhyDnEHxhGXAksejjLadC/z8tg8AwMboArwW+lvdVAG/ZZLIxf+mcAgLv7gouz98/rdDbv1JaaBZ4z0+oL8fat1m+bBUrDyL4yOSO729fJsbgMBt+Eo4HRwIgRH16nZ3KrMIlsAAAAAElFTkSuQmCC';}if(window._owI.complete)ctx.drawImage(window._owI,0,0,32,32);else{px(ctx,9,3,14,27,'#50823c');}}break;
    case 'minotaur':{if(!window._minI){window._minI=new Image();window._minI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABOUlEQVR4nGNgGOzgzqUt/+9c2vKfVvpYSDGQgYGBQUXPh5EYdcQCgg5Q0fNhRDY0z9uIaAsIOZaBgYGBiVjDaAXIcsDEj1xEiREDCAYRMiA2+CdtPYfV3AULVmHoJzoRIgMRfn6s4m8+fiTZrKGZBhgYGBh2nbuLlU03B7gZKWNlkwoIJsKKUBuSS0Fk0LH6CNyOFG/d/wwMDAxztl6Gi2E4oDjAHMVCVlZWSuxn+P37N5z98fc3BnQHEJ0LuLhIy+ffvn0jSt3QzQXDxgFEpwFi45RUMOAhMOoAotPAjedvSDJYQ1KEPAf0bjiJUjpSWhQjmwcrivE6AB3AyvIAGw2SHIJcB+ADREeBJBdmnTB9F6RMz3TD9Bk2gFwHwMCAJ8JRBwy4A4hOhCcf4W7x4pMjBAY8BAYcAAD29WK2t60UFwAAAABJRU5ErkJggg==';}if(window._minI.complete)ctx.drawImage(window._minI,0,0,32,32);else{px(ctx,8,1,18,29,'#6e4b32');}}break;
    case 'giant_spider':{if(!window._gspI){window._gspI=new Image();window._gspI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABF0lEQVR4nO2VKxKDMBCGNx0wmN4Ag6mJSUWvg8H0QDWYXqcCDAaTQ8RgENTQTkh2k7RhappPwWayj383CUAikUj8OwwA4CLEYi48+p7FOA71eYgJsgdolWb2WOaCc6tCnX4YNnson9EKdHmOfofCfL06VZW1PkrJBOdLpxScj8dtQqstR5L5eAaw4LrdDE7ZXFgZmYoopdCNRVE4Hf9sBmLJTANVcSzUvWINoZnAfZ43//U6XHoLbm0LAADXpnnbzCGkErAUCGWaJsum9x07XRjkoOhKvFSoiXM+Sum8tl1HPUgBKvAeWJlXZblglwiFr3ofGQAuUchpmI0B1Yl+DV3OQ9ZD8b6GmBLfyE7dhN4hjO1xIuHjCUkAgLi+XVosAAAAAElFTkSuQmCC';}if(window._gspI.complete)ctx.drawImage(window._gspI,0,0,32,32);else{px(ctx,4,10,24,18,'#282320');}}break;
    case 'cyclops':{if(!window._cycI){window._cycI=new Image();window._cycI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRUlEQVR4nO1WLXODQBB91ymaf5B/UFMTc6YeEdOK6NSgEUU0ohVBxNTEFI1oDQIfc+ZMTP8B/wCDQbRqmdAy3AdhEL03c8Ps7bHvsXu3HPDfwXQWvR/23zbBH8NIGf9aN1hVVUbkvu9rrbsyijoBtDNw/kX3aw4AEOKhneP8AwDwmQkjAcYZ+E0eBGXHJv9kAs5B5PS0gXYJ+lAUCwRBiaJYaK1/2dz9OU3GGaAaU82J3HYPjMoAkY6BcQakEIjCBHXlIwqTdpA9uQDCNo4H7d530iOr6xo0tumRGZdgyc2OmQptrz687To7tGmaixJ5ngcAKGXeziWZZLO3YifACXAClI3oS+SjCG74atA/ewaUt9bN6tbqRkxI81OH42m9bOMlmVT/C9L8xPa7514RUfzKAEDlH8Ko+4ANkkx2RM2+B5wAhx9/AmVsXp247QAAAABJRU5ErkJggg==';}if(window._cycI.complete)ctx.drawImage(window._cycI,0,0,32,32);else{px(ctx,6,2,24,28,'#9b968c');}}break;
    case 'demon_skeleton':{if(!window._dsI){window._dsI=new Image();window._dsI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABNklEQVR4nGNgGArg/zS5aQs0NP4v0ND4T0gtsrr/0+SmEVLPSNDyFLktjHMe+cAMNWqqwKv+XF0HAwMDA0O8zbetjHMe+RAyn4mgC4kwhBJ9LKQa/O3bN9JdgwcQjAJkcGLBNEgagAYzAwMDAwMsSpDELB49ItpcglGAC5i7iRAlRjMHnNz1higxQoC8KCAALBKyiDaX5ETIwMDA8OYNdp+KiNAxCgYF2Det5/++aT1ERQsugDeudk5sRzGci4uLKEPRywr3/Eqc9gx4FGB1GbLP0V1/ePZEvEFum5qPoh6fWQwMgyAESHLAvmk9/3///s2AD5OaKAc8BEgqiJyySlDiEOZbdHGaOQDZUlxipDqGZJcTimNSHUByCPz+/RvOhmUr9AKLFDDgiXDUAaMOGHAHjIJRAABFLYHysjTdawAAAABJRU5ErkJggg==';}if(window._dsI.complete)ctx.drawImage(window._dsI,0,0,32,32);else{px(ctx,10,1,12,27,'#c8a096');}}break;
    case 'wyrm':{if(!window._wyrI){window._wyrI=new Image();window._wyrI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABX0lEQVR4nO2VLVfDMBiFb3pWUzUx/sEEpiZmZmamM4h6DAIECBQCNYFCoCqGAIHBoCYwq5mpiYnJP8BgZmpqIkCltF2zfpy0mD4qzcnHzb1vGmDgnyFdLey/+Z/Z783F5qxs3KgrAUW8F++n2BdehcSYgOKJy9hehgCA5auX9nXmgLI8e/LsxgqrKwF1MV6Ei/Uil7Vt26XjPvw1xidTczVQRfwd576Xz+cAeohASgkpZa5ve/2etntzwJk4AIDdzY6MV1MzAuZP84O73RRjEST7pNU8YxEoi+OvOG1Hd1HlLTNehGrzutRyYPYw02ZNT6l2XoSocu3GDrTNWkfjGlAWJ/sEzsQB4wxsxVr/UVvXQNOsdeQcoPdUn7Wrz5qBtRZQ6oDpnI9BAMC9ddOT287f66VyVvBHbvz1tLKbFzGV8zFGIhAkK4LS8qw5550IsABABIKIQJCs/QMDA33xC3v7WPryEcc/AAAAAElFTkSuQmCC';}if(window._wyrI.complete)ctx.drawImage(window._wyrI,0,0,32,32);else{px(ctx,1,4,30,24,'#3c8c3c');}}break;
    case 'serpent_spawn':{if(!window._sspI){window._sspI=new Image();window._sspI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABKElEQVR4nGNgGAWjYIABI7UNrHCc9h+ffMf+LBQ7majtAFIBTR3Qvj8Thaa7Ayodp6PQdHcAMYCFUgOKbSbiTXSEAM1DoGKVG0PFKjec8hSHAAxIikgyPH/znOH3798MDAwMDM8/PmdgYGBgEBBVwZvVqRYCz988J0sfyQVRnnkPSpyzsrJid9BHTActu9yBYd/QzQVyknIMj54/gsc5DEw6WYLiyyjdCry5hGwHPHr+iCh12IKdKAekGDVRlL+JBYMrDWCLLw05DYYbj26giOkaKWM17PK5uyQ7gGAIoFtObUByIvz2+xvDyZOXGeacq6NKY2ZwpAFcedXISAOrpnPnqBctgyMEkAGsZPv4+yPD/iMnGVbf6KV6wxUZoIQAerE6CkYBPQAASL1WZG6nMdIAAAAASUVORK5CYII=';}if(window._sspI.complete)ctx.drawImage(window._sspI,0,0,32,32);else{px(ctx,3,5,24,24,'#6e3c8c');}}break;
    case 'hydra':{if(!window._hydI){window._hydI=new Image();window._hydI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABG0lEQVR4nGNgGOmAkRxNocXt/7GJr+6tJNk8JnIcAAOreh1RaHIAQRfj8i0pAF/IEB0C6L69e/kyCsanFh8gOwTQLVXW1cVpBr4QYCHkAFyWndu1jDEgrwnuuNW9lYyhxe3/SXEYAwOFiZAagOhsg+zbDZPqGEkRwwcGPARGHTDgDiAqG6ID78xajLIBmxhVHfD792+SxLZObyYqhxFU5JZS8Z+BgYGBlZWVGPMwHLJrTgdeO4ZOGsAW3NQAgy8EbEIzUVLzt48fGbj4+WnmgMETAuYBKf8ZGCBxjS3Fy8nJkWTwo0ePSHMAMjiyejo868CyIa0A3AEnN8whq4VMKRjwNEC0rx2j8lCiYv+ySYykyOMCAx4Cow4YBQB0ZHCiSEPXBQAAAABJRU5ErkJggg==';}if(window._hydI.complete)ctx.drawImage(window._hydI,0,0,32,32);else{px(ctx,2,2,28,28,'#466478');}}break;
    case 'dragon':{if(!window._drgI){window._drgI=new Image();window._drgI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABn0lEQVR4nO2Wr0/DQBTHv4U1SxYSTM0SsiyZqZnB7AQGM8QqQDAxhZhCYPg3hkFMoyqGwAzBBBhEMTOYMyRkIZmZWUKakGM7zDq6u3Ztw46SsI+6d/d673uv3/4A/jua0zCvvIDY9OS3BWyo2LRVyfNWJc+j5gAg4w+chtn1xsSmlgpxIko6kATNG/hPP8MIuoDYlCzb8K5W5M+jDwDAuTOcz1+QPACgbGRxcPs6rxvZAToYV6JyRMpGdqG4J6ZsZKXcQAF0MK4lLRqGpi1fV+4BLvk+RACxqTVzfuC9T0rPKkrx9cu7lJeRZlaIKOK4tJVcgFnYfvLH94elpU1lbLIQu+6nlMOdXUcjfcKbRjtQgFh01WikT3i70NVOB1aER4FutcABIJfTExVxXQYAYGwqrR09vM3rKvWAWCyI2AK8E62a1L8FUgdu9ncWXM7YFLquTuff6EBn7/tHgbEJdH1TSjTPqok2ppe9+AJE/M71HkNVZACg/jiMfB+oInUPxD55R3g6AKDuu1VR62Gk3oG1gNQFxKZpGvwn8ZowvgDOjXrrYUwGdQAAAABJRU5ErkJggg==';}if(window._drgI.complete)ctx.drawImage(window._drgI,0,0,32,32);else{px(ctx,0,2,30,28,'#b4461e');}}break;
    case 'dragon_lord':{if(!window._dlI){window._dlI=new Image();window._dlI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABcklEQVR4nO2XIXODMBTH//RaM42uqalhogYEegqBmpiaqEKsH2KfYBOoiaqJqYiqaQQYxDAzGDQag2AGWAIBQhuO3a6/Oy73klz+L++9vDuA/4z/sSt4I41im+6JniCeY8kUb2LchwptL2WI0eztYyn82rv+Rh4VrgO26fp9AsRzjAt9ZFj0LaZpossU49GKQJomuqqug0sPPjybCL5ealu/PQAAtA27rzcC5xDFIaI4ZMQB1HYUh3X+AWBBPMcqK18tP7kE/cGUHoEWen8ZTeZAlfMuu0J6HxARFXaA9xp07Ynb4brIsrQ156M4GVAsgJMCGU9wCAOK5cJ3AUAZ2rzb7gsAWK1uRonkecaMNFH8XutOWgNNMR7CDvBuIoPp+8AArQhomwemyvM8G53/MfyNCGzXdn3rrhvfmfaogz89Iu5AE7pyq2c4FUsA+E7IYD+YitlrQPjmzdcBsKkaWu9i9ghcHZjdAWF+/3jOs6908QOF63yKio9HnAAAAABJRU5ErkJggg==';}if(window._dlI.complete)ctx.drawImage(window._dlI,0,0,32,32);else{px(ctx,0,1,30,29,'#32286e');}}break;
    case 'lich':{if(!window._licI){window._licI=new Image();window._licI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABWklEQVR4nO1UK1DDQBB91yHmdLHxWExOBIMoNgZE9ZmaKEQRVEQhWlODialBgIlGUFMRDAaBwtSCPhNxiBB66Sd3yQA3nclTt5ndt2/ebpZARSrTnzcjDP8AojbnLrpFGC/xuS4iDCJpQjpNRkSflaOzrTkAcBdd1RHeGxo1r5vb0SUEiIamZE3qD3QECUY3xVsIUVuAWr9bACMsNtgBAHh8SSob9o6DWgJXDnyLUOOqwuXHGwDAPTwqxTi7aigAwDg+8QDgMl5ot7hovBHXdEC7hH8N6wK0f8E66i6ZDvvhQN8PpRDC+A5QStH3Q3m3mGqX2boDJYVj7ksAeH33SklZlgEwv4SUUgCA4zil77P5ZMMR6w60AloBrYCtl3Bwnd8BdnpBgPwSNiGfzSckfbqXKpeRgF3JTaDjsj4C6wK0Vp97g0bzL/DwfLvHIwgQ8d9oUsVjfQQtvgCAkmh51RkOLwAAAABJRU5ErkJggg==';}if(window._licI.complete)ctx.drawImage(window._licI,0,0,32,32);else{px(ctx,3,1,26,29,'#5a3c6e');}}break;
    case 'warlock':{if(!window._warI){window._warI=new Image();window._warI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABi0lEQVR4nO1Wr1vDMBB95aO6pmYTM50oomaGiiFAYEBMYTCzw2AQ/AkTGAwYBBo1AQaBqqiaqalYTcVqampmIopKv/R3k35dJ/bUXdK8e7lcL5EgiIkxi1l/7awkER6uRYZ+kwSVZTk1RwhJbMf9aczb+ENdu46zQctACIHr/ea4v2Hb1L6FaQLASVMBbcEGZ/1THhI2zW2Cs+NcAgAgirzKeUXRuPiEj2AbbrANN6V+5wKG6hhDdVzqs6AFVzS+tyLMiqA+dw20wcd0fg4AK8tNflFuAbxFVoe9HUEZajOgjaYxAOx2ERcxXef5VmW3PbwM6Npl6pYT7X7FfEFuvvcM9C6gVR/4Cl4T+27w2K2AkTpI+S/Oc07Mk7FM/CAKxQR8Kn/v1J5HV4umAqtAOZc4y/GlBNiT+C278D68WACAH+YrOAv2G/p6YjdUBOEizJ555zXQRIQIUhkw19JDlS+COo7aVzHt6bwdkdYAexfMpnoMpK/jw29Ehqq3CuD5VmKzO6foPQNHHPEPvKl99O8bs0sAAAAASUVORK5CYII=';}if(window._warI.complete)ctx.drawImage(window._warI,0,0,32,32);else{px(ctx,4,0,26,30,'#28203c');}}break;
    case 'demon':{if(!window._demI){window._demI=new Image();window._demI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABm0lEQVR4nGNgIABSROT+p4jI/Sekjlx9LKQYyMDAwDDnzSNGYtQRC5gIKSBkIaV6CTqA1oDoKICBacrmeIP43MfnJJk34CHAyMDAwJAnqXECn6JJz29YMDAQ9j0MZN09SbS5OEPg0beP5rjkMpeeZMhcepKgGDHmsqBLynHxEzRlejSm27CJEWPugKcBshyw680jhqgTSxl2vXmEwqabAxgYGBgSVGyxskkFRJUDPXJGKKnfTUSOKPWPfn8jmJ5wOgBbovn2+zch8wgCdHNZsElKMrNiTdJvfn8jyhIRVi4GZHMkeUUYGBgYzJ///Y3hqQHPBVhrq3YZXZQ4Z2ViZWBgID0Efv9DjbLKJ5cx7BvwEBh1wKgDsDrAUUySofLJZUYYDRMXYeUiCsMAshmOYpJYHUBUgxO9KCYWlDw6R9B8klq8tWJqqOUDM6Qg/f33D4q65le3iDZ3cKaBUQcQA2DxX/f8Gtk9JwYGEjsm+7+8hLPd+KWxitPUAQwMDAxRkhpwNqz9TwkgyQFHvn1kjGJgwCgTjnz7SLZDABmPkC0E8RZVAAAAAElFTkSuQmCC';}if(window._demI.complete)ctx.drawImage(window._demI,0,0,32,32);else{px(ctx,1,0,30,32,'#8c1e32');}}break;
    case 'juggernaut':{if(!window._jugI){window._jugI=new Image();window._jugI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABJElEQVR4nO1XIRuCMBB985N/MKvF4n+hYKBQzBYzxWQxW8gWCkEK/8VisRAkUwiaxod+E+6GOIKv7Bs77t7e7nYA9EQY7h593hecQEVRkGyllDgc9iTfEyqBPM+ppixbMoGhMOUYV1VllwAAZEkMALgvl5hdLvVzNXf9gOXP+AiawXVzKtgKcHfYBQEAm81WW8tRdBRBsH4AgOM4LMcqX+L4JNr8j7sKPM+vmZtWQNOHDtYVqK9L3w9emKodSyl7BVDX93sOJUksgBEo0FmG1AZkCmMFzrerdvwZgdV8oR1/RuBbaM2BvhWg0JZH41Zg6AoAxqRAWZYvC9zu14V3/wrWFbBO4OO3e1cb5SJNE20s0s+D63paMlmWCsp6G6wfwZ/AH09mNmLF2V53QQAAAABJRU5ErkJggg==';}if(window._jugI.complete)ctx.drawImage(window._jugI,0,0,32,32);else{px(ctx,1,0,30,30,'#505055');}}break;
    case 'hellhound':{if(!window._hhI){window._hhI=new Image();window._hhI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABHElEQVR4nGNgGAWjYIABIy0M1eXh+Q9jX/7yhRGdj6yWiRYOIAUMPweYCwn9x8enyAH/TxhtQeFv0diCJr+AgYGBgYuNDY6x8ckC/6fJnUDhV4ig8nskTzAwQHwMw/9PMGCw0c2lei4gFOQn371DsZOFgYGB4f80uS2MWY98/m/RWMDocyOBFAMpBXDX/E8ROcE4540FugJqOwA9BFA4Rvz8GJaxMjNTZKEkExPDgusnGBI0LeD0hjdv4PbSxQHoANkBLMgS5z5+hEvAHPP7718UzWdD+RmMV38k3gVYHIAMcOYCbKFBDkD2FDZAcUl41pGVIv0UO8B4/++BdQClYMAdQLAoRm5MMDAgGhSkiuMCAx4Cow4YdcAoGAUAS1NobPnopB8AAAAASUVORK5CYII=';}if(window._hhI.complete)ctx.drawImage(window._hhI,0,0,32,32);else{px(ctx,1,5,28,24,'#320f0f');}}break;
    case 'undead_dragon':{if(!window._udI){window._udI=new Image();window._udI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABmklEQVR4nO2XLZeCQBSGXzxusSxhiv+FYoawxazBDW4xSNCwBA27QYNlCRIkWKRqtvBftkxgy1Q2+IXDxwwCa1ifczwgM8x9773vHAD47yi9TnsVveC4XvcvBdSqWHSzXoab9TKUuV7nJ/U67W3W4o7rGcUlXhBWgFKqlxmQJ1YBSqlOCNnduuBquQiTzqUFAIcyi1qRBWMMpmmBBgGIqmI2m8A0rcS5Ncf1ukfnk+NP6AMZaBBcHdPI9EARwxFVvTqmoZxOep321nE940VvhVEP8J4QiZLpe/d1cI57VYEySp+XRBNG4XfE5H0ozDAKpTRzPOaBIlvwFhTRhNGwHwJAo9EAAFj6jz3ZPfdF9zHGAACEkNiYOZ6e4wpbwCMTPC1YEtICGGPQNE1qru/7ssuW+zQ0mns77z2x8iS5/NTPW/ic2+W0AEAlLagDF6cDh2xPjs/CaO7t7XcrlyFTBfBY0/m5bFFx0cxGeOr7kM80U4CoT1VSyTthHqQz/1p8xHbH22CsyI6ncfcKPATcXYA0/BdN3v8P0vgFTWSeb2DKdfAAAAAASUVORK5CYII=';}if(window._udI.complete)ctx.drawImage(window._udI,0,0,32,32);else{px(ctx,0,2,30,28,'#787369');}}break;
    // ===== TOWER MONSTERS: FIRE =====
    case 'fire_sprite':{const ft=performance.now()/300;ctx.fillStyle='#f80';ctx.beginPath();ctx.arc(16,18,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='#ff0';ctx.beginPath();ctx.arc(16,14,6,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(16,10,3,0,Math.PI*2);ctx.fill();for(let i=0;i<3;i++){const a=ft+i*2.1;ctx.fillStyle='rgba(255,200,0,'+(0.5+0.3*Math.sin(a))+')';ctx.beginPath();ctx.arc(16+Math.cos(a)*10,16+Math.sin(a)*8,2,0,Math.PI*2);ctx.fill();}}break;
    case 'lava_golem':{px(ctx,6,4,20,24,'#8b2500');px(ctx,8,6,16,20,'#cd3700');px(ctx,10,8,4,4,'#ff4500');px(ctx,18,8,4,4,'#ff4500');const ft=performance.now()/400;ctx.fillStyle='rgba(255,140,0,'+(0.5+0.3*Math.sin(ft))+')';px(ctx,10,16,12,6);px(ctx,8,22,6,6);px(ctx,18,22,6,6);}break;
    case 'fire_elemental':{const ft=performance.now()/250;ctx.fillStyle='#ff4500';ctx.beginPath();ctx.arc(16,16,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='#ff8c00';ctx.beginPath();ctx.arc(16,12,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='#ffd700';ctx.beginPath();ctx.arc(16,8,5,0,Math.PI*2);ctx.fill();for(let i=0;i<5;i++){const a=ft*2+i*1.26;ctx.fillStyle='rgba(255,69,0,'+(0.4+0.3*Math.sin(a))+')';ctx.beginPath();ctx.arc(16+Math.cos(a)*14,16+Math.sin(a)*12,2.5,0,Math.PI*2);ctx.fill();}}break;
    case 'inferno_guardian':{px(ctx,4,2,24,28,'#8b0000');px(ctx,6,4,20,24,'#cd2626');px(ctx,10,6,4,4,'#ff6347');px(ctx,18,6,4,4,'#ff6347');px(ctx,12,14,8,4,'#ff4500');px(ctx,2,10,6,12,'#8b0000');px(ctx,24,10,6,12,'#8b0000');const ft=performance.now()/350;ctx.fillStyle='rgba(255,215,0,'+(0.4+0.4*Math.sin(ft))+')';px(ctx,8,0,16,4);}break;
    case 'flame_lord':{const ft=performance.now()/200;px(ctx,4,2,24,28,'#b22222');px(ctx,6,4,20,24,'#ff3030');px(ctx,10,6,5,5,'#ffd700');px(ctx,17,6,5,5,'#ffd700');px(ctx,11,7,3,3,'#000');px(ctx,18,7,3,3,'#000');px(ctx,12,14,8,3,'#ff6347');px(ctx,2,8,6,14,'#b22222');px(ctx,24,8,6,14,'#b22222');for(let i=0;i<6;i++){const a=ft*3+i;ctx.fillStyle='rgba(255,215,0,'+(0.5+0.4*Math.sin(a))+')';ctx.beginPath();ctx.arc(16+Math.cos(a)*15,16+Math.sin(a)*14,2,0,Math.PI*2);ctx.fill();}ctx.fillStyle='#ffd700';px(ctx,6,0,20,4);ctx.beginPath();ctx.arc(16,-2,4,0,Math.PI*2);ctx.fill();}break;
    // ===== TOWER MONSTERS: ICE =====
    case 'ice_sprite':{const ft=performance.now()/400;ctx.fillStyle='#87ceeb';ctx.beginPath();ctx.arc(16,18,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='#e0f0ff';ctx.beginPath();ctx.arc(16,14,6,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(16,10,3,0,Math.PI*2);ctx.fill();for(let i=0;i<3;i++){const a=ft+i*2.1;ctx.fillStyle='rgba(200,230,255,'+(0.4+0.3*Math.sin(a))+')';ctx.beginPath();ctx.arc(16+Math.cos(a)*10,16+Math.sin(a)*8,2,0,Math.PI*2);ctx.fill();}}break;
    case 'frost_golem':{px(ctx,6,4,20,24,'#4682b4');px(ctx,8,6,16,20,'#5f9ea0');px(ctx,10,8,4,4,'#e0ffff');px(ctx,18,8,4,4,'#e0ffff');px(ctx,10,16,12,6,'#87ceeb');px(ctx,8,22,6,6,'#4682b4');px(ctx,18,22,6,6,'#4682b4');}break;
    case 'blizzard_elemental':{const ft=performance.now()/300;ctx.fillStyle='#4169e1';ctx.beginPath();ctx.arc(16,16,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='#87ceeb';ctx.beginPath();ctx.arc(16,12,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='#e0ffff';ctx.beginPath();ctx.arc(16,8,5,0,Math.PI*2);ctx.fill();for(let i=0;i<6;i++){const a=ft*2+i*1.05;ctx.fillStyle='rgba(255,255,255,'+(0.3+0.4*Math.sin(a))+')';ctx.beginPath();ctx.arc(16+Math.cos(a)*14,16+Math.sin(a)*12,1.5,0,Math.PI*2);ctx.fill();}}break;
    case 'glacier_guardian':{px(ctx,4,2,24,28,'#1c3a5e');px(ctx,6,4,20,24,'#2e6b9e');px(ctx,10,6,4,4,'#b0e0e6');px(ctx,18,6,4,4,'#b0e0e6');px(ctx,12,14,8,4,'#87ceeb');px(ctx,2,10,6,12,'#1c3a5e');px(ctx,24,10,6,12,'#1c3a5e');ctx.fillStyle='#e0ffff';px(ctx,8,0,16,4);}break;
    case 'frost_wyrm':{const ft=performance.now()/250;px(ctx,2,4,28,24,'#1e3a5f');px(ctx,4,6,24,20,'#3a7bbf');px(ctx,8,6,6,5,'#b0e0e6');px(ctx,18,6,6,5,'#b0e0e6');px(ctx,9,7,4,3,'#000');px(ctx,19,7,4,3,'#000');px(ctx,10,15,12,4,'#4682b4');px(ctx,0,8,6,14,'#1e3a5f');px(ctx,26,8,6,14,'#1e3a5f');for(let i=0;i<4;i++){const a=ft*2+i*1.57;ctx.fillStyle='rgba(176,224,230,'+(0.4+0.4*Math.sin(a))+')';ctx.beginPath();ctx.arc(16+Math.cos(a)*15,16+Math.sin(a)*14,2,0,Math.PI*2);ctx.fill();}ctx.fillStyle='#e0ffff';px(ctx,10,2,4,4);px(ctx,18,2,4,4);}break;
    // ===== TOWER MONSTERS: SWAMP =====
    case 'swamp_toad':{px(ctx,6,10,20,16,'#2e5e1e');px(ctx,8,12,16,12,'#3a7a28');px(ctx,8,8,6,6,'#4a8a38');px(ctx,18,8,6,6,'#4a8a38');px(ctx,10,9,2,2,'#000');px(ctx,20,9,2,2,'#000');px(ctx,12,18,8,3,'#2e5e1e');px(ctx,6,22,6,4,'#3a7a28');px(ctx,20,22,6,4,'#3a7a28');}break;
    case 'decay_crawler':{px(ctx,4,12,24,12,'#5a4a2a');px(ctx,6,14,20,8,'#7a6a3a');px(ctx,8,10,4,4,'#8a7a4a');px(ctx,20,10,4,4,'#8a7a4a');px(ctx,2,16,4,4,'#5a4a2a');px(ctx,26,16,4,4,'#5a4a2a');px(ctx,4,20,4,4,'#5a4a2a');px(ctx,24,20,4,4,'#5a4a2a');const ft=performance.now()/500;ctx.fillStyle='rgba(100,180,50,'+(0.3+0.3*Math.sin(ft))+')';px(ctx,10,14,12,4);}break;
    case 'poison_beast':{px(ctx,4,4,24,24,'#3c6e28');px(ctx,6,6,20,20,'#4e8e32');px(ctx,10,8,4,4,'#ff0');px(ctx,18,8,4,4,'#ff0');px(ctx,11,9,2,2,'#000');px(ctx,19,9,2,2,'#000');px(ctx,10,16,12,4,'#3c6e28');px(ctx,2,12,6,10,'#3c6e28');px(ctx,24,12,6,10,'#3c6e28');const ft=performance.now()/350;ctx.fillStyle='rgba(0,255,0,'+(0.2+0.3*Math.sin(ft))+')';px(ctx,8,20,16,6);}break;
    case 'nature_wraith':{const ft=performance.now()/350;ctx.fillStyle='rgba(34,80,20,'+(0.6+0.2*Math.sin(ft))+')';ctx.beginPath();ctx.arc(16,14,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(50,120,30,0.9)';ctx.beginPath();ctx.arc(16,12,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='#90ee90';px(ctx,10,8,4,4);px(ctx,18,8,4,4);ctx.fillStyle='rgba(34,80,20,0.7)';ctx.beginPath();ctx.moveTo(8,20);ctx.quadraticCurveTo(16,32,24,20);ctx.fill();}break;
    case 'swamp_hydra':{px(ctx,4,8,24,20,'#2c5a1e');px(ctx,6,10,20,16,'#3a7428');px(ctx,6,2,6,10,'#2c5a1e');px(ctx,14,0,6,12,'#2c5a1e');px(ctx,22,2,6,10,'#2c5a1e');px(ctx,7,2,4,3,'#3a7428');px(ctx,15,0,4,3,'#3a7428');px(ctx,23,2,4,3,'#3a7428');px(ctx,8,3,2,1,'#ff0');px(ctx,16,1,2,1,'#ff0');px(ctx,24,3,2,1,'#ff0');const ft=performance.now()/300;ctx.fillStyle='rgba(0,200,0,'+(0.2+0.3*Math.sin(ft))+')';px(ctx,8,18,16,8);}break;
    // ===== TOWER MONSTERS: SHADOW =====
    case 'shadow_wisp':{const ft=performance.now()/350;ctx.fillStyle='rgba(100,50,150,'+(0.5+0.3*Math.sin(ft))+')';ctx.beginPath();ctx.arc(16,16,10,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(160,80,220,'+(0.6+0.2*Math.sin(ft*1.3))+')';ctx.beginPath();ctx.arc(16,14,6,0,Math.PI*2);ctx.fill();ctx.fillStyle='#e8c0ff';ctx.beginPath();ctx.arc(16,12,3,0,Math.PI*2);ctx.fill();for(let i=0;i<3;i++){const a=ft+i*2.1;ctx.fillStyle='rgba(200,150,255,'+(0.3+0.3*Math.sin(a))+')';ctx.beginPath();ctx.arc(16+Math.cos(a)*11,16+Math.sin(a)*9,1.5,0,Math.PI*2);ctx.fill();}}break;
    case 'umbral_wraith':{const ft=performance.now()/300;ctx.fillStyle='rgba(40,20,60,'+(0.7+0.2*Math.sin(ft))+')';ctx.beginPath();ctx.arc(16,14,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(80,40,120,0.9)';ctx.beginPath();ctx.arc(16,12,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='#c080ff';px(ctx,10,8,4,4);px(ctx,18,8,4,4);ctx.fillStyle='rgba(40,20,60,0.8)';ctx.beginPath();ctx.moveTo(6,20);ctx.quadraticCurveTo(16,32,26,20);ctx.fill();}break;
    case 'void_stalker':{px(ctx,4,4,24,24,'#1a0a2e');px(ctx,6,6,20,20,'#2d1b4e');px(ctx,10,8,4,4,'#c080ff');px(ctx,18,8,4,4,'#c080ff');px(ctx,11,9,2,2,'#fff');px(ctx,19,9,2,2,'#fff');px(ctx,12,16,8,3,'#1a0a2e');px(ctx,2,12,6,10,'#1a0a2e');px(ctx,24,12,6,10,'#1a0a2e');const ft=performance.now()/250;ctx.fillStyle='rgba(160,80,255,'+(0.2+0.3*Math.sin(ft))+')';px(ctx,8,20,16,6);}break;
    case 'shadow_lord':{px(ctx,4,2,24,28,'#0d0520');px(ctx,6,4,20,24,'#1a0a35');px(ctx,10,6,4,5,'#9040d0');px(ctx,18,6,4,5,'#9040d0');px(ctx,11,7,2,3,'#e0b0ff');px(ctx,19,7,2,3,'#e0b0ff');px(ctx,12,14,8,3,'#1a0a35');px(ctx,2,8,6,14,'#0d0520');px(ctx,24,8,6,14,'#0d0520');const ft=performance.now()/280;ctx.fillStyle='rgba(140,60,220,'+(0.3+0.4*Math.sin(ft))+')';px(ctx,8,0,16,4);for(let i=0;i<4;i++){const a=ft*2+i*1.57;ctx.fillStyle='rgba(200,140,255,'+(0.3+0.3*Math.sin(a))+')';ctx.beginPath();ctx.arc(16+Math.cos(a)*14,16+Math.sin(a)*12,2,0,Math.PI*2);ctx.fill();}}break;
    case 'void_dragon':{const ft=performance.now()/200;px(ctx,2,4,28,24,'#0a0318');px(ctx,4,6,24,20,'#150830');px(ctx,8,6,6,5,'#b060ff');px(ctx,18,6,6,5,'#b060ff');px(ctx,9,7,4,3,'#e0c0ff');px(ctx,19,7,4,3,'#e0c0ff');px(ctx,10,15,12,4,'#1a0a30');px(ctx,0,8,6,14,'#0a0318');px(ctx,26,8,6,14,'#0a0318');px(ctx,10,0,4,6,'#150830');px(ctx,18,0,4,6,'#150830');for(let i=0;i<6;i++){const a=ft*3+i*1.05;ctx.fillStyle='rgba(180,100,255,'+(0.4+0.4*Math.sin(a))+')';ctx.beginPath();ctx.arc(16+Math.cos(a)*15,16+Math.sin(a)*14,2.5,0,Math.PI*2);ctx.fill();}ctx.fillStyle='#c080ff';px(ctx,6,0,6,3);px(ctx,20,0,6,3);}break;
  }
  if(hp!==undefined&&maxhp){const pct=Math.max(0,hp/maxhp);px(ctx,2,30,28,2,'#300');px(ctx,2,30,Math.floor(28*pct),2,pct>0.5?'#0f0':pct>0.25?'#ff0':'#f00');}
  ctx.restore();
}

// ============ NPC / LOOT / PLAYER DRAWING ============
function drawNPC(ctx,x,y,name,type){
ctx.save();ctx.translate(x,y);
switch(type){
case 'shop':{if(!window._shpI){window._shpI=new Image();window._shpI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABH0lEQVR4nGNgGOmAkVQNKW4a//HJz9l1gyQzmUh1ALXBgDuA5Ci4tGUa3ijQ88miTxSEZdXh5RMLhm4IMDAwMJw7coTh3JEjlBjBwEKJZiMbG4osZ2AgIQp6UszxBj06KJlzkiizcSrCZqEIPxdRlr/5+I1oBw14OTDgDsBIhKumRcGD/tG5uzR3wICHAIoDtixIQUl4Gja6NHcARhRwcRGX0mnmAFzg3N03GGJ5xZIMDAwMDJN6n2PIGSmLEGUuRWlAROQbVstJAQRDwMYtFMLYtRqjIDqymoHBzYgfQ8+bj98Q+mBgzknyHIBuMLUBSVVnRagRSi7pWH2OEZ84MWBwlQOjDhgIQHRiCTCXI6lBsuHkI6LMHvAQGHAHjAIAgIpJAZKVfiAAAAAASUVORK5CYII=';}if(window._shpI.complete)ctx.drawImage(window._shpI,0,0,32,32);else{px(ctx,0,0,32,32,'#888');}}break;
case 'shop_alchemist':{if(!window._salI){window._salI=new Image();window._salI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABaklEQVR4nO2WIXDCQBBFXztVp6MqMJgqxCkEphWoCBQagUJjKqoqWhHdmoiqChQiNYhiEFEnqjCY6uhYKko6BJKwV9I5Uf5M5jKbvf9/9pKdhf+OM5vkXlevJXnTmRHzntctbpsrNmDzVja5VkcAEEXvawBPX5OYOQ2WAHxyxXbc929E3OIKbMPT17n1ULx2A4mZ59ZD8Spc2IpnJccsaRTEW5ey0mf4VQXqhNhtZ9gR/1oAi3Ah4i5NKhJUSonE0zQVG3J+BM4NFJYljj/WAONwlIsrpZjcPVUS9u9He0cQDL/3tNutPT3nFdgzoIdxlN2nBG/HCgQm/eGItY52nxc2olGYHi2cJxyU8jk/AnEr9lYJAIO+X5mnNlfS9OoxEHR7ADw+hyLC3X2Y18q80k4YT4JcJxzPpgBEDy+VhP7tIG9gg3Z/XKh11EyYTT5lcQmcf4QnA84NyAcS3bQbSMzq76biOuHcwAlfpc9tWz0w5pgAAAAASUVORK5CYII=';}if(window._salI.complete)ctx.drawImage(window._salI,0,0,32,32);else{px(ctx,0,0,32,32,'#888');}}break;
case 'shop_armor':{if(!window._sarI){window._sarI=new Image();window._sarI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABQklEQVR4nO1WoXaDMBS97FTxEeipiaqKqoopxBQaEVWBqkZUTyGmIqpRFVETqImqin0COjqWKXqWNoW8ZGfP9J6DIISby819eQARUKoblOqGGI6nmJf/Agllctsq62vTNAUAGGOseUWRe/MuKAKucb1wCKIE+OKk1pZzq/zr4hB7BoIF1Lty8t4XpBACwLf6mCy7l3zr5Oy60wAAm83Keh6UgaZpnONVVZG52DNwY9fh0DotppbceEaMyLIMQMQWaK1JAsYF5xCUgXvkfd+TuW4yUJZForXG7yvkxDPGWBzeAv4b7AKCMhCy1/fA7gC7AK8tOH+6j14hUkjprpAewPNazHJ7NSPxtgz675PH84U/qhktX+lNBgBwLGenkNrxfv9uOVHXu2Rq3AfsIXwIYBfgHRYhKlIpStl4cbM7wC7ggR98QWjKJZ/5SQAAAABJRU5ErkJggg==';}if(window._sarI.complete)ctx.drawImage(window._sarI,0,0,32,32);else{px(ctx,0,0,32,32,'#888');}}break;
case 'shop_mage':{if(!window._smgI){window._smgI=new Image();window._smgI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABbklEQVR4nO1WIVfDMBD+0reZ6uqZITAgglhFf8IsM4iZqQoUggkqQDCBrqrBTIDlJ0QMEwEGAWa6ugZRBC8l7do0GR1se/1U7t69u693Xy4lMAT1rlMAsG0750+SBADAWUBM8nVMCRQL/hYZ20mYLsQ58olbDDykl6VfXkXsjc+0OtERxSmFI5MpIyEXaApWsTgAUApH7sgmYf1FERW0RShm+vIUpqq446FvdAusyCcu54hlJ+eIqzQgMPIDpa0L7Vsg0HQHshE47GQAALM5r01g971Sf/LBTGoD2AIRGhNQtdi0/YDGLRC7X15Aw7N5aazYlsDPxqx7G1YIiIJNoZivSGj3NLB3BNb+HwAAb3KbnVk03SyBXvcxb4/fV8gs7w8yO8ZYK+/ujGD5eZqzezUxdndNAuH59wJxRxcEqN4LLJpqaYCzgCwe7lI5p5JAWVAVdIWnyvnvGmgJKOd9NLhq5GF6fb5pNbC9BFp8AcbdeqfPngdvAAAAAElFTkSuQmCC';}if(window._smgI.complete)ctx.drawImage(window._smgI,0,0,32,32);else{px(ctx,0,0,32,32,'#888');}}break;
case 'quest':{if(!window._qstI){window._qstI=new Image();window._qstI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABEElEQVR4nGNgoAD8v2P0//8do/+UmMFIrMKePBuSLCqZdIQos5lIMZQWYMAdQDCYmlIoi+O6Oefw2jHgIUAyuLRl2v9LW6b915AT+Q9jI/NJNY/oXIDsAHzyej5ZJJk54FEw4A4gKrhSAsjLCXM24M8BOB2AzUIuLlaSLP/27TdRDhrwKKCpA/IqKhjyKipQxC6dWPX/0olV8BBmoaUDYKBn2jQozfD/0aNHKHLDOwqIAXSJgpKsLAYGBkguQI5/BgYis+GbNx/JslhEhB+FPyizIdElITkFETElIdFpAFvJRg1AUtUZ5aaLkjaW7brMiE+cGDDgaWDUAQPuAKITi5uRHEmNkl3nHo32jEYBUQAAY/1l8He8XdMAAAAASUVORK5CYII=';}if(window._qstI.complete)ctx.drawImage(window._qstI,0,0,32,32);else{px(ctx,0,0,32,32,'#888');}}break;
case 'priest':{if(!window._prsI){window._prsI=new Image();window._prsI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABZ0lEQVR4nO2VoXKDQBCGfzq9CmIQiekT1MRgWpHYGGrzBlV9gqiamGpEVU10bWJiiUjNidagI2qIwIDoiauiM1yOY48wEyaTz+2y7O79uxwOGiLldqT6HOdhY5vnqq3iJr8Jx/aFr+WbND0fBv7YRgkrBagntFGC3ICU29FiHkacVx+O8w0W8zCyaaLRDrRJ4waeX0KjTYW8hIWk3ysemeKGgT/+T05YxqNGsItj7OL4mBR0BX6z1Pj5qdz0PFLu2qAsTaQQAgDgui6peJ7nAADGGHrewFjj5F/BterI0sRK6jrUfKoi3VNAR9Xs489HAMDd/VIbX+yOiYMF0Y2AMaYtrKI2omugcyNopEBB1QgKzl+BOigKkG5CxhjWH68lf9/tl+x9vi/Zk+kMQojam5DcgApfvZdsP3g6iKE0QLoHdBQnnkxnTVMA6OISqlSNgAJlBN1WIE1+WvkzeoPbyjonV+DSwIU/OgaR6vUwoqEAAAAASUVORK5CYII=';}if(window._prsI.complete)ctx.drawImage(window._prsI,0,0,32,32);else{px(ctx,0,0,32,32,'#888');}}break;
case 'banker':{if(!window._bnkI){window._bnkI=new Image();window._bnkI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABUElEQVR4nGNkIAHISUr+J0bdo+fPGYk1k4kUB9ACsJCieNVsZaLUWfg8J9pMooKK2KBHB8REBUkhgAusWtoOZ4dFV5Kkl+jEAgOXtkxDCY1vXFwYaiycEmifCMOy6sjVSh0HrJrWRBUHkJUGsio7sIr3TGwiKfjJdsC09grsEt++kWwW0a7VUA4gKSveuLuBKLNxKsJmIReWFI8NfMMSErgcRFYUpITewCo+Z7UGyWZRVBcYGREXIvgARSXhuXOEE11P7SMoy+g/AwMDg0/COZSoGPAQoMgBhEJgwcQ3GGInttigJG6KosDIiIugI0RE8IcSWQ6Ap/bV5OhGBYO3RbSg3QaFn1B5hCSDIfo3kO8AbABbCYdfQwCcaRFWgrUkJKnmkpN0Q0nBj57vYsQnTgwY8DQw6oABdwDRiUWEn5+kBsmbjx+JMnvAQ2DAHTAKAFH2VnhcrI+jAAAAAElFTkSuQmCC';}if(window._bnkI.complete)ctx.drawImage(window._bnkI,0,0,32,32);else{px(ctx,0,0,32,32,'#888');}}break;
case 'trainer':{if(!window._trnI){window._trnI=new Image();window._trnI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABBElEQVR4nGNgGOmAkRTFWzQ0/hOjzufGDaLNpYkDSHEME6kGUhuQFAIMDAwMW3pS8IaCT8kcRgYGRGjRLASyejfg5SODBU0B/xc0BWB1OAu5DphWHICXT2xCJNsBN248QuFraMiRZQ7ZDiDXQrIcsKUn5b9NfBNRBn6Ib/rPwMDAcGRhHTxBkuwAQikdZgEywOZAmDlvvr3BaQ7ZuQDZQmJDBxsgOw1QajEMDHhJOOqAUQcQnQv09PRIMhi9biDJAeglGDEFEz5zcNWEOB2ADRDrI1IBSQ0SG3PUkDhyEuJDXOLEgAFPhKMOGHAHEJ1YFlTgzkrYQELHBqLMHvAQGHAHjAIATetP2LQU9goAAAAASUVORK5CYII=';}if(window._trnI.complete)ctx.drawImage(window._trnI,0,0,32,32);else{px(ctx,0,0,32,32,'#888');}}break;
case 'king':{if(!window._kngI){window._kngI=new Image();window._kngI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABhUlEQVR4nNVXIVuEQBB9+Em5QiGTrnpBw10mXDKQLJYLl/wFJoPJX3DJcOUMJoKJQCJg0ID1EsHiBikWAga/5W5B2J3Vg7tXYPhmdx5vZ4bBgCLW4Wmh6gsAQ/fVUPE7omwKAGzGBNt9WIj2wCHtp8QS2CMF/hvKCnCsw2WrEkN39uueseOU6yZpWvocUwnoIHacYhxON7YbFJzEzo+gGhwAxuG0VESbwMXVTautCm0Cj4vbVlsV5ByIIp/kP0lTI3YD4Rie3aBMxE6SkJPYtvl9JwQAwF7aAOoNqrEPfH68C/XO3s5pAU+eBJuvrxJoTcLR6IwUVGd96xEkyUt5719mpODzRFzfBGkZ7loFaRI2vYW3sgS7SSGZCn9uxdX5gArp1/DadgrbNGvPvZUlBI/yug/Lc9yxn5rn8wSpCmTgtc2vOtBuRJszNwFihWyj94mos1bcNCP2roC0CqjTcBWy6Xj/FdjG3LIFNe4zZrQ9V8HhKOANLFIu+F/ZYfwZ9U6gd3wD1seCDKxWEXwAAAAASUVORK5CYII=';}if(window._kngI.complete)ctx.drawImage(window._kngI,0,0,32,32);else{px(ctx,0,0,32,32,'#888');}}break;
case 'knight_guard':{if(!window._kgdI){window._kgdI=new Image();window._kgdI.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABe0lEQVR4nO1Xq1bDQBC9yyEmOrqaT6hARaBqMDU10RHFRARTEUNEDBUgamJiYjBViCoE/EF1DWZNTEzEIkrSbB7sA0rgnF6VTObM3J3Zuzsh+AbWoxEDgMluR0S+m80rsywLAEAphW2PCQCcqyZN0zWrXjy3ZZtOJ71kKKUt25lK8jhO2U/41KFcgTzPD89BVBpVw+gT0IVtj0k0v2IA4C2fqzYpteAY0KrA4vam0x7c3SvH+p8V0FlpH/5eBZLkqVPHs9m18LQTxXl/exQT6MNqlbCiKKR9ZeNKE8iyTNYVAGCapjyB+PNSAYCiJrHcDwAAhmEoJQf2J6ZMxbRUcLEMO+3bua8cqyJwGVvchxenfXNxJBr+W4F/HwaX4eAEtG9D3ZL3EhD1nEuusdmEBLrgug4BAN8PlKYcYD9+heGCOz3LeaBFwJEYKo8FqT1QriSKHrgVeJ77pV0Gg6vgRGBwAtKbRVWKTQkCBxnWx/Jf+y9oJi4xeAtO+ACnp3sFz2DECAAAAABJRU5ErkJggg==';}if(window._kgdI.complete)ctx.drawImage(window._kgdI,0,0,32,32);else{px(ctx,0,0,32,32,'#888');}}break;
case 'teleporter':{ctx.fillStyle='#f0c040';ctx.beginPath();ctx.arc(16,16,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='#1a1a2e';ctx.beginPath();ctx.arc(16,16,9,0,Math.PI*2);ctx.fill();const t=performance.now()/500;ctx.fillStyle='rgba(160,128,240,'+(0.5+0.3*Math.sin(t))+')';ctx.beginPath();ctx.arc(16,16,7,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(240,192,64,'+(0.4+0.3*Math.cos(t))+')';ctx.beginPath();ctx.arc(16,16,4,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(16,16,2,0,Math.PI*2);ctx.fill();}break;
case 'djinn':{const dt=performance.now()/600;ctx.fillStyle='rgba(64,128,255,'+(0.6+0.2*Math.sin(dt))+')';ctx.beginPath();ctx.arc(16,12,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(100,160,255,0.9)';px(ctx,10,2,12,10);ctx.fillStyle='#fff';px(ctx,12,4,3,3);px(ctx,18,4,3,3);ctx.fillStyle='#111';px(ctx,13,5,1,1);px(ctx,19,5,1,1);ctx.fillStyle='rgba(64,128,255,0.8)';px(ctx,8,12,16,10);ctx.fillStyle='rgba(40,80,200,0.7)';ctx.beginPath();ctx.moveTo(8,22);ctx.quadraticCurveTo(16,32,24,22);ctx.fill();ctx.fillStyle='#f0c040';px(ctx,11,0,10,3);ctx.beginPath();ctx.arc(16,-1,3,0,Math.PI*2);ctx.fill();for(let si=0;si<4;si++){const sa=dt*1.5+si*Math.PI/2;ctx.fillStyle='rgba(255,215,0,'+(0.3+0.3*Math.sin(dt+si))+')';ctx.beginPath();ctx.arc(16+Math.cos(sa)*15,12+Math.sin(sa)*10,1.5,0,Math.PI*2);ctx.fill();}}break;
case 'cobbler':{ctx.fillStyle='#e8c4a0';px(ctx,10,4,12,10);ctx.fillStyle='#8b6914';px(ctx,10,14,12,16);ctx.fillStyle='#654321';px(ctx,10,24,5,6);px(ctx,17,24,5,6);ctx.fillStyle='#333';px(ctx,6,18,6,4);px(ctx,20,18,6,4);ctx.fillStyle='#4af';px(ctx,7,19,4,2);px(ctx,21,19,4,2);ctx.fillStyle='#a0522d';px(ctx,4,12,4,8);px(ctx,24,12,4,8);ctx.fillStyle='#daa520';px(ctx,13,0,6,4);ctx.fillStyle='#ff0';ctx.beginPath();ctx.arc(16,2,1.5,0,Math.PI*2);ctx.fill();}break;
case 'zone_portal':{const tp=performance.now()/400;ctx.fillStyle='rgba(160,80,240,0.8)';ctx.beginPath();ctx.arc(16,16,14,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(80,0,160,0.9)';ctx.beginPath();ctx.arc(16,16,10,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(200,140,255,'+(0.4+0.3*Math.sin(tp))+')';ctx.beginPath();ctx.arc(16,16,7,0,Math.PI*2);ctx.fill();for(let si=0;si<5;si++){const sa=tp+si*Math.PI*2/5;ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(16+Math.cos(sa)*11,16+Math.sin(sa)*11,1.5,0,Math.PI*2);ctx.fill();}ctx.fillStyle='#fff';ctx.font='bold 8px sans-serif';ctx.textAlign='center';ctx.fillText('\u2605',16,19);}break;
case 'zone_return':{const tr=performance.now()/500;ctx.fillStyle='rgba(64,200,64,0.8)';ctx.beginPath();ctx.arc(16,16,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(0,100,0,0.9)';ctx.beginPath();ctx.arc(16,16,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='rgba(100,255,100,'+(0.5+0.3*Math.sin(tr))+')';ctx.beginPath();ctx.arc(16,16,5,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.font='bold 10px sans-serif';ctx.textAlign='center';ctx.fillText('\u2191',16,20);}break;
case 'premium':case 'blessing':{ctx.fillStyle='#f0c040';ctx.beginPath();ctx.arc(16,16,14,0,Math.PI*2);ctx.fill();ctx.fillStyle='#1a1a2e';ctx.beginPath();ctx.arc(16,16,11,0,Math.PI*2);ctx.fill();ctx.fillStyle='#e8c4a0';px(ctx,10,6,12,8);ctx.fillStyle='#f0c040';px(ctx,12,2,8,4);ctx.fillStyle='#a080f0';px(ctx,10,14,12,10);ctx.fillStyle='#8060d0';px(ctx,10,24,5,6);px(ctx,17,24,5,6);}break;
case 'trainer_dummy':{
  // Wooden post
  ctx.fillStyle='#5a3a1a';px(ctx,14,8,4,22);
  // Cross arm
  ctx.fillStyle='#6b4423';px(ctx,6,12,20,3);
  // Straw head (circle)
  ctx.fillStyle='#c8a850';ctx.beginPath();ctx.arc(16,6,5,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#a08030';ctx.beginPath();ctx.arc(16,6,4,0,Math.PI*2);ctx.fill();
  // Straw wisps on head
  ctx.strokeStyle='#d4b860';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(12,2);ctx.lineTo(10,0);ctx.stroke();
  ctx.beginPath();ctx.moveTo(20,2);ctx.lineTo(22,0);ctx.stroke();
  ctx.beginPath();ctx.moveTo(16,1);ctx.lineTo(16,-1);ctx.stroke();
  // Face (X eyes)
  ctx.strokeStyle='#333';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(13,4);ctx.lineTo(15,6);ctx.moveTo(15,4);ctx.lineTo(13,6);ctx.stroke();
  ctx.beginPath();ctx.moveTo(17,4);ctx.lineTo(19,6);ctx.moveTo(19,4);ctx.lineTo(17,6);ctx.stroke();
  // Straw body fill
  ctx.fillStyle='#c8a850';px(ctx,12,15,8,10);
  // Straw wisps on arms
  ctx.strokeStyle='#d4b860';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(6,12);ctx.lineTo(4,10);ctx.stroke();
  ctx.beginPath();ctx.moveTo(26,12);ctx.lineTo(28,10);ctx.stroke();
  // Shield target on body
  ctx.fillStyle='#8b0000';ctx.beginPath();ctx.arc(16,20,3,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#ff2200';ctx.beginPath();ctx.arc(16,20,2,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(16,20,0.8,0,Math.PI*2);ctx.fill();
  // Base
  ctx.fillStyle='#4a2a0a';px(ctx,10,28,12,4);
  // Subtle idle wobble animation
  const tw=performance.now()/1200;
  ctx.fillStyle='rgba(200,168,80,'+(0.2+0.15*Math.sin(tw))+')';
  ctx.beginPath();ctx.arc(16,6,5.5,0,Math.PI*2);ctx.stroke();
}break;
case 'grey_djinn':{
  const gdt=performance.now()/600;
  ctx.fillStyle='rgba(140,140,140,'+(0.6+0.2*Math.sin(gdt))+')';ctx.beginPath();ctx.arc(16,12,12,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(170,170,170,0.9)';px(ctx,10,2,12,10);
  ctx.fillStyle='#fff';px(ctx,12,4,3,3);px(ctx,18,4,3,3);
  ctx.fillStyle='#111';px(ctx,13,5,1,1);px(ctx,19,5,1,1);
  ctx.fillStyle='rgba(140,140,140,0.8)';px(ctx,8,12,16,10);
  ctx.fillStyle='rgba(100,100,100,0.7)';ctx.beginPath();ctx.moveTo(8,22);ctx.quadraticCurveTo(16,32,24,22);ctx.fill();
  ctx.fillStyle='#c0c0c0';px(ctx,11,0,10,3);ctx.beginPath();ctx.arc(16,-1,3,0,Math.PI*2);ctx.fill();
  for(let si=0;si<4;si++){const sa=gdt*1.5+si*Math.PI/2;ctx.fillStyle='rgba(192,192,192,'+(0.3+0.3*Math.sin(gdt+si))+')';ctx.beginPath();ctx.arc(16+Math.cos(sa)*15,12+Math.sin(sa)*10,1.5,0,Math.PI*2);ctx.fill();}
}break;
}
if(name){ctx.fillStyle='#8af';ctx.font='bold 7px "Press Start 2P"';ctx.textAlign='center';ctx.fillText(name,16,-4);}
ctx.restore();
}

function drawLootBag(ctx,x,y){ctx.save();ctx.translate(x||0,y||0);
  px(ctx,0,0,32,32,'#8b6914');px(ctx,4,6,24,14,'#d4af37');px(ctx,6,8,20,12,'#f0c040');px(ctx,8,18,16,6,'#8b6914');ctx.strokeStyle='#654321';ctx.lineWidth=2;ctx.strokeRect(8,8,16,12);ctx.fillStyle='#ffff00';for(let i=0;i<3;i++){for(let j=0;j<2;j++){ctx.beginPath();ctx.arc(10+i*6,10+j*6,1.5,0,Math.PI*2);ctx.fill();}}
  ctx.restore();
}

function drawOtherPlayer(ctx,x,y,op){ctx.save();ctx.translate(x,y);const col=(op&&op.col)||'#888';
  px(ctx,0,0,32,32,'#999');px(ctx,10,6,12,6,'#e8c4a0');px(ctx,10,12,12,6,col);px(ctx,8,12,2,6,col);px(ctx,22,12,2,6,col);px(ctx,10,18,12,10,'#5a5a5a');px(ctx,8,18,2,8,'#654321');px(ctx,22,18,2,8,'#654321');ctx.fillStyle='#000';ctx.beginPath();ctx.arc(12,9,1.5,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(20,9,1.5,0,Math.PI*2);ctx.fill();
  ctx.restore();
}const ITEMS={club:{n:'Club',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAd0lEQVR4nGNgGOqAkRTF3Zki/2Hs0ulviNLLRKqLSAVD3wIWYhUuKNX7jyryhih9JPng9ZdnDK+/PCNFyzCIg1ELRi0YAhYQXVQwMDAwiPJIkWwBUWV6to/Qf2ziU7e8I6if5kFEdI0WZceH4otlhz4Njhpt6AMAMbUVHV1rU5cAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:3,p:20,d:'Basic weapon'},sword:{n:'Sword',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAdklEQVR4nGNgGEzgwYMH/x88ePCfFD1MtHIMDLCQovjBgwckW8BIrMILFy6gBI2BgQHReokGBw4c+H/gwIHBFQejFoxaQDkgmFk2NBjgTfcBDRfwmkFzH5AEsl2U/me7KI3m5CFmAdFlOnpyJZQ8YWBwJdNBCQDqpyAgpF3yiAAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:8,p:100,d:'Steel sword',sk:'melee'},fire_sword:{n:'Fire Sword',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAfElEQVR4nGNgIAH8v87w//91hv+k6GEk2vA0VIMZZxGnl4kU19Ac/Hdh+P/fhbQgIt0HLqQpJ9oC9DigugXkglELhpAFxOZcsi2Agz2kKSfoqm4G/Om/lIAZg6ss8lJi+O+lROuyiEQwagFBQHTmQU+uhJInDAyuZDooAQCJehgoph7T+gAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:22,p:800,d:'Flaming sword',sk:'melee'},magic_sword:{n:'Magic Longsword',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAi0lEQVR4nGNgIAWc+f+f4cz//6RoYSLJAjIAcRaQ6GpkwEKKYpc9EHoPCXqI84EJI2PaTIQvkNnUsQALWHWXOEvItiBMmZGRphYQC0YtGHgLSAIuHf//u3SQlqsJJrX/1xnwGsioid+MwRVESi6r/iu5rBqKxfWItoCoEpGBATO5EkqeMDC4kumgBADncyQjaQf/PAAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:30,p:2000,d:'Rare magic sword',sk:'melee'},axe:{n:'Battle Axe',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAeUlEQVR4nGNgGFGgO1Pkf3emyH9S9LBgE1ywYAFWQ16fLCHZUVgtYGBgYFBQUMBiAcnmMzChC0yYMOH/hw8fSDeJWAvwga/iOZRbUFBQwEhNH5AEyElFJAUROWDUglELKAeMxCrMdlFCSf9T99wjSi/NfTAKRgHlAADXtB5vvmYdpwAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:12,p:200,d:'Battle axe',sk:'melee'},halberd:{n:'Halberd',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAhElEQVR4nGNkIBJcuHDhPzLfwMCAkRh9TMQoOnDgwH/CqqgAujNF/ndnipBkGQsuiQULFmAY9PpkCcmOwhpEDQ0N/x88eECyYURbAAMCAgIoWNV9DnUtoDsgJ5Jp7oNRC0YtGLVg1AIiAFH1KgMDA0OUHR9KIbfs0Cfq1cmUgMFVH5ADACS2H3Tmr9loAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:18,p:600,d:'Heavy halberd',sk:'melee'},morning_star:{n:'Morning Star',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAhklEQVR4nGNgIAEkJCT8T0hI+E+KHkZiFTY0NPxH4xOll4kYRdhcTaxPiLKAEkCUBQsWLMAIDmxiFANyIpmkIHJwcGBwcHAgyVE0j4PBBRYsWPB/wYIFJMXB4AJD3wfdmSL/uzNFaJcPyAGjFowAC4gu07NdlFCS59Q996hXZdINkJPRaA4A3P8tr4H0m3MAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:15,p:350,d:'Morning star',sk:'melee'},giant_sword:{n:'Giant Sword',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAiUlEQVR4nGNkIAFcuHDhP4xtYGDASIweJlIsIAewEKtww4YN/x88eECyBST5QEFBgUFBQYF2FpADRi0YtWAIWEB0TmZgYGAgJyfjLbC6M0X+45OHgdLpb3CaQ/MgIgl4KTH891JiIMpXMDD0UxHRFiAHDSnBNHjygaO7CAp/2/Q3ROkbXMl0UAIA5KAZv8DTO2EAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:38,p:5000,d:'Giant sword',sk:'melee'},demon_blade:{n:'Demon Blade',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAkElEQVR4nO2V0Q3DIAxEX6pMwgpZgQ7XndipI1x//BHxEfmIaCK1J/kHbJ98HAAGBBLIqXk4ySNYMkkCPbu1lqy1JqgRDoYlyp5FimBJynEKNRwkUDXc5EsUbbNTrU7vV3R2MP0eTCewJGoDBIcTbOGWDfQG9rHfGyb4Ogqo3O01/RNcT5B+WWrnnik/2m/iAxx0JTZVpZxEAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:46,p:15000,d:'Demon blade',sk:'melee'},spear:{n:'Spear',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAW0lEQVR4nGNkIBJcuHDhPzLfwMCAkVi9RIMDBw78P3DgwH/CKhGAiequQAMspCg+vTKEZAto7oNRC0YtGLVg1IJRC0YtYGBgYCC64s52UUKpi6fuuUf9Sn9QAgCEIxBxA/ymEwAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:6,rng:3,p:50,d:'Basic spear',sk:'distance'},bow:{n:'Bow',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAArElEQVR4nGNgGPagO1Pkf3emyP8DGyb8J0c/Ez7JBaV6/0V5pBhKp79hJM95BCygBiDLgoaGhv8NDQ1EBRkLqYZ3Z4r8L21oIDrIcFrQnSny//WXZxSFPwPDYI0DqlhQOv0NoyiPFMOCUj2y0j9BC6gFhrkFCd2XGF9/ecbQnSlCdjwM8yBCB/9dXEgOKoIWwPIDMp+qFiADxj17KCqX8IIDGyb8pyQ1jQKcAACCDTMdeE0jZgAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:10,rng:4,p:300,d:'Long bow',sk:'distance'},crossbow:{n:'Crossbow',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAeUlEQVR4nGNgGAUEACM2wQULFvxPSEhAkWtoaPiPxmckpAenBQc2TPiPTZwQcAgowDCPBZvC0ztbsBrwVTyHgYGBgYH75RRy7CcMsl2U/me7KJHkOybaOGXUglELRi0YXhZgLU2xgSg7PpQyaNmhT0TpHfpBNAoIAgBegxzKA4mQXgAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:16,rng:5,p:700,d:'Heavy crossbow',sk:'distance'},royal_crossbow:{n:'Royal Crossbow',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAd0lEQVR4nGNgGFHgPwPD//8MDP9J0cOE1aDrmIb8v87wn+E6AwPDdTzyWAAjsRYQAxg1Mc1jwaZw53purAa4B37FK8/A8JUcdyFAt6vw/25XYcrjgJpg1IJRC0YtGA4WYC1NsYFsEwGUMmjqmQ9E6R36QTQKCAIA1IwhTcLviboAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:26,rng:6,p:2500,d:'Royal crossbow',sk:'distance'},arbalest:{n:'Arbalest',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAk0lEQVR4nO2UQRHFIAwFXzsVgAQkREIkIAEJSEECEpCCBCTggN46tE3nZ/6tU/YGJNmQQ4C3s2gDvfd9PKeUVLmnoBBCB4BaqxhsjAEAtNbEd2stACDGeNTdpCJEpGlO5Cq/fdM51693o1wqMpJzVo/9BjN3Zn5sQGL92zYFUzAFHxKoFxMRnXZQKUWV+/4RTX6yA5s1IDEAsacZAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:34,rng:7,p:6000,d:'Powerful arbalest',sk:'distance'},divine_bow:{n:'Divine Bow',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAkElEQVR4nO2UsRGDMBAEbz0UgxpykTQkujkCj3GCkf6BIWEjRb86nSTpTrwyOTvj9Xd4lTUjgOzwXcEetrsTpQSRVGGBq+yqaxLYkymCou4Ew/agzxkfLVhKdvDbSPv6HhLAu5lwUwCgGUXKDAnO5BHkBRSh0aF/JyQ4i25BNkkoQc/DCgm+D25dJ7i8g4cmC2PWM1eN5fdCAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:42,rng:8,p:14000,d:'Divine bow',sk:'distance'},magic_staff:{n:'Magic Staff',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAYElEQVR4nGNgoDFgJFbhTJf//5H56XsYidLLRIprjF0gmBRAkgXkABZSFJ/dQytnQEG2i9L/bBel/4RVIgDNg2jUglELRi0YtWDUAmoAouvkKDs+lHpg2aFP1K+TByUAAAjWDkKJH9ltAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:4,matk:10,p:400,d:'Magic staff',sk:'magic'},wand_fire:{n:'Wand of Fire',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAYElEQVR4nGNgIBL8d2H4//86FLsw/CdWHyNRhqdBDbyHpHEPcXqZiHUJXUC3ktL/biUlooOHgYEOPhi1YNSCUQtGLRi1YNQCBgYi62QGBgaGbEFBlJps6vv3Q7BOJgcAAF57FfPOc+tZAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:3,matk:16,p:900,d:'Fire wand',sk:'magic'},wand_ice:{n:'Wand of Ice',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAaUlEQVR4nGNkIBJ03P3/H5lfoczISIw+JmItYGBgYChXgmBSAFEWrHqH6npcYtgAUd5kYCA/iEgCLmmr/rukrSLK5TBAUhyQA0YtGLVg1IJRC0YtGBIWEF0rGbt0oFQ0Z/dUUL/SH5QAAFcGGS6FZBdsAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:3,matk:16,p:900,d:'Ice wand',sk:'magic'},wand_death:{n:'Wand of Death',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAc0lEQVR4nO2VsQ3AMAgEnygLeAVW8O8/gZnFI5A6kqV8IqfjKoz0OkODQWCMkas+SXvKnooAAHrvt3dESLlDFZjZst4myMxlvU0QESAJkvJ6XuPu6e769/Figq+UoAQlKEEJdiDfvtba7Q7MOaXs7xP8zgWKwxn9prFpwQAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:3,matk:22,p:2000,d:'Death wand',sk:'magic'},wand_cosmic:{n:'Wand Cosmic',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAdklEQVR4nGNkIBJ0MPz/j8yvOMPAwGDCyEhIHxMxhv+HGu7iAsEMDMQZTrQFjAzEGYYNsBBS8L/j/3/GCogFe/aQaw2RwIWh478LQ8d/wioRgKggogSMWjBqwagFoxaMWjAkLCC6KjRmSEOpaM4yzKJenTyoAQAWGBSBHwnE9gAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:4,matk:30,p:6000,d:'Cosmic wand',sk:'magic'},staff_destruction:{n:'Staff of Destruction',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAhElEQVR4nGNgIAD+pzH8/8+AHRPSy8DAwMBIjKL/DAz/GVzQBPcwMDB0MDAwVhBnBkEL/rsw/P9/BopdiPcBC0k2VZDuOOKDCLtmyoMH2RJjKCZFHxPVXEBNC4iNYJIsIDe8yfIBKZYNzjgYtWDUglELBpkFRJcpSmgl6D0i9dLcBzQHABY8K3BheLwmAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:5,matk:40,p:15000,d:'Staff of destruction',sk:'magic'},druid_rod:{n:'Druid Rod',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAfElEQVR4nGNkIBK4rHL5j8x/f+89w9mKs4yE9DERY7hxh/F/BgYGBiUlJQYlJSVi3US8BdgAMa4n2gKYYffu3WO4d+8euW4iDLJdlP5nuyj9J6wSAcgOolELRi0YtWDUglELhpUFRFV7DAwMDFF2fCgVzbJDn6hXZQ5qAABF2xreoFwdawAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:4,matk:10,p:400,d:'Druid rod',sk:'magic'},snakebite_rod:{n:'Snakebite Rod',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAc0lEQVR4nGNkIBK4rFL6j8zfE3aPkRh9TMRawMDAwKCkpMSgpKREihbiLdgddg8rmxAgypsMDHQKot2h9xh2hxLvepKBcZrSf+M0VJ8QAiT5gBwwasGoBaMWjFowagE1ANE1mpKLIEo9cG/Pe+rXaIMSAAA2RBgkYfQT7gAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:3,matk:14,p:800,d:'Snakebite rod',sk:'magic'},terra_rod:{n:'Terra Rod',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAfklEQVR4nGNkIBKsKjf+j8wP6zzLSIw+JmItYGBgYFBSEmRQUhJkYGBgYOhIU/pPQDnxFmAzrGLWPer5AGbYvXvvGe7de0+MFvJAmovS/zQX4oIGBkiKA3LAqAWjFoxaMGrBqAVDwgKiqj0GBgaGUGNBlIpm9dn31K/0ByUAAAbOGcE0T2PcAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:3,matk:18,p:1500,d:'Terra rod',sk:'magic'},hailstorm_rod:{n:'Hailstorm Rod',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAfUlEQVR4nGNkIAKceffu/733gihiYcqMjMToJRqsuvsfDlbd/f//zLt3/4nRx0RIQcfuu1gNMhESIsoHRHtz1d3/KBZRPYgYGBgYXNJW/XdJW0VU0MAAwSCiFIxaMGrBqAWjFoxaMCQsILpWMg7tQKlozq6uIEovzX1AcwAA+foo71b5LCcAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:3,matk:24,p:3500,d:'Hailstorm rod',sk:'magic'},springsprout_rod:{n:'Springsprout Rod',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAh0lEQVR4nGNkIBKk3U37j8yfpTyLkRh9LMQoctnt8v/evXsMu8+mMTAwMDCkh+4h1l0MTMQo2uO6h1FJSQnOv3fvHoPLbpf/eLTAAVHeZGAgP4hIAi6rlP67rFIiyuUwQFQQUQJGLRi1YNSCUQtGLRgSFhBdKxl3CKJUNGcr3hOll+Y+oDkAAEaLH4zf6G1UAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'weapon',s:'weapon',atk:4,matk:32,p:8000,d:'Springsprout rod',sk:'magic'},leather:{n:'Leather Armor',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAdUlEQVR4nGNgGAUEACMhBQtK9f7jk0/ovoTXDJySyAa//vIMqxpRHimCFjHhs50agIUYRcgupboFuIKHWMsp8gEhyxkYiEhF3Zki//FZUDr9DV4zaB7JoxYQBESlImJSC9kWvP/4h2zDGRiGQxzQ3IJRMAIAAGqQHgSzuBRmAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'armor',def:3,p:80,d:'Leather armor'},chain:{n:'Chain Armor',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAgElEQVR4nGNgGAUEACM+yYaGhv/EGNLQ0IDTHBZCmhUUFPDKP3jwAK88VpuRXU6KBdh8QtAHhFxICDDhkzQwMGAQEBAgSJNtAcz1hGiyLYCFPyEaH8CbTCdMmEBUMi0oKMBpDs19MPTjgOY+wJvRKM1kDAwEfEANMPQtGAUjAAAAvHtIJKPAuFkAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'armor',def:6,p:250,d:'Chain mail'},plate:{n:'Plate Armor',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAjUlEQVR4nGNgGOqAEZ/kgQMH/hNjiIODA05zWAhpFhAQwCv/4cMHvPJYbd6wYcN/mOHEWACzJCAgAMM8gj4g5EJCgIki3UQAgj5gYGBgkJCQwCr+4sULgnpJ8oH6fw0G9f8apGihfRARlQ8IBRFF+QDZIHIAzYNo6FuANw4ePHhAsQVDP4iGvgWjYOABANAxJfDbogcwAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'armor',def:10,p:900,d:'Plate armor'},knight_armor:{n:'Knight Armor',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAm0lEQVR4nGNgGOqAEZeES9ru/6QYtGeWK1azWAhpFBQUxCv//v17vPIYthqHrvqPbDCxFsDos6vDUMwk6ANCLiQEmCjSTQQg6AMGBtzBRIzvSPLBqgQThlUJJqRoId4CZINJsYSofAALIpjBYQvOMDAwoAYR2fkA2SDX/t0wEWK0MTAw0CEVDX0LcMYBpTkYBoZ+EA19C0bBwAMAUTYuCf0xtBoAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'armor',def:14,p:2500,d:'Knight armor'},magic_plate:{n:'Magic Plate',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAArklEQVR4nGNgGOqAEZdEucvu/6QY1LnHFatZLAQ1drgwdHSexSn//v17vPoxbE0zXvWfgYGBQVBQkAGZJmQBjJ51NgzFTCa8uqEaceGKcmNC2glbgA+UV+whqIZgHDAwMDAoKSlhFb937x5BvST5ID1NiSE9DbtlVLGAHEBUPlBSUsJIjoKCgihBRHY+YGDAHtaE0j8M0DyIhr4FOOPgHpFhTAgM/SAa+haMgoEHAH/EQZNlzfC7AAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'armor',def:18,p:5000,d:'Magic armor'},golden_armor:{n:'Golden Armor',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAf0lEQVR4nGNgGOqAEZfE/+sM/0kySBO7WSwEdfL64pf/vBmvNIYFt5YqQF3+gKDd2PSpRT9A8QlhHxBwISHARJFuIgBhHzAw4I4HInxHmg9kNkMwCYDmQURcPiAiiHDlA5pnNJoH0dC3AGc+uH1OgUSjHmAVHfpBNPQtGAUDDwC+LhyXXV4DvwAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'armor',def:22,p:10000,d:'Golden armor'},demon_armor:{n:'Demon Armor',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAjUlEQVR4nGNgoDFgxCXhwsDwnxSD9uAwiwmb4H8Ghv+7STB8N1QP0RZQE2BYYMzA8N+EDINMoHoJWgADriQYjk8tCzEGKOEQv0eEXpLiYCYUkwJIj2SSEi+RQQQD6QwMeHIOdjAwGY2aYNQCggBnKnoPpc8wQIoBbACfHAwMfBDhcyExheLA+2AUDH0AAMcJE+NfvkNuAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'armor',def:28,p:25000,d:'Demon armor'},leather_cap:{n:'Leather Cap',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAVUlEQVR4nGNgGAWjgFLAiE9yQanef2IMSei+hNMcFkKaX395hldelEcKrzwTIQsoBUPfAoJxQCiMCQGcsV8VJUBUCoKBtmUfsJpF8yAaBaNgFAwHAABZYgtOmjvYEgAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'helmet',def:1,p:40,d:'Leather cap'},steel_helm:{n:'Steel Helmet',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAf0lEQVR4nGNgGAUEACOxChcsWPAfmZ+QkECUXryKDhw4ADf0wYMHKHIKCgpwtoODA05zWAi5QEBAgIGBgYHBwMAAq/yHDx/w6mciZAGlYNSCgbeAYCoilEoIAZzpd8KECf9xyWEDBQUFWM0iKogWL17MsHjxYpz8UTAKRsFwBwDd7h0cy5r/jgAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'helmet',def:4,p:200,d:'Steel helmet'},crown_helm:{n:'Crown Helmet',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAa0lEQVR4nGNgGFHg/3WG//+vM/wnRQ8TqYYy5v4nyTKCFjAwMDAwaCJZOJmRKC1wB+GTJDY4GDVxm8NCUDevL375z5vxShMXRBSAUQsG3gKaJ1OcEreWKpBUJKhFP8BqFs2DaBSMglFABwAASgkgP5dLwFAAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'helmet',def:8,p:1500,d:'Crown helmet'},royal_helmet:{n:'Royal Helmet',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAnUlEQVR4nGNgGEzgPwPD//8MDP9J0cNErMJbSxX+Y2MTAiykuOb2UgVSlBO24P91RHDcPodbjlGTgRGXGTgl4Ibw+uJ34ufNeC0gOg7IBSRZMEtmE8MsmU20s4AcQFIqSnviR7IFgysOyAGEkykxhpCTD3a0ccMNz5ojzsDAwMAwLeUlVj4DAwODR9VXrGYRZQExAJcFo2AUjAI6AAB10yzbeGpQUwAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'helmet',def:12,p:4000,d:'Royal helmet'},demon_helmet:{n:'Demon Helmet',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAiUlEQVR4nO2TwQ2AIAxFX42TuIKOALM4k7s4Aq7gKnjQAwcbihi98BJCSj7/h6bAXwSIAWKtrrs7jAZj6x3JiUXRWLW3L3iTPidwD9pVFDDUuKO0SEAExBsMfKI3B2gs7lwlZFuUMq9l5vDBFP0/pntlgPpLx2T+w7VPSg2wKV6mAAtaQKPR+IADUrca+mqKlFIAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'helmet',def:16,p:12000,d:'Demon helmet'},wood_shield:{n:'Wood Shield',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAb0lEQVR4nGNgGAUDDRhxSXRnivw/f/UXUYYYarMxlE5/g9UsFnwa3cwVUPinrz9hYGBgYDDVlEERf/3lGU4zmIhyIgVg1AKCAG8kwyKVkLiCLG53DqwP0JPjaDIdmhbgjWT0yIMlR3yROgpGAfUBAMjrHtm/uFBRAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'shield',def:2,p:30,d:'Wood shield'},steel_shield:{n:'Steel Shield',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAgklEQVR4nGNgGAUEACMuiQULFvwnxaCEhASsZrHg06SgoECU4Q8ePMApx0SUCVBw4cIFhgsXLpCiBb8PYEBAQAAr/8OHDwT1kuQDcsDQtwBvHOCK0AMHDqDw0eOIaAsMDAywWoguTrVkSg4YtWDgLSCqqIAB9NRDsQX4kt8oGAVwAAB/9R18i3/NzwAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'shield',def:6,p:350,d:'Steel shield'},tower_shield:{n:'Tower Shield',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAApElEQVR4nGNgGOqAEZtgQ0PDf3IMa2howDCPBZdiBQUFkgx/8OABVnEmUgy5cOECw4ULF0iyGKcPYEBAQACv2IcPH/DqJ8kH5ACCPkAG/ekTGBgYGBg23nQgWs/g8kHhzAIGBgYGBgcH4vUMnA/wJccDBw5giGFLbXgtMDAwwGkpNjlcGW3o54OhbwHBOMAWxoTCnSQLkAG21EO2BbiS3SgYegAA9HMromd9GjMAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'shield',def:10,p:1200,d:'Tower shield'},demon_shield:{n:'Demon Shield',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAl0lEQVR4nGNgGAUEACMuiQ4Ghv+kGFSBwywWfJrKXSD06j3Y5UOh8p045AlaAANKxCjCAZjwSeJyOSlqCPrg7B4GBmNobJyFhjI6Hx/A6wNkwMiIn0+RBWcZGRjO4OFTbAElgKhUxMCACHcYICb8GRiI9AFypKJHNCFAlA/QXUus6xkY6BAHQ98CgnFwj5YWUGr4KBghAAB2fBs306okIwAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'shield',def:14,p:4000,d:'Demon shield'},blessed_shield:{n:'Blessed Shield',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAjUlEQVR4nGNgGAUEACMuiXfv3v1nYGBgEBTcw/D+vQtBg4SEhHCahdMCYgHMMdgAE0m23mCEYBIAaRZggNUEVbCQZJ7GKjSBUIJaiPMBetCQEFSk+eBGGEnKibdAA5pIYK7WwJloMACFkTxqARHpnBAgEMlo6ZyEyIWBgQ4iygHeIHr//j2t7R8FwwEAAFgpRsOpwNFGAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'shield',def:20,p:15000,d:'Blessed shield'},leather_legs:{n:'Leather Legs',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAT0lEQVR4nGNgGAUDDRgJKVhQqvcfn3xC9yW8ZrAQ44pbTx9hFVeTliOol4kYCygBRPmAGJeSbcHrL8/INpyBgQ5BNGrBqAWjFoyCUUANAAAqoApGrQGLqgAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'legs',def:2,p:60,d:'Leather pants'},steel_legs:{n:'Steel Legs',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAXUlEQVR4nGNgGAUDDRjxSS5YsOA/MYYkJCTgNIeFkOYHDx7glVdQUMArz0TIAkoBQR8QciFFFggICFBkOEEL0C358OEDTjGyLcBmACFDkQHNI3nUglELRsEoGAwAAM2EE1awTZoIAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'legs',def:5,p:400,d:'Steel legs'},golden_legs:{n:'Golden Legs',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAW0lEQVR4nGNgGAUDDRjxSf6/zvCfKEM0cZvDQkjz7XMKeOVVjR7glWciZAGlYICDiNeXGPMZGBg245QhGAcMn5E0wyzEJka2BdgMINpndIjkUQtGLRgFo2AwAADXLw7ktf7j5wAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'legs',def:10,p:2500,d:'Golden legs'},demon_legs:{n:'Demon Legs',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAZ0lEQVR4nGNgGAUDDRjxSbowMPwnxpA9eMxhIaT5PQF5QQLyTIQsoBQQ9AEhFxICeOPgPwPD/3QCBsyEGILTHJoHEV4LCLmeGDUDH8lKSOx7eMTItgCbAYQMRQYDG8mjFoyCUUAdAAB+Qgq+EocDHgAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'legs',def:14,p:8000,d:'Demon legs'},sandals:{n:'Sandals',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAQElEQVR4nGNgGAWjYBSMglEwBAAjPskFDQ7/YeyEhgOMxMoRZcGBBQn/0cUcEhYwEpJDB0y4LKAWoLkFo2AEAACi8xAHEKcPkQAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'boots',def:0,spd:10,p:20,d:'Sandals'},leather_boots:{n:'Leather Boots',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAV0lEQVR4nGNgGAWjYBSMgoEHjLgkujNF/qOLlU5/w0hIDh2w4LNdlEcKzn795RnRcsiACZ8F1ACjFhAEWGM+20cII5UwMDAwTN3yjpEYeWRAcx+MgoEHAFipFhHHhtPFAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'boots',def:1,spd:5,p:80,d:'Leather boots'},steel_boots:{n:'Steel Boots',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAZUlEQVR4nGNgGAWjYBSMAoKAEZvgggUL/mMTT0hIYCRGHhmw4LJZQEAAhf/hwweS5GGACZcF1AI09wFOC3BpIFYeBmgeRPSPg4aGhv8PHjzAqwmXfENDw/+GhgaUpEpzH4yCgQcAexEleWR2tZ0AAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'boots',def:3,p:300,d:'Steel boots'},golden_boots:{n:'Golden Boots',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAVUlEQVR4nGNgGAWjYBSMAoKAEZvg/+sM/7Eq1oSoJySPDFhwWs3ri8r/vJk0eShgwmkBlcCoBQNvAUayurVUAWsSZGBgYFCLfsBIrBoYoLkPRsHAAwD7wRITugE0LgAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'boots',def:5,spd:-10,p:2000,d:'Golden boots'},boh:{n:'Boots of Haste',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAqUlEQVR4nO2R4Q3CIBCF3zVdAFboCDiCjlBH0JnqCHUEHcGOgCPwRjh/GBuoVGPUGBO+hAR4d9+FABQKhcJTJD6oqgLAajtki4+7hQDAcnPSXH7o3FUqMnqr2yaEoCTH0BiTrCm5XESEJEIImgzw3itJWGvlzvQi1lohCe+9AkANAE3TvC2OiX3Vo8JP8P8D6umFa3slzyDnm+Zy1/Y67NfJf379BYXfcwEWqzdPq3q1wgAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'armor',s:'boots',def:1,spd:-30,p:8000,d:'+speed'},hp_pot:{n:'Health Potion',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAfklEQVR4nGNgGAXUBB1KSv87lJT+k6KHkViFq4yNUQwOO3uWKL1MpLiGHECUK87gCBaTe/cI6mch1iXGSkoo/LP37hGlj7QgcnGBYBIAzeOA6CBiYGBgYNizh2QLaO6DUQsIAqIjmdh0jw4I5sRVBAq3MAK5meZBNApGAeUAAIs0F8d0lSbyAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'potion',heal:100,p:25,d:'+100 HP',stk:1},mp_pot:{n:'Mana Potion',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAf0lEQVR4nGNgGAXUBEpKHf+VlDr+k6KHkViFxsarUAw+ezaMKL1MpLiGHECUK5RczmANlnt7TAjqZyHWJUpKxqiG3ztLlD6SgsjFBYJJATSPA6KDiIGBgWHPHtItoLkPRi0gCIiOZGLTPTogmBOV0MogDIsJlEk0D6JRMAooBwCRlhfHLe0SJgAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'potion',mana:100,p:30,d:'+100 MP',stk:1},ghp:{n:'Great HP Pot',vocs:['knight','paladin'],i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAhklEQVR4nGNgGOqAkViFHUpK/5H5FffuEaWXKEWrjI3/YxMPO3uWoH4mYiygBBB0wRm0oEEHJgSCioUYVxgrKWEVP3vvHkG9RFnAwMDAwODigsrfs4cobTSPg6FvAfFxQGSYo4OhH0RD3wKiIpmYHIsL4C1HVhEoh2AgDE95RPMgGgUjAAAAyKAZKB4ICSUAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'potion',heal:300,p:100,d:'+300 HP',stk:1},gmp:{n:'Great MP Pot',vocs:['mage'],i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAh0lEQVR4nGNgGOqAkViFSkod/5H59+5VEKWXKEXGxqv+YxM/ezaMoH4mYiygBBB0gZLLGayuh4F7e0zwmsFCjCuUlIyxG37vLEG9RFnAwMDA4OKCyt+zhzh9NI+DoW8B0XFAbJijg6EfREPfAqIimZgciwvgLUeUcJSiGA7AU6rSPIhGwQgAANMiGSjQTF1jAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'potion',mana:200,p:80,d:'+200 MP',stk:1},uhp:{n:'Ultimate HP',vocs:['knight'],i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAkklEQVR4nGNgoDFgJFbhKgaG/8j8MCL1EqXoDJrhMGBChH4mYiygBNDcArxefKekhDVo0IHQvXs4zWEhpFlQSQmv/Pt79/DK0zyICPoADlxcUPl79hCljTQfKClBMAmAeAuQDSbBEuKDiEBkUm4BkWGODoZ+Th76FhCMZEJFASGAs5DCVQfgArjqBpoH0SgYeAAAMD8WHBdypkgAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'potion',heal:800,p:350,d:'+800 HP',stk:1},ump:{n:'Ultimate MP',vocs:['mage'],i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAkUlEQVR4nGNgoDFgJF7pqv+o/DCi9BJpwZn/2MVNCOpnIs4C8gHNLcDrRSWXdziCBhXc2yOE0xwWQpqVlATxG37vPV55mgcRQR/AgIsLKn/PHuL0keQDJSUIJgUQbQGywaRYQnQQ3btHvKFkWUBsmKODoZ+Th74FBCOZUFFACOAp7HDVAbgA9rqB5kE0CgYeAAA1sRYcW27FbwAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'potion',mana:600,p:250,d:'+600 MP',stk:1},supreme_hp:{n:'Supreme HP',vocs:['knight'],i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAl0lEQVR4nO2VzQnAIAyFY+kkmaEjdGxH6N1bVklPgpb8lSJtwQ9EUHzPPEUTBDgAWBrfAFJkvQkXYAalFdm4xd0BK7tvBEyNxTN4iurOiG75nRCRqLWaqxBj6kTq1PCI7Aoq+973Ofe9QbyCNq5odN8yaOMIRFOJncGNzK8Mv0XT4H0D+xYZb0wU8QXUfjAP6Yf7/xlMXE6TPSp3t64aUQAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'potion',heal:1500,p:800,d:'+1500 HP',stk:1},gsp:{n:'Great Spirit Pot',vocs:['paladin'],i:'&#128156;',t:'potion',heal:250,mana:150,p:300,d:'Paladin spirit potion (HP+MP)'},usp:{n:'Ultimate Spirit Pot',vocs:['paladin'],i:'&#128155;',t:'potion',heal:500,mana:300,p:600,d:'Ultimate paladin spirit potion (HP+MP)'},cheese:{n:'Cheese',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAYklEQVR4nGNgGAWjYBQw4pL4f4bhPykG3b6pwKAW/QDDPBacOrgZGBh4fYkz/fNmnFJMxJmACm4fvEy0WqIsuH3wMoqhqva61LWAEoA7DpAAKS5GBwPsAzypYxSMglFAPAAAqjoSNkhAgzYAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'food',heal:20,p:3,d:'+20 HP',stk:1},meat:{n:'Meat',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAiklEQVR4nGNgGAWjYBQMfcBISMEqF6X/+OTD9tzDawYLNsH/Ly78Z2BgYGCUMGBkYGBgUBIUxKr53vv3WNUTtAAG3t0985+BgYHhXkU6g6CSEorc+3v3GFxmrmJ4x8CA14dM+CSpAbCGH7KXV7ko/ccXRGF77jGSHEToCmFhjdOVWAweBaNgFCAAAMwKLSjYGMptAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'food',heal:40,p:8,d:'+40 HP',stk:1},fish:{n:'Fish',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAaUlEQVR4nGNgGAWjYBQMfcAIY4R27P7PwMDAICgoSJGBs9JNGJH5KByYJcbGSmQZfu/eewwLWMgyCQtYXRGGVZxoC5SUUIPu3r33KPzQjlUM9+69ZzibboLdAuQ4QNeMzcBRMApGwSACANhiHUKzQdz+AAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'food',heal:35,p:5,d:'+35 HP',stk:1},bread:{n:'Bread',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAYUlEQVR4nGNgGAWjYBTQHDBiEzwz0+U/Mv/9+/dYNQsKCqLwTdL3YJjHgstmZM3oBmEDuByB0wJiDcZnOAMDAwMTUSZQAGhuAd4gwud1ii2ghuE4Lbh37x5VDB8Fo2CIAAB0uBWBeLEJQQAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'food',heal:25,p:4,d:'+25 HP',stk:1},ham:{n:'Ham',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAdUlEQVR4nGNgGAWjYNADRlwSZ9Jc/pNikMmsPVjNYsGnSVBJiaDBSglZEMYsA6zyeC0gZNH7e/cI6iXKAqzA2IVB0JiwMvItgIL3X/8w3OuswCnPRKkFhABRPsAW1sQEDwMDHXwwsEGELxm+xxOxo2AUDDEAAL3uFi9QALEQAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'food',heal:60,p:15,d:'+60 HP',stk:1},snake_skin:{n:'Snake Skin',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAZUlEQVR4nO3PUQ3AMAgE0NsyJVioBTRM5DRgAQtYQMImoCmQLP3j/V2aXntAa38d0SE//FZK5JZlz5ldJiK4OdwcRDTlzFX54eAR5ki6AABUFCq6zJFekOoFqe0L0gfMrFzW2h4fGXI/Sk9NrV8AAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:5,d:'Snake skin',stk:1},wolf_paw:{n:'Wolf Paw',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAZUlEQVR4nGNgGAWjgFLASEhBR5rLf3zyFbP24DWDhRhXKCkpYRW/d+8eQb1MxFhACRi1YOAtICoVEZNacAG8PkDOA8jpHZlNKJ8Q9MGee7j56HLYAME4cFGCYGQ+LrlRMAqGKAAAGxwYguwCBdsAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:12,d:'Wolf paw',stk:1},bear_paw:{n:'Bear Paw',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAaElEQVR4nGNgGAXDHjDikkhzUfpPikGz9tzDahYLPk1KgoJEGX7v/XucckxEmUABGLVg1ALKAd58gC99Ewuw+gA9F2PLpehiuHI+ziA6+16Q4ex7QbLEkAHOIDIWxAweYsVGwSigLgAAufYgQ8cpehcAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:25,d:'Bear paw',stk:1},orc_tooth:{n:'Orc Tooth',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAXElEQVR4nGNgGAUDDRiJVbhqVcd/ZH5YWAVReplIdRGpYOhbQHQcMDAwMJw5swoeDyYmYaNxMGrBcLGAhRTFgoKCJFsw9IOIJAuUlV0Z7927x3Dv3j3aWDAKaAIA/tsOFmFedlcAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:20,d:'Orc tooth',stk:1},minotaur_horn:{n:'Minotaur Horn',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAUUlEQVR4nGNgGOqAkViFoS7G/5H5q/ecJUovE6kuIhWMIAtW7znLKCgoyADDVLeAXDBqwcBbwEKKYlJSDwwM/SAatYC6FnTOWs04WhaNAgwAAHbDCWCK0XV/AAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:50,d:'Minotaur horn',stk:1},bone:{n:'Bone',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAYUlEQVR4nGNgGAXDHjDik/z//+5/uEJGZUZi5ZABC7EueffuzH/CqjABEzmaaAb+/7/7HzloiAE098GoBaMWUA6ILirev3+PIicoKIgwBE9RQXMfEF0WCQmZ4CzsRsEIBwAhaB6rjvmt7gAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:3,d:'Bone',stk:1},scorpion_tail:{n:'Scorpion Tail',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAdElEQVR4nGNgGAUEACOxClelKf1H5ofNukeUXiZSXUQqGDwWhM26x3iP4T0DDFPdAnLBCLOgYtZ7RiUGQQYlBkHaWEAOGPoWkAU60gT/d6QJ/iescsQGEQMDA0MaA8P/NAYGgsE0uINIiZYWzCKhshoFeAEAytAVQYJ9UG8AAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:15,d:'Scorpion tail',stk:1},dragon_scale:{n:'Dragon Scale',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAbUlEQVR4nGNgGAXDHjDikzzjwvCfGENM9uA2h4WQZiUlJbzy9+7dwytP0AIYEESz6D0Bg2GAiVgL4ICAjyi3gEiXk28BiYDoOCA2zMmyAFdKIZTCiLaAGIMosoCBgZ7JlEQwAlIRobJmFIwCBgDIShmCblbowAAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:100,d:'Dragon scale',stk:1},demon_horn:{n:'Demon Horn',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAbElEQVR4nGNgGOqAkViFHQwM/5H5FUTqZSLVRaQCoi0op7UF5AIWYhUyMjAwrkKLB2LA4IkDdPCfSN8MXh8wDpZ8QHQqYmBgYFBSUkJw7t0jSs/gjYNRCwYOdDAw/EevG/CBoR9Egy8OBh0AANySC3zsJSMvAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:250,d:'Demon horn',stk:1},gold_coin:{n:'Gold Coin',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAYklEQVR4nGNgGAWjYNADRkIK/l9n+I/XAE38ZrAQ5QxeX+zinzcT1MpElAVQcPvgZYbbBy+TooV4C5ANJsUSoi1QtdfFyqaaBeSCwWMBuXFAXDJlIC3ckQHNM9ooGAVDAAAAGloYZN/oHS4AAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'gold',p:1,d:'Gold',stk:1},spider_silk:{n:'Spider Silk',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAdElEQVR4nO2Tyw2AIBAFZ40NQCv0XwKtsCXoyYOR30ZJPOwc+by3EwI4zjKOBqWU6norR3oFloFEpJq1WUIAVBVVnS9ubXxlsFtCgNv0IYTheVNBzhmAlNL0HbMB2Cz+/QYXPYvlBuaC3h+IMT7ylhs4zntO9jJcUD2opyQAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:30,d:'Spider silk',stk:1},mummy_bandage:{n:'Mummy Bandage',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAUklEQVR4nGNgGAXDHjASUnBm98z/+ORNXNPxmsFCyAJBQUEGQUFBrHLv378npJ2BiaAKCgFBH7x//54ol5JtwWgQjQYR5RaMBhFRQTQKRgFeAAB13yeVY0tRHwAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:35,d:'Mummy bandage',stk:1},cyclops_eye:{n:'Cyclops Eye',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAe0lEQVR4nO2TwQ2AIAxFW+MCMBOMoEPqCDBTGaGeuAG2waiHviPN/+T/tACGMQv2BkTEGiPvfdNrHYmccyLzUkp3togcJhgmqMQzNt/Tlm61/0hQyXsGZgZEhHAEkUadALG7eM98oEVVkbQWEUTEUkZH+W1Fows1jPe4AAM2Q4zqRzH8AAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:80,d:'Cyclops eye',stk:1},lich_staff_piece:{n:'Lich Staff Piece',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAXUlEQVR4nGNgGAUEACOxCme6/P+PzE/fw0iUXiZSXGPsAsGkAJIsIAewkKL47B5aOQMKQkND/4eGhv4nrBIBaB5EoxaMWjBqAQmlqYuLC0oO3rNnD/VL01EwCrACAIcaDpJVLVhiAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:200,d:'Lich staff piece',stk:1},warlock_rune:{n:'Warlock Rune',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAeUlEQVR4nGNgGAXDHjDik+xgYPhPjCEVeMxhIaRZSUkJr/y9e/fwyjMRsgAGQu/iN4hiC1YrKzGEKkEwTSwgFxCMAwYGBgxXw/irCYQ/A8Ng8QHMpaS4HAbI8gEpKYooH8AA3OXKxKckmsfB0LeAYBwQKmtGwShgAABMoBmuz//ANAAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:180,d:'Warlock rune',stk:1},hydra_head:{n:'Hydra Head',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAj0lEQVR4nGNgGAUDDRhxSbiscvlPikF7wvZgNYsFnyYlJSWiDL937x5OOSZCmmeazGKYaTKLaHGSLaAU4A0iBgYGhvQzaSSJo4OB9wEDAwPD2T1nsYobuxgT1Eu0D86Un8HKppoFJp0mWNmEAN4ggqVvQSVBvPL4AM6cDAOEcjSuHAwDNE9FQ9+CUTAKKAcAgZIiaafXaK8AAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:150,d:'Hydra head',stk:1},juggernaut_plate:{n:'Juggernaut Plate',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAd0lEQVR4nGNgGAUDDRixCQYEBPwnx7ANGzZgmMeCS7GCggJJhj948ACrOBNJppABcPoABgj5BJfLYYAkH0hJSTFISUmRomUQBBEyePbsGfUtIBTGhMDABtGHDx+IMkRAQACnHM19MLBBhM/rFFtAaeoZBaOAegAAGpEV6M0OckUAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:400,d:'Juggernaut plate',stk:1},hellhound_fang:{n:'Hellhound Fang',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAYklEQVR4nGNgGAUEACOxCu/ePfMfma+sbEKUXiZSXUQqGPoWEB0HDAwMDO/eIeJBSGg0DkYtgAIWUhQLCgqSbMHQD6KhbwFJkczIqMyIXFwQAwZfEAmGVdDWAgYG4kvS4QEACLgNYdd48ZMAAAAASUVORK5CYII=" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:350,d:'Hellhound fang',stk:1},ancient_rune:{n:'Ancient Rune',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAgklEQVR4nGNgGAXDHjDiknBx6fhPikF79lRgNYsFnyZBQSWiDH///h5OOSZCmletCiNLDgbw+oCBgYEhLGwVAwMDA0NoaCiK+OrVq+Fy+ABBH1AKiLZg9erVWNlUs4BcMPQtIJiKGBgwUxCMT0xcDA4fkJJq0MHA+gBfGTMKRgEcAAD+OhzkuzK0+wAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:500,d:'Ancient rune',stk:1},boar_tusk:{n:'Boar Tusk',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAaklEQVR4nGNgGAUDDRiJVfj//93/KBoZlYnSy0Sqi0gFNLeAJPD//5n///+f+U9YJQIM/SAatWDUggGw4P379wzv3u0mOrORZAEjownRhSNZFsDA+/fvGe7eXUWUL0i2QEjIlWRfjIKBBQCGrBjkjRMwMgAAAABJRU5ErkJggg==" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:10,d:'Boar tusk',stk:1},deer_antler:{n:'Deer Antler',i:'<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAAY0lEQVR4nGNgGLZgVUfo/1Udof8pVcdEyIDdM9NwasYnBwOMxBj+/v17rPKCgoIMDAwMDK7ps3Cag9cCBgZIEOCTD6tYTdAMogGx8YIMCMYBpWDUglELRi0YBaNgFDAwMDAAAIPfH62OD7IgAAAAAElFTkSuQmCC" style="width:20px;height:20px;vertical-align:middle;image-rendering:pixelated">',t:'loot',p:8,d:'Deer antler',stk:1},soft_boots:{n:'Soft Boots',i:'<span style="color:#4af;text-shadow:0 0 4px #88f,-3px -2px 0 #ff0,3px -2px 0 #ff0,0px 3px 0 #ff0">&#128095;</span>',t:'boots',s:'boots',def:2,spd:-40,p:50000,d:'Premium boots (+speed)',premium:true},worn_soft_boots:{n:'Worn Soft Boots',i:'<span style="color:#666;text-shadow:0 0 2px #444">&#128095;</span>',t:'boots',s:'boots',def:1,spd:0,p:1000,d:'Depleted soft boots'},firewalker_boots:{n:'Firewalker Boots',i:'&#128293;',t:'boots',s:'boots',def:3,spd:-30,p:75000,d:'Premium fire boots (+speed)',premium:true},exercise_sword:{n:'Exercise Sword',i:'&#9876;&#65039;',t:'training',sk:'melee',charges:50,maxCharges:50,xpPerCharge:3,p:2000,d:'Train melee skill (50 charges)',premium:true},exercise_bow:{n:'Exercise Bow',i:'&#127993;',t:'training',sk:'distance',charges:50,maxCharges:50,xpPerCharge:3,p:2000,d:'Train distance skill (50 charges)',premium:true},exercise_wand:{n:'Exercise Wand',i:'&#10024;',t:'training',sk:'magic',charges:50,maxCharges:50,xpPerCharge:3,p:2000,d:'Train magic skill (50 charges)',premium:true},exercise_shield:{n:'Exercise Shield',i:'&#128737;&#65039;',t:'training',sk:'shielding',charges:50,maxCharges:50,xpPerCharge:3,p:2000,d:'Train shielding skill (50 charges)',premium:true},durable_exercise_sword:{n:'Durable Exercise Sword',i:'&#9876;&#65039;',t:'training',sk:'melee',charges:250,maxCharges:250,xpPerCharge:3,p:8000,d:'Train melee skill (250 charges)',premium:true},durable_exercise_bow:{n:'Durable Exercise Bow',i:'&#127993;',t:'training',sk:'distance',charges:250,maxCharges:250,xpPerCharge:3,p:8000,d:'Train distance skill (250 charges)',premium:true},durable_exercise_wand:{n:'Durable Exercise Wand',i:'&#10024;',t:'training',sk:'magic',charges:250,maxCharges:250,xpPerCharge:3,p:8000,d:'Train magic skill (250 charges)',premium:true},durable_exercise_shield:{n:'Durable Exercise Shield',i:'&#128737;&#65039;',t:'training',sk:'shielding',charges:250,maxCharges:250,xpPerCharge:3,p:8000,d:'Train shielding skill (250 charges)',premium:true},bronze_amulet:{n:'Bronze Amulet',i:'<span style="color:#cd7f32">&#128141;</span>',t:'amulet',s:'amulet',def:1,p:500,d:'Simple bronze amulet (+1 def)'},silver_amulet:{n:'Silver Amulet',i:'<span style="color:#c0c0c0">&#128141;</span>',t:'amulet',s:'amulet',def:2,p:2000,d:'Silver amulet (+2 def)'},gold_amulet:{n:'Gold Amulet',i:'<span style="color:#f0c040">&#128141;</span>',t:'amulet',s:'amulet',def:3,p:5000,d:'Gold amulet (+3 def)'},platinum_amulet:{n:'Platinum Amulet',i:'<span style="color:#e0e8f0">&#128141;</span>',t:'amulet',s:'amulet',def:4,p:12000,d:'Platinum amulet (+4 def)',premium:true},amulet_of_loss:{n:'Amulet of Loss',i:'<span style="color:#ff4444">&#128141;</span>',t:'amulet',s:'amulet',def:0,p:50000,d:'Prevents item loss on death (consumed on death)',onDeath:'prevent_loss'},dragon_necklace:{n:'Dragon Necklace',i:'<span style="color:#ff6600">&#128141;</span>',t:'amulet',s:'amulet',def:2,p:20000,d:'Dragon fire necklace (+2 def, fire resist)',premium:true},bronze_ring:{n:'Bronze Ring',i:'<span style="color:#cd7f32">&#128142;</span>',t:'ring',s:'ring',def:1,p:400,d:'Simple bronze ring (+1 def)'},silver_ring:{n:'Silver Ring',i:'<span style="color:#c0c0c0">&#128142;</span>',t:'ring',s:'ring',def:2,p:1500,d:'Silver ring (+2 def)'},gold_ring:{n:'Gold Ring',i:'<span style="color:#f0c040">&#128142;</span>',t:'ring',s:'ring',def:2,p:4000,d:'Gold ring (+2 def)'},ring_of_healing:{n:'Ring of Healing',i:'<span style="color:#4f4">&#128142;</span>',t:'ring',s:'ring',def:1,p:8000,d:'Healing ring (+1 def, regen boost)',regenBoost:true},might_ring:{n:'Might Ring',i:'<span style="color:#f44">&#128142;</span>',t:'ring',s:'ring',def:4,p:15000,d:'Mighty ring (+4 def)',premium:true},energy_ring:{n:'Energy Ring',i:'<span style="color:#4af">&#128142;</span>',t:'ring',s:'ring',def:1,p:10000,d:'Converts damage to mana drain (+1 def)',premium:true,manaShield:true},fire_essence:{n:'Fire Essence',i:'üî•',t:'material',p:100,st:1},frozen_shard:{n:'Frozen Shard',i:'‚ùÑ',t:'material',p:100,st:1},toxic_gland:{n:'Toxic Gland',i:'üß™',t:'material',p:100,st:1},shadow_crystal:{n:'Shadow Crystal',i:'üîÆ',t:'material',p:100,st:1},dragon_scale:{n:'Dragon Scale',i:'üêâ',t:'material',p:500,st:1},tower_key:{n:'Ancient Tower Key',i:'üóù',t:'material',p:1000,st:1}};const MONS={bug:{n:'Bug',hp:15,atk:2,def:0,xp:5,spd:1400,sz:.5,loot:[{id:'gold_coin',mn:1,mx:3,ch:.6}]},rat:{n:'Rat',hp:25,atk:5,def:1,xp:10,spd:1200,sz:.7,loot:[{id:'gold_coin',mn:1,mx:5,ch:.8},{id:'cheese',mn:1,mx:1,ch:.3}]},cave_rat:{n:'Cave Rat',hp:35,atk:8,def:2,xp:15,spd:1100,sz:.7,loot:[{id:'gold_coin',mn:2,mx:8,ch:.8},{id:'cheese',mn:1,mx:1,ch:.2}]},deer:{n:'Deer',hp:40,atk:3,def:1,xp:12,spd:900,sz:.8,loot:[{id:'gold_coin',mn:1,mx:5,ch:.7},{id:'meat',mn:1,mx:2,ch:.5},{id:'deer_antler',mn:1,mx:1,ch:.25}]},snake:{n:'Snake',hp:45,atk:10,def:2,xp:18,spd:1000,sz:.7,loot:[{id:'gold_coin',mn:2,mx:10,ch:.8},{id:'snake_skin',mn:1,mx:1,ch:.4}]},boar:{n:'Boar',hp:55,atk:13,def:3,xp:25,spd:1000,sz:.85,loot:[{id:'gold_coin',mn:3,mx:12,ch:.9},{id:'meat',mn:1,mx:2,ch:.4},{id:'boar_tusk',mn:1,mx:1,ch:.2}]},poison_spider:{n:'Poison Spider',hp:60,atk:14,def:4,xp:28,spd:900,sz:.8,loot:[{id:'gold_coin',mn:3,mx:12,ch:.9},{id:'spider_silk',mn:1,mx:1,ch:.2}]},scorpion:{n:'Scorpion',hp:55,atk:16,def:3,xp:30,spd:950,sz:.75,loot:[{id:'gold_coin',mn:3,mx:15,ch:.9},{id:'scorpion_tail',mn:1,mx:1,ch:.35}]},wolf:{n:'Wolf',hp:70,atk:16,def:4,xp:35,spd:850,sz:.85,loot:[{id:'gold_coin',mn:5,mx:20,ch:.9},{id:'wolf_paw',mn:1,mx:1,ch:.3},{id:'meat',mn:1,mx:2,ch:.5}]},rotworm:{n:'Rotworm',hp:80,atk:15,def:4,xp:40,spd:1400,sz:.8,loot:[{id:'gold_coin',mn:5,mx:18,ch:.9},{id:'meat',mn:1,mx:1,ch:.3}]},bear:{n:'Bear',hp:120,atk:22,def:6,xp:55,spd:1300,sz:1,loot:[{id:'gold_coin',mn:8,mx:30,ch:1},{id:'bear_paw',mn:1,mx:1,ch:.25},{id:'meat',mn:1,mx:3,ch:.6}]},troll:{n:'Troll',hp:100,atk:18,def:5,xp:45,spd:1400,sz:.9,loot:[{id:'gold_coin',mn:5,mx:25,ch:1},{id:'club',mn:1,mx:1,ch:.1},{id:'fish',mn:1,mx:2,ch:.4}]},skeleton:{n:'Skeleton',hp:90,atk:20,def:8,xp:50,spd:1200,sz:.9,loot:[{id:'gold_coin',mn:5,mx:25,ch:1},{id:'bone',mn:1,mx:2,ch:.5},{id:'sword',mn:1,mx:1,ch:.05}]},mummy:{n:'Mummy',hp:150,atk:28,def:10,xp:80,spd:1400,sz:.95,loot:[{id:'gold_coin',mn:10,mx:40,ch:1},{id:'mummy_bandage',mn:1,mx:2,ch:.3},{id:'magic_staff',mn:1,mx:1,ch:.03}]},orc:{n:'Orc',hp:130,atk:25,def:10,xp:75,spd:1300,sz:.95,loot:[{id:'gold_coin',mn:10,mx:40,ch:1},{id:'orc_tooth',mn:1,mx:1,ch:.25},{id:'axe',mn:1,mx:1,ch:.05}]},orc_warrior:{n:'Orc Warrior',hp:200,atk:35,def:14,xp:110,spd:1200,sz:1,loot:[{id:'gold_coin',mn:15,mx:60,ch:1},{id:'orc_tooth',mn:1,mx:2,ch:.35},{id:'chain',mn:1,mx:1,ch:.06},{id:'halberd',mn:1,mx:1,ch:.03}]},minotaur:{n:'Minotaur',hp:250,atk:40,def:16,xp:160,spd:1100,sz:1.05,loot:[{id:'gold_coin',mn:20,mx:80,ch:1},{id:'minotaur_horn',mn:1,mx:1,ch:.2},{id:'chain',mn:1,mx:1,ch:.04}]},giant_spider:{n:'Giant Spider',hp:220,atk:35,def:12,xp:130,spd:800,sz:1.1,loot:[{id:'gold_coin',mn:15,mx:50,ch:1},{id:'spider_silk',mn:1,mx:2,ch:.3},{id:'plate',mn:1,mx:1,ch:.04}]},demon_skeleton:{n:'Demon Skeleton',hp:300,atk:50,def:20,xp:220,spd:1000,sz:1,loot:[{id:'gold_coin',mn:30,mx:100,ch:1},{id:'bone',mn:2,mx:4,ch:.5}]},cyclops:{n:'Cyclops',hp:350,atk:55,def:20,xp:280,spd:1500,sz:1.1,loot:[{id:'gold_coin',mn:30,mx:100,ch:1},{id:'cyclops_eye',mn:1,mx:1,ch:.2},{id:'plate',mn:1,mx:1,ch:.04}]},wyrm:{n:'Wyrm',hp:500,atk:70,def:25,xp:400,spd:1200,sz:1.1,loot:[{id:'gold_coin',mn:40,mx:150,ch:1},{id:'dragon_scale',mn:1,mx:1,ch:.2},{id:'golden_armor',mn:1,mx:1,ch:.02}]},serpent_spawn:{n:'Serpent Spawn',hp:550,atk:75,def:28,xp:450,spd:1100,sz:1.1,loot:[{id:'gold_coin',mn:50,mx:160,ch:1},{id:'snake_skin',mn:2,mx:4,ch:.5},{id:'golden_legs',mn:1,mx:1,ch:.02}]},hydra:{n:'Hydra',hp:800,atk:100,def:35,xp:800,spd:1400,sz:1.3,loot:[{id:'gold_coin',mn:60,mx:200,ch:1},{id:'hydra_head',mn:1,mx:2,ch:.3},{id:'knight_armor',mn:1,mx:1,ch:.03}]},dragon:{n:'Dragon',hp:700,atk:90,def:35,xp:700,spd:1600,sz:1.3,loot:[{id:'gold_coin',mn:50,mx:200,ch:1},{id:'dragon_scale',mn:1,mx:2,ch:.4},{id:'fire_sword',mn:1,mx:1,ch:.03},{id:'golden_armor',mn:1,mx:1,ch:.01}]},dragon_lord:{n:'Dragon Lord',hp:1200,atk:130,def:45,xp:1400,spd:1400,sz:1.4,loot:[{id:'gold_coin',mn:100,mx:400,ch:1},{id:'dragon_scale',mn:2,mx:4,ch:.6},{id:'magic_plate',mn:1,mx:1,ch:.02},{id:'crown_helm',mn:1,mx:1,ch:.03}]},lich:{n:'Lich',hp:900,atk:110,def:38,xp:1200,spd:1300,sz:1,loot:[{id:'gold_coin',mn:80,mx:300,ch:1},{id:'lich_staff_piece',mn:1,mx:1,ch:.15},{id:'wand_death',mn:1,mx:1,ch:.03}]},warlock:{n:'Warlock',hp:1100,atk:120,def:40,xp:1500,spd:1200,sz:1,loot:[{id:'gold_coin',mn:100,mx:350,ch:1},{id:'warlock_rune',mn:1,mx:2,ch:.2},{id:'wand_cosmic',mn:1,mx:1,ch:.02}]},demon:{n:'Demon',hp:2000,atk:180,def:55,xp:3000,spd:1200,sz:1.4,loot:[{id:'gold_coin',mn:200,mx:600,ch:1},{id:'demon_horn',mn:1,mx:2,ch:.3},{id:'demon_shield',mn:1,mx:1,ch:.02},{id:'magic_sword',mn:1,mx:1,ch:.01},{id:'boh',mn:1,mx:1,ch:.005}]},juggernaut:{n:'Juggernaut',hp:3000,atk:220,def:65,xp:5000,spd:1600,sz:1.5,loot:[{id:'gold_coin',mn:300,mx:800,ch:1},{id:'juggernaut_plate',mn:1,mx:1,ch:.15},{id:'demon_armor',mn:1,mx:1,ch:.01},{id:'blessed_shield',mn:1,mx:1,ch:.008}]},hellhound:{n:'Hellhound',hp:2500,atk:200,def:58,xp:4000,spd:1100,sz:1.3,loot:[{id:'gold_coin',mn:250,mx:700,ch:1},{id:'hellhound_fang',mn:1,mx:2,ch:.2},{id:'demon_legs',mn:1,mx:1,ch:.01}]},fire_sprite:{n:'Fire Sprite',hp:80,atk:18,def:8,spd:1400,xp:45,loot:[{id:'fire_essence',mn:1,mx:2,ch:0.4},{id:'gold_coin',mn:5,mx:15,ch:0.6}]},lava_golem:{n:'Lava Golem',hp:160,atk:30,def:14,spd:1600,xp:100,loot:[{id:'fire_essence',mn:1,mx:3,ch:0.5},{id:'gold_coin',mn:10,mx:30,ch:0.7},{id:'hp_pot',mn:1,mx:1,ch:0.3}]},fire_elemental:{n:'Fire Elemental',hp:280,atk:45,def:20,spd:1800,xp:200,loot:[{id:'fire_essence',mn:2,mx:4,ch:0.6},{id:'gold_coin',mn:20,mx:50,ch:0.8},{id:'mp_pot',mn:1,mx:1,ch:0.3}]},inferno_guardian:{n:'Inferno Guardian',hp:450,atk:65,def:28,spd:2000,xp:380,loot:[{id:'fire_essence',mn:3,mx:5,ch:0.7},{id:'gold_coin',mn:30,mx:80,ch:0.9},{id:'tower_key',mn:1,mx:1,ch:0.1}]},flame_lord:{n:'Flame Lord',hp:750,atk:90,def:38,spd:2200,xp:650,loot:[{id:'fire_essence',mn:4,mx:8,ch:0.9},{id:'dragon_scale',mn:1,mx:2,ch:0.5},{id:'gold_coin',mn:50,mx:150,ch:1.0},{id:'tower_key',mn:1,mx:1,ch:0.3}]},ice_sprite:{n:'Ice Sprite',hp:85,atk:16,def:10,spd:1300,xp:48,loot:[{id:'frozen_shard',mn:1,mx:2,ch:0.4},{id:'gold_coin',mn:5,mx:15,ch:0.6}]},frost_golem:{n:'Frost Golem',hp:170,atk:28,def:16,spd:1500,xp:110,loot:[{id:'frozen_shard',mn:1,mx:3,ch:0.5},{id:'gold_coin',mn:10,mx:30,ch:0.7},{id:'hp_pot',mn:1,mx:1,ch:0.3}]},blizzard_elemental:{n:'Blizzard Elemental',hp:300,atk:42,def:22,spd:1700,xp:220,loot:[{id:'frozen_shard',mn:2,mx:4,ch:0.6},{id:'gold_coin',mn:20,mx:50,ch:0.8},{id:'mp_pot',mn:1,mx:1,ch:0.3}]},glacier_guardian:{n:'Glacier Guardian',hp:480,atk:62,def:30,spd:1900,xp:400,loot:[{id:'frozen_shard',mn:3,mx:5,ch:0.7},{id:'gold_coin',mn:30,mx:80,ch:0.9},{id:'tower_key',mn:1,mx:1,ch:0.1}]},frost_wyrm:{n:'Frost Wyrm',hp:800,atk:85,def:40,spd:2100,xp:700,loot:[{id:'frozen_shard',mn:4,mx:8,ch:0.9},{id:'dragon_scale',mn:1,mx:2,ch:0.5},{id:'gold_coin',mn:50,mx:150,ch:1.0},{id:'tower_key',mn:1,mx:1,ch:0.3}]},swamp_toad:{n:'Swamp Toad',hp:90,atk:20,def:6,spd:1500,xp:50,loot:[{id:'toxic_gland',mn:1,mx:2,ch:0.4},{id:'gold_coin',mn:5,mx:15,ch:0.6}]},decay_crawler:{n:'Decay Crawler',hp:180,atk:32,def:12,spd:1700,xp:120,loot:[{id:'toxic_gland',mn:1,mx:3,ch:0.5},{id:'gold_coin',mn:10,mx:30,ch:0.7},{id:'hp_pot',mn:1,mx:1,ch:0.3}]},poison_beast:{n:'Poison Beast',hp:320,atk:48,def:18,spd:1900,xp:240,loot:[{id:'toxic_gland',mn:2,mx:4,ch:0.6},{id:'gold_coin',mn:20,mx:50,ch:0.8},{id:'mp_pot',mn:1,mx:1,ch:0.3}]},nature_wraith:{n:'Nature Wraith',hp:500,atk:68,def:26,spd:2100,xp:420,loot:[{id:'toxic_gland',mn:3,mx:5,ch:0.7},{id:'gold_coin',mn:30,mx:80,ch:0.9},{id:'tower_key',mn:1,mx:1,ch:0.1}]},swamp_hydra:{n:'Swamp Hydra',hp:850,atk:95,def:35,spd:2300,xp:750,loot:[{id:'toxic_gland',mn:4,mx:8,ch:0.9},{id:'dragon_scale',mn:1,mx:2,ch:0.5},{id:'gold_coin',mn:50,mx:150,ch:1.0},{id:'tower_key',mn:1,mx:1,ch:0.3}]},shadow_wisp:{n:'Shadow Wisp',hp:75,atk:22,def:5,spd:1200,xp:52,loot:[{id:'shadow_crystal',mn:1,mx:2,ch:0.4},{id:'gold_coin',mn:5,mx:15,ch:0.6}]},umbral_wraith:{n:'Umbral Wraith',hp:190,atk:35,def:14,spd:1400,xp:130,loot:[{id:'shadow_crystal',mn:1,mx:3,ch:0.5},{id:'gold_coin',mn:10,mx:30,ch:0.7},{id:'hp_pot',mn:1,mx:1,ch:0.3}]},void_stalker:{n:'Void Stalker',hp:340,atk:50,def:22,spd:1600,xp:260,loot:[{id:'shadow_crystal',mn:2,mx:4,ch:0.6},{id:'gold_coin',mn:20,mx:50,ch:0.8},{id:'mp_pot',mn:1,mx:1,ch:0.3}]},shadow_lord:{n:'Shadow Lord',hp:520,atk:72,def:32,spd:1800,xp:450,loot:[{id:'shadow_crystal',mn:3,mx:5,ch:0.7},{id:'gold_coin',mn:30,mx:80,ch:0.9},{id:'tower_key',mn:1,mx:1,ch:0.1}]},void_dragon:{n:'Void Dragon',hp:900,atk:100,def:42,spd:2000,xp:800,loot:[{id:'shadow_crystal',mn:4,mx:8,ch:0.9},{id:'dragon_scale',mn:1,mx:2,ch:0.5},{id:'gold_coin',mn:50,mx:150,ch:1.0},{id:'tower_key',mn:1,mx:1,ch:0.3}]},undead_dragon:{n:'Undead Dragon',hp:2800,atk:210,def:60,xp:4500,spd:1500,sz:1.4,loot:[{id:'gold_coin',mn:280,mx:750,ch:1},{id:'ancient_rune',mn:1,mx:1,ch:.1},{id:'demon_helmet',mn:1,mx:1,ch:.01},{id:'dragon_scale',mn:2,mx:5,ch:.5}]}};const VOCS={knight:{hp:185,mp:35,atk:14,def:10,hpL:15,mpL:5,aL:2.5,dL:2,out:{head:'#4a2020',body:'#cc3333',legs:'#aa2222',boots:'#3a1a1a'}},paladin:{hp:150,mp:60,atk:11,def:7,hpL:10,mpL:10,aL:1.8,dL:1.2,out:{head:'#2a4a2a',body:'#33aa44',legs:'#228833',boots:'#1a3a1a'}},mage:{hp:120,mp:100,atk:7,def:3,hpL:6,mpL:18,aL:1,dL:.5,out:{head:'#2a1a4a',body:'#7733cc',legs:'#5522aa',boots:'#1a1a3a'}}};const SPELLS=[{id:'exori',n:'Exori',d:'Basic strike',mana:10,cd:800,dmg:25,voc:['knight'],i:'&#128481;',lvl:1},{id:'exori_gran',n:'Exori Gran',d:'Great strike',mana:25,cd:1200,dmg:55,voc:['knight'],i:'&#128481;',lvl:5},{id:'exori_min',n:'Exori Min',d:'Quick strike',mana:15,cd:400,dmg:18,voc:['knight'],i:'&#128481;',lvl:3},{id:'utani_hur',n:'Utani Hur',d:'Haste buff',mana:40,cd:5000,buff:'spd',amt:50,dur:20000,voc:['knight','paladin'],i:'&#10024;',lvl:10},{id:'exura_ico',n:'Exura Ico',d:'Light heal',mana:30,cd:1500,heal:80,voc:['knight'],i:'&#10084;',lvl:6},{id:'utito_tempo',n:'Utito Tempo',d:'Attack buff',mana:35,cd:4000,buff:'atk',amt:30,dur:15000,voc:['knight'],i:'&#9876;',lvl:8},{id:'exori_con',n:'Exori Con',d:'Basic shot',mana:15,cd:900,dmg:30,rng:4,voc:['paladin'],i:'&#127993;',lvl:2},{id:'exori_san',n:'Exori San',d:'Strong shot',mana:30,cd:1300,dmg:60,rng:5,voc:['paladin'],i:'&#127993;',lvl:6},{id:'exevo_mas_san',n:'Exevo Mas San',d:'Arrow area',mana:50,cd:2000,dmg:80,rng:5,voc:['paladin'],i:'&#127993;',lvl:12},{id:'exura',n:'Exura',d:'Medium heal',mana:50,cd:2000,heal:150,voc:['paladin','mage'],i:'&#10084;',lvl:8},{id:'exori_tar',n:'Exori Tar',d:'Earth shot',mana:25,cd:1100,dmg:45,rng:6,voc:['paladin'],i:'&#127993;',lvl:5},{id:'exori_vis',n:'Exori Vis',d:'Basic energy',mana:20,cd:900,dmg:35,voc:['mage'],i:'&#10024;',lvl:3},{id:'exori_flam',n:'Exori Flam',d:'Basic fire',mana:25,cd:1000,dmg:40,voc:['mage'],i:'&#128293;',lvl:4},{id:'exori_mort',n:'Exori Mort',d:'Basic death',mana:30,cd:1200,dmg:50,voc:['mage'],i:'&#128128;',lvl:6},{id:'exevo_gran_vis',n:'Exevo Gran Vis',d:'Great energy',mana:60,cd:2000,dmg:100,voc:['mage'],i:'&#10024;',lvl:12},{id:'exura_vita',n:'Exura Vita',d:'Strong heal',mana:70,cd:2500,heal:200,voc:['mage'],i:'&#10084;',lvl:10},{id:'utamo_vita',n:'Utamo Vita',d:'Magic shield',mana:50,cd:4000,buff:'def',amt:40,dur:12000,voc:['mage'],i:'&#128737;',lvl:9},{id:'exori_tera',n:'Exori Tera',d:'Basic earth',mana:20,cd:900,dmg:35,voc:['mage'],i:'&#127793;',lvl:2},{id:'exori_frigo',n:'Exori Frigo',d:'Basic ice',mana:25,cd:1000,dmg:40,voc:['mage'],i:'&#10052;',lvl:4},{id:'exevo_gran_frigo',n:'Exevo Gran Frigo',d:'Great ice',mana:60,cd:2000,dmg:100,voc:['mage'],i:'&#10052;',lvl:12},{id:'exura_gran',n:'Exura Gran',d:'Great heal',mana:80,cd:2500,heal:250,voc:['mage'],i:'&#10084;',lvl:11},{id:'exura_sio',n:'Exura Sio',d:'Supreme heal',mana:100,cd:3000,heal:350,voc:['mage'],i:'&#10084;',lvl:14}];const QUEST_DEFS=[{id:'q_bugs',n:'Bug Squasher',d:'Kill 50 bugs',type:'kill',target:'bug',need:50,xp:80,gold:40,lvl:1},{id:'q_rats',n:'Rat Exterminator',d:'Kill 50 rats',type:'kill',target:'rat',need:50,xp:120,gold:60,lvl:1},{id:'q_deer',n:'Deer Hunter',d:'Kill 50 deer',type:'kill',target:'deer',need:50,xp:150,gold:75,lvl:2},{id:'q_snakes',n:'Snake Slayer',d:'Kill 50 snakes',type:'kill',target:'snake',need:50,xp:180,gold:90,lvl:2},{id:'q_poison_spiders',n:'Venomous Arachnids',d:'Kill 60 poison spiders',type:'kill',target:'poison_spider',need:60,xp:250,gold:120,lvl:3},{id:'q_boars',n:'Boar Hunter',d:'Kill 50 boars',type:'kill',target:'boar',need:50,xp:300,gold:150,lvl:4},{id:'q_wolves',n:'Wolf Pack Cleaner',d:'Kill 60 wolves',type:'kill',target:'wolf',need:60,xp:350,gold:180,lvl:5},{id:'q_wolf_paws',n:'Paw Collector',d:'Collect 10 wolf paws',type:'collect',target:'wolf_paw',need:10,xp:400,gold:200,lvl:5},{id:'q_bears',n:'Bear Slayer',d:'Kill 50 bears',type:'kill',target:'bear',need:50,xp:450,gold:230,lvl:6},{id:'q_scorpions',n:'Scorpion Stinger',d:'Kill 60 scorpions',type:'kill',target:'scorpion',need:60,xp:400,gold:200,lvl:6},{id:'q_rotworms',n:'Worm Crusher',d:'Kill 50 rotworms',type:'kill',target:'rotworm',need:50,xp:500,gold:250,lvl:7},{id:'q_trolls',n:'Troll Basher',d:'Kill 60 trolls',type:'kill',target:'troll',need:60,xp:600,gold:300,lvl:8},{id:'q_cave_rats',n:'Cave Rat Purge',d:'Kill 60 cave rats',type:'kill',target:'cave_rat',need:60,xp:550,gold:280,lvl:8},{id:'q_skeletons',n:'Bone Breaker',d:'Kill 80 skeletons',type:'kill',target:'skeleton',need:80,xp:700,gold:350,lvl:9},{id:'q_mummies',n:'Mummy Unwrapper',d:'Kill 60 mummies',type:'kill',target:'mummy',need:60,xp:900,gold:450,lvl:11},{id:'q_orcs',n:'Orc Exterminator',d:'Kill 80 orcs',type:'kill',target:'orc',need:80,xp:1000,gold:500,lvl:12},{id:'q_orc_warriors',n:'Orc Elite Slayer',d:'Kill 60 orc warriors',type:'kill',target:'orc_warrior',need:60,xp:1200,gold:600,lvl:13},{id:'q_spiders',n:'Giant Spider Hunter',d:'Kill 60 giant spiders',type:'kill',target:'giant_spider',need:60,xp:1100,gold:550,lvl:14},{id:'q_spider_silk',n:'Silk Collector',d:'Collect 15 spider silks',type:'collect',target:'spider_silk',need:15,xp:1200,gold:600,lvl:14},{id:'q_demon_skeletons',n:'Unholy Purge',d:'Kill 60 demon skeletons',type:'kill',target:'demon_skeleton',need:60,xp:1500,gold:750,lvl:16},{id:'q_minotaurs',n:'Labyrinth Cleaner',d:'Kill 60 minotaurs',type:'kill',target:'minotaur',need:60,xp:2000,gold:1000,lvl:18},{id:'q_horns',n:'Horn Collector',d:'Collect 10 minotaur horns',type:'collect',target:'minotaur_horn',need:10,xp:2200,gold:1100,lvl:19},{id:'q_cyclops',n:'Cyclops Crusher',d:'Kill 50 cyclopes',type:'kill',target:'cyclops',need:50,xp:2500,gold:1300,lvl:22},{id:'q_cyclops_eyes',n:'Eye Collector',d:'Collect 8 cyclops eyes',type:'collect',target:'cyclops_eye',need:8,xp:2700,gold:1400,lvl:23},{id:'q_lichs',n:'Lich Banisher',d:'Kill 50 liches',type:'kill',target:'lich',need:50,xp:3000,gold:1600,lvl:25},{id:'q_warlocks',n:'Warlock Silencer',d:'Kill 50 warlocks',type:'kill',target:'warlock',need:50,xp:3500,gold:1800,lvl:27},{id:'q_wyrms',n:'Wyrm Slayer',d:'Kill 50 wyrms',type:'kill',target:'wyrm',need:50,xp:4000,gold:2000,lvl:28},{id:'q_serpent_spawns',n:'Serpent Purge',d:'Kill 50 serpent spawns',type:'kill',target:'serpent_spawn',need:50,xp:4500,gold:2200,lvl:30},{id:'q_dragons',n:'Dragon Hunter',d:'Kill 50 dragons',type:'kill',target:'dragon',need:50,xp:5000,gold:2500,lvl:32},{id:'q_scales',n:'Scale Collector',d:'Collect 15 dragon scales',type:'collect',target:'dragon_scale',need:15,xp:5200,gold:2600,lvl:33},{id:'q_hydras',n:'Hydra Executioner',d:'Kill 50 hydras',type:'kill',target:'hydra',need:50,xp:6000,gold:3000,lvl:35},{id:'q_dragon_lords',n:'Lord Vanquisher',d:'Kill 50 dragon lords',type:'kill',target:'dragon_lord',need:50,xp:8000,gold:4000,lvl:38},{id:'q_hellhounds',n:'Hellhound Tamer',d:'Kill 60 hellhounds',type:'kill',target:'hellhound',need:60,xp:9000,gold:4500,lvl:40},{id:'q_demons',n:'Demon Banisher',d:'Kill 50 demons',type:'kill',target:'demon',need:50,xp:12000,gold:6000,lvl:45},{id:'q_undead_dragons',n:'Undead Doom',d:'Kill 30 undead dragons',type:'kill',target:'undead_dragon',need:30,xp:14000,gold:7000,lvl:48},{id:'q_juggernauts',n:'Supreme Destroyer',d:'Kill 20 juggernauts',type:'kill',target:'juggernaut',need:20,xp:18000,gold:10000,lvl:50},{id:'q_fire_sprites',n:'Inferno Initiate',d:'Kill 30 fire sprites',type:'kill',target:'fire_sprite',need:30,xp:2000,gold:800,lvl:10},{id:'q_lava_golems',n:'Lava Breaker',d:'Kill 25 lava golems',type:'kill',target:'lava_golem',need:25,xp:3500,gold:1200,lvl:12},{id:'q_fire_elementals',n:'Elemental Purge',d:'Kill 20 fire elementals',type:'kill',target:'fire_elemental',need:20,xp:5000,gold:1800,lvl:14},{id:'q_inferno_guardians',n:'Guardian Slayer',d:'Kill 15 inferno guardians',type:'kill',target:'inferno_guardian',need:15,xp:7000,gold:2500,lvl:16},{id:'q_flame_lords',n:'Lord of Flames',d:'Kill 10 flame lords',type:'kill',target:'flame_lord',need:10,xp:10000,gold:4000,lvl:18},{id:'q_ice_sprites',n:'Frost Hunter',d:'Kill 30 ice sprites',type:'kill',target:'ice_sprite',need:30,xp:2000,gold:800,lvl:10},{id:'q_frost_golems',n:'Ice Crusher',d:'Kill 25 frost golems',type:'kill',target:'frost_golem',need:25,xp:3500,gold:1200,lvl:12},{id:'q_blizzard_elementals',n:'Blizzard Tamer',d:'Kill 20 blizzard elementals',type:'kill',target:'blizzard_elemental',need:20,xp:5000,gold:1800,lvl:14},{id:'q_glacier_guardians',n:'Glacier Breaker',d:'Kill 15 glacier guardians',type:'kill',target:'glacier_guardian',need:15,xp:7000,gold:2500,lvl:16},{id:'q_frost_wyrms',n:'Wyrm Slayer',d:'Kill 10 frost wyrms',type:'kill',target:'frost_wyrm',need:10,xp:10000,gold:4000,lvl:18},{id:'q_swamp_toads',n:'Toad Stomper',d:'Kill 30 swamp toads',type:'kill',target:'swamp_toad',need:30,xp:2200,gold:900,lvl:10},{id:'q_decay_crawlers',n:'Crawler Exterminator',d:'Kill 25 decay crawlers',type:'kill',target:'decay_crawler',need:25,xp:3800,gold:1300,lvl:12},{id:'q_poison_beasts',n:'Beast Purifier',d:'Kill 20 poison beasts',type:'kill',target:'poison_beast',need:20,xp:5500,gold:2000,lvl:14},{id:'q_nature_wraiths',n:'Wraith Banisher',d:'Kill 15 nature wraiths',type:'kill',target:'nature_wraith',need:15,xp:7500,gold:2800,lvl:16},{id:'q_swamp_hydras',n:'Hydra Hunter',d:'Kill 10 swamp hydras',type:'kill',target:'swamp_hydra',need:10,xp:11000,gold:4500,lvl:18},{id:'q_shadow_wisps',n:'Wisp Collector',d:'Kill 30 shadow wisps',type:'kill',target:'shadow_wisp',need:30,xp:2500,gold:1000,lvl:10},{id:'q_umbral_wraiths',n:'Umbral Purge',d:'Kill 25 umbral wraiths',type:'kill',target:'umbral_wraith',need:25,xp:4000,gold:1400,lvl:12},{id:'q_void_stalkers',n:'Void Hunter',d:'Kill 20 void stalkers',type:'kill',target:'void_stalker',need:20,xp:6000,gold:2200,lvl:14},{id:'q_shadow_lords',n:'Lord of Shadows',d:'Kill 15 shadow lords',type:'kill',target:'shadow_lord',need:15,xp:8000,gold:3000,lvl:16},{id:'q_void_dragons',n:'Dragon of the Void',d:'Kill 10 void dragons',type:'kill',target:'void_dragon',need:10,xp:12000,gold:5000,lvl:18}];const ZONES={
  f0_north:{t:'forest',x:0,y:0,w:2000,h:350,c:[{id:'bug',n:200},{id:'rat',n:160},{id:'snake',n:140},{id:'poison_spider',n:100},{id:'deer',n:100}]},
  f0_east:{t:'plains',x:1300,y:350,w:700,h:500,c:[{id:'wolf',n:140},{id:'bear',n:80},{id:'boar',n:110},{id:'deer',n:70}]},
  f0_west:{t:'swamp',x:0,y:400,w:400,h:500,c:[{id:'snake',n:110},{id:'poison_spider',n:80},{id:'rotworm',n:70},{id:'scorpion',n:55}]},
  f0_south:{t:'desert',x:800,y:1100,w:1200,h:500,c:[{id:'scorpion',n:150},{id:'troll',n:110},{id:'snake',n:70},{id:'rotworm',n:55}]},
  f0_mountains:{t:'mountains',x:1600,y:300,w:400,h:500,c:[{id:'troll',n:110},{id:'bear',n:70},{id:'wolf',n:55}]},
  f0_savanna:{t:'savanna',x:400,y:900,w:600,h:400,c:[{id:'boar',n:100},{id:'wolf',n:70},{id:'scorpion',n:55},{id:'deer',n:40}]},
  f0_darkwoods:{t:'darkwoods',x:0,y:1000,w:400,h:600,c:[{id:'poison_spider',n:80},{id:'bear',n:55},{id:'snake',n:80},{id:'rotworm',n:55}]},
  f0_coast:{t:'coast',x:1400,y:900,w:600,h:700,c:[{id:'bug',n:110},{id:'rat',n:100},{id:'snake',n:70},{id:'deer',n:55}]},
  f1:{t:'cave',x:0,y:0,w:100,h:80,c:[{id:'cave_rat',n:20},{id:'skeleton',n:18},{id:'mummy',n:14},{id:'orc',n:16},{id:'orc_warrior',n:12}]},
  f2:{t:'spider_nest',x:0,y:0,w:100,h:80,c:[{id:'poison_spider',n:20},{id:'giant_spider',n:16},{id:'rotworm',n:14}]},
  f3:{t:'fortress',x:0,y:0,w:100,h:80,c:[{id:'minotaur',n:14},{id:'demon_skeleton',n:10},{id:'cyclops',n:8},{id:'orc_warrior',n:14}]},
  f4:{t:'orc_stronghold',x:0,y:0,w:100,h:80,c:[{id:'orc',n:18},{id:'orc_warrior',n:16},{id:'troll',n:10},{id:'cyclops',n:8}]},
  f5:{t:'dragon_cave',x:0,y:0,w:100,h:80,c:[{id:'wyrm',n:14},{id:'serpent_spawn',n:10},{id:'dragon',n:8},{id:'dragon_lord',n:5},{id:'hydra',n:7}]},
  f6:{t:'undead_crypt',x:0,y:0,w:100,h:80,c:[{id:'skeleton',n:16},{id:'mummy',n:12},{id:'demon_skeleton',n:10},{id:'lich',n:7}]},
  f7:{t:'demon_realm',x:0,y:0,w:100,h:80,c:[{id:'demon_skeleton',n:18},{id:'lich',n:15},{id:'warlock',n:12},{id:'demon',n:9}]},
  f8:{t:'hellfire',x:0,y:0,w:100,h:80,c:[{id:'demon',n:15},{id:'hellhound',n:12},{id:'warlock',n:9}]},
  f9:{t:'abyss',x:0,y:0,w:100,h:80,c:[{id:'demon',n:12},{id:'juggernaut',n:6},{id:'hellhound',n:9},{id:'undead_dragon',n:6}]}
};const STAIRS=[
  {fx:0,x:880,y:800,tx:1,dx:10,dy:10,dir:'down'},
  {fx:0,x:1500,y:550,tx:2,dx:10,dy:10,dir:'down'},
  {fx:0,x:300,y:1200,tx:6,dx:10,dy:10,dir:'down'},
  {fx:0,x:1800,y:400,tx:4,dx:10,dy:10,dir:'down'},
  {fx:1,x:10,y:10,tx:0,dx:880,dy:799,dir:'up'},
  {fx:1,x:60,y:55,tx:3,dx:10,dy:10,dir:'down'},
  {fx:2,x:10,y:10,tx:0,dx:1500,dy:549,dir:'up'},
  {fx:2,x:60,y:55,tx:3,dx:50,dy:10,dir:'down'},
  {fx:3,x:10,y:10,tx:1,dx:60,dy:54,dir:'up'},
  {fx:3,x:50,y:10,tx:2,dx:60,dy:54,dir:'up'},
  {fx:3,x:70,y:60,tx:5,dx:10,dy:10,dir:'down'},
  {fx:4,x:10,y:10,tx:0,dx:1800,dy:399,dir:'up'},
  {fx:4,x:60,y:55,tx:3,dx:80,dy:10,dir:'down'},
  {fx:5,x:10,y:10,tx:3,dx:70,dy:59,dir:'up'},
  {fx:5,x:60,y:50,tx:7,dx:10,dy:10,dir:'down'},
  {fx:6,x:10,y:10,tx:0,dx:300,dy:1199,dir:'up'},
  {fx:6,x:70,y:55,tx:7,dx:50,dy:10,dir:'down'},
  {fx:7,x:10,y:10,tx:5,dx:60,dy:49,dir:'up'},
  {fx:7,x:50,y:10,tx:6,dx:70,dy:54,dir:'up'},
  {fx:7,x:70,y:60,tx:8,dx:10,dy:10,dir:'down'},
  {fx:8,x:10,y:10,tx:7,dx:70,dy:59,dir:'up'},
  {fx:8,x:60,y:50,tx:9,dx:10,dy:10,dir:'down'},
  {fx:9,x:10,y:10,tx:8,dx:60,dy:49,dir:'up'},
  {fx:0,x:1000,y:800,tx:10,dx:10,dy:10,dir:'down'},
  {fx:10,x:10,y:10,tx:0,dx:1000,dy:799,dir:'up'},
  {fx:0,x:1700,y:350,tx:14,dx:10,dy:10,dir:'down'},
  {fx:14,x:10,y:10,tx:0,dx:1700,dy:351,dir:'up'},
  {fx:14,x:80,y:60,tx:15,dx:10,dy:10,dir:'down'},
  {fx:15,x:10,y:10,tx:14,dx:80,dy:60,dir:'up'},
  {fx:15,x:80,y:60,tx:16,dx:10,dy:10,dir:'down'},
  {fx:16,x:10,y:10,tx:15,dx:80,dy:60,dir:'up'},
  {fx:16,x:80,y:60,tx:17,dx:10,dy:10,dir:'down'},
  {fx:17,x:10,y:10,tx:16,dx:80,dy:60,dir:'up'},
  {fx:17,x:80,y:60,tx:18,dx:10,dy:10,dir:'down'},
  {fx:18,x:10,y:10,tx:17,dx:80,dy:60,dir:'up'},
  {fx:0,x:900,y:450,tx:19,dx:10,dy:10,dir:'down'},
  {fx:19,x:10,y:10,tx:0,dx:900,dy:451,dir:'up'},
  {fx:19,x:80,y:60,tx:20,dx:10,dy:10,dir:'down'},
  {fx:20,x:10,y:10,tx:19,dx:80,dy:60,dir:'up'},
  {fx:20,x:80,y:60,tx:21,dx:10,dy:10,dir:'down'},
  {fx:21,x:10,y:10,tx:20,dx:80,dy:60,dir:'up'},
  {fx:21,x:80,y:60,tx:22,dx:10,dy:10,dir:'down'},
  {fx:22,x:10,y:10,tx:21,dx:80,dy:60,dir:'up'},
  {fx:22,x:80,y:60,tx:23,dx:10,dy:10,dir:'down'},
  {fx:23,x:10,y:10,tx:22,dx:80,dy:60,dir:'up'},
  {fx:0,x:250,y:900,tx:24,dx:10,dy:10,dir:'down'},
  {fx:24,x:10,y:10,tx:0,dx:250,dy:901,dir:'up'},
  {fx:24,x:80,y:60,tx:25,dx:10,dy:10,dir:'down'},
  {fx:25,x:10,y:10,tx:24,dx:80,dy:60,dir:'up'},
  {fx:25,x:80,y:60,tx:26,dx:10,dy:10,dir:'down'},
  {fx:26,x:10,y:10,tx:25,dx:80,dy:60,dir:'up'},
  {fx:26,x:80,y:60,tx:27,dx:10,dy:10,dir:'down'},
  {fx:27,x:10,y:10,tx:26,dx:80,dy:60,dir:'up'},
  {fx:27,x:80,y:60,tx:28,dx:10,dy:10,dir:'down'},
  {fx:28,x:10,y:10,tx:27,dx:80,dy:60,dir:'up'},
  {fx:0,x:1600,y:1200,tx:29,dx:10,dy:10,dir:'down'},
  {fx:29,x:10,y:10,tx:0,dx:1600,dy:1201,dir:'up'},
  {fx:29,x:80,y:60,tx:30,dx:10,dy:10,dir:'down'},
  {fx:30,x:10,y:10,tx:29,dx:80,dy:60,dir:'up'},
  {fx:30,x:80,y:60,tx:31,dx:10,dy:10,dir:'down'},
  {fx:31,x:10,y:10,tx:30,dx:80,dy:60,dir:'up'},
  {fx:31,x:80,y:60,tx:32,dx:10,dy:10,dir:'down'},
  {fx:32,x:10,y:10,tx:31,dx:80,dy:60,dir:'up'},
  {fx:32,x:80,y:60,tx:33,dx:10,dy:10,dir:'down'},
  {fx:33,x:10,y:10,tx:32,dx:80,dy:60,dir:'up'}
];const FLOOR_INFO=[
  {name:'Surface',icon:'\u2600',cls:'f0',bg:'rgba(0,0,0,0.85)',col:'#4f4'},
  {name:'Underground -1',icon:'\u26CF',cls:'f1',bg:'rgba(30,15,0,0.9)',col:'#da6'},
  {name:'Spider Nest -2',icon:'\ud83d\udd77',cls:'f2',bg:'rgba(20,30,0,0.9)',col:'#8a4'},
  {name:'Fortress -3',icon:'\u2694',cls:'f3',bg:'rgba(50,0,0,0.9)',col:'#f44'},
  {name:'Orc Stronghold -4',icon:'\ud83d\udde1',cls:'f4',bg:'rgba(40,30,0,0.9)',col:'#a84'},
  {name:'Dragon Cave -5',icon:'\ud83d\udd25',cls:'f5',bg:'rgba(60,20,0,0.9)',col:'#f80'},
  {name:'Undead Crypt -6',icon:'\u2620',cls:'f6',bg:'rgba(20,0,30,0.9)',col:'#a4f'},
  {name:'Demon Realm -7',icon:'\u2622',cls:'f7',bg:'rgba(40,0,40,0.9)',col:'#c4f'},
  {name:'Hellfire -8',icon:'\ud83d\udd25',cls:'f8',bg:'rgba(60,0,0,0.95)',col:'#f40'},
  {name:'Abyss -9',icon:'\u2623',cls:'f9',bg:'rgba(0,0,0,0.95)',col:'#f00'},
  {name:'Premium Sanctuary',icon:'\u2B50',cls:'f10',bg:'rgba(60,40,0,0.9)',col:'#f0c040'},
  {name:'Dragon Lair \u2605',icon:'\uD83D\uDC09',cls:'f11',bg:'rgba(80,30,0,0.95)',col:'#f80'},
  {name:'Demon Pit \u2605',icon:'\uD83D\uDD25',cls:'f12',bg:'rgba(60,0,20,0.95)',col:'#f44'},
  {name:'Abyssal Core \u2605',icon:'\u2623',cls:'f13',bg:'rgba(20,0,40,0.95)',col:'#c4f'},
  {name:'Inferno Tower 1F',icon:'\uD83D\uDD25',cls:'f14',bg:'rgba(60,20,0,0.9)',col:'#f80'},
  {name:'Inferno Tower 2F',icon:'\uD83D\uDD25',cls:'f15',bg:'rgba(65,20,0,0.9)',col:'#f84'},
  {name:'Inferno Tower 3F',icon:'\uD83D\uDD25',cls:'f16',bg:'rgba(70,15,0,0.92)',col:'#f90'},
  {name:'Inferno Tower 4F',icon:'\uD83D\uDD25',cls:'f17',bg:'rgba(80,10,0,0.95)',col:'#fa0'},
  {name:'Flame Lord Peak',icon:'\uD83D\uDC09',cls:'f18',bg:'rgba(100,0,0,0.95)',col:'#f00'},
  {name:'Glacier Tower 1F',icon:'\u2744',cls:'f19',bg:'rgba(0,30,60,0.9)',col:'#48f'},
  {name:'Glacier Tower 2F',icon:'\u2744',cls:'f20',bg:'rgba(0,35,70,0.9)',col:'#5af'},
  {name:'Glacier Tower 3F',icon:'\u2744',cls:'f21',bg:'rgba(0,40,80,0.92)',col:'#6cf'},
  {name:'Glacier Tower 4F',icon:'\u2744',cls:'f22',bg:'rgba(0,50,90,0.95)',col:'#8ef'},
  {name:'Frost Wyrm Peak',icon:'\uD83D\uDC09',cls:'f23',bg:'rgba(0,60,100,0.95)',col:'#aff'},
  {name:'Swamp Tower 1F',icon:'\uD83C\uDF3F',cls:'f24',bg:'rgba(20,40,0,0.9)',col:'#6a4'},
  {name:'Swamp Tower 2F',icon:'\uD83C\uDF3F',cls:'f25',bg:'rgba(25,50,5,0.9)',col:'#7b5'},
  {name:'Swamp Tower 3F',icon:'\uD83C\uDF3F',cls:'f26',bg:'rgba(30,55,10,0.92)',col:'#8c6'},
  {name:'Swamp Tower 4F',icon:'\uD83C\uDF3F',cls:'f27',bg:'rgba(40,60,15,0.95)',col:'#9d7'},
  {name:'Swamp Hydra Peak',icon:'\uD83D\uDC09',cls:'f28',bg:'rgba(50,70,20,0.95)',col:'#ae8'},
  {name:'Shadow Tower 1F',icon:'\uD83D\uDC7B',cls:'f29',bg:'rgba(15,5,30,0.9)',col:'#a4f'},
  {name:'Shadow Tower 2F',icon:'\uD83D\uDC7B',cls:'f30',bg:'rgba(20,10,40,0.9)',col:'#b5f'},
  {name:'Shadow Tower 3F',icon:'\uD83D\uDC7B',cls:'f31',bg:'rgba(25,15,50,0.92)',col:'#c6f'},
  {name:'Shadow Tower 4F',icon:'\uD83D\uDC7B',cls:'f32',bg:'rgba(35,20,60,0.95)',col:'#d7f'},
  {name:'Void Dragon Peak',icon:'\uD83D\uDC09',cls:'f33',bg:'rgba(45,25,70,0.95)',col:'#e8f'}
];
const BLESSINGS=['Spiritual Shielding','Embrace of Tibia','Fire of the Suns','Spark of the Phoenix','Twist of Fate'];
const BLESSING_COST=10000;
function isPrem(){return G.player&&G.player.premium&&G.player.premium.active&&G.player.premium.expiry>Date.now();}
function checkPremExpiry(){if(!G.player||!G.player.premium)return;if(G.player.premium.active&&G.player.premium.expiry<=Date.now()){G.player.premium.active=false;msg('Your Premium Account has expired!','system');updPremInd();}}
function updPremInd(){const el=document.getElementById('prem-ind');if(!el)return;if(isPrem()){const days=Math.ceil((G.player.premium.expiry-Date.now())/(1000*60*60*24));el.className='active';el.textContent='PREMIUM ('+days+'d)';el.title='Premium Account - '+days+' days remaining';}else{el.className='free';el.textContent='FREE';el.title='Free Account';}}
function buyPremium(){const p=G.player;if(isPrem()){msg('You already have Premium Account!','system');return;}if(p.gold<50000){msg('Need 50,000 gold for Premium! You have '+p.gold+'g.','system');return;}const oldGold=p.gold,oldPrem=p.premium;p.gold-=50000;p.premium={active:true,expiry:Date.now()+30*24*60*60*1000,addr:typeof walletAddr!=='undefined'?walletAddr:''};msg('Premium Account activated for 30 days!','level');updPremInd();triggerSave();sendAction('buy_premium').then(r => { if(!r) { p.gold=oldGold; p.premium=oldPrem; updPremInd(); msg('Premium purchase failed - reverted','system'); } else { applyServerState(r); } });}
function openBlessShop(){if(!isPrem()){msg('Blessings require Premium Account!','system');return;}document.getElementById('bless-ov').style.display='flex';updBlessList();}
function updBlessList(){const c=document.getElementById('bless-list');if(!c)return;c.innerHTML='';BLESSINGS.forEach((b,i)=>{const owned=G.player.blessings&&G.player.blessings.includes(i);const d=document.createElement('div');d.className='bless-item'+(owned?' owned':'');d.innerHTML='<span class="bn">'+(owned?'&#10003; ':'')+b+'</span><span class="bp">'+BLESSING_COST+'g</span>'+(owned?'':'<button onclick="buyBlessing('+i+')">Buy</button>');c.appendChild(d);});}
function buyBlessing(idx){const p=G.player;if(!isPrem()){msg('Blessings require Premium Account!','system');return;}if(!p.blessings)p.blessings=[];if(p.blessings.includes(idx)){msg('You already have this blessing!','system');return;}if(p.gold<BLESSING_COST){msg('Not enough gold! Need '+BLESSING_COST+'g.','system');return;}const oldGold=p.gold;p.gold-=BLESSING_COST;p.blessings.push(idx);msg('Received blessing: '+BLESSINGS[idx]+'!','quest');updBlessList();triggerSave();sendAction('buy_blessing', {blessingIdx: idx}).then(r => { if(!r) { p.gold=oldGold; p.blessings.pop(); updBlessList(); msg('Blessing purchase failed - reverted','system'); } else { applyServerState(r); } });}
function openPremPanel(){document.getElementById('prem-ov').style.display='flex';const c=document.getElementById('prem-info');if(!c)return;if(isPrem()){const days=Math.ceil((G.player.premium.expiry-Date.now())/(1000*60*60*24));c.innerHTML='<div class="prem-info"><b>Status:</b> Active &#9733;</div><div class="prem-info"><b>Expires in:</b> '+days+' days</div><div class="prem-info"><b>Benefits:</b> Soft Boots, Blessings, Exclusive Areas, Premium Temple, Faster Regen, Bonus XP</div><button class="scl" onclick="document.getElementById(\'prem-ov\').style.display=\'none\'">Close</button>';}else{c.innerHTML='<div class="prem-info"><b>Status:</b> Free Account</div><div class="prem-info"><b>Cost:</b> 50,000 gold (30 days)</div><div class="prem-info"><b>Benefits:</b></div><div class="prem-info">&#9733; Soft Boots & Firewalker Boots</div><div class="prem-info">&#9733; Blessings System (reduce death penalty)</div><div class="prem-info">&#9733; Demon Realm, Hellfire & Abyss access</div><div class="prem-info">&#9733; Premium Sanctuary (exclusive temple)</div><div class="prem-info">&#9733; 50% faster HP/MP regen</div><div class="prem-info">&#9733; 15% bonus XP</div><button class="prem-buy" onclick="buyPremium();openPremPanel();">Buy Premium (50,000g)</button><button class="scl" onclick="document.getElementById(\'prem-ov\').style.display=\'none\'">Close</button>';}}
function tickSoftBoots(n){if(!G.player||!G.player.eq.boots)return;const bid=G.player.eq.boots;if(bid==='soft_boots'||bid==='firewalker_boots'){if(!G.player.softBootCharges||G.player.softBootCharges>14400)G.player.softBootCharges=14400;if(!G._sbLastTick)G._sbLastTick=n;if(n-G._sbLastTick>=2000){const ticks=Math.floor((n-G._sbLastTick)/2000);G._sbLastTick=n;G.player.softBootCharges=Math.max(0,G.player.softBootCharges-ticks);if(G.player.softBootCharges<=0){G.player.softBootCharges=0;G.player.eq.boots='worn_soft_boots';msg('Your '+ITEMS[bid].n+' have worn out!','system');updInv();}}}else{G._sbLastTick=0;}}
// PART C: GAME CLASSES & MAP GENERATION
// ========================================

// GAME STATE
const DEFAULT_HOTKEYS={spell1:'F1',spell2:'F2',spell3:'F3',spell4:'F4',spell5:'F5',spell6:'F6',spell7:'F7',spell8:'F8',hp_pot:'F9',mp_pot:'F10'};
function loadHotkeys(){try{const s=localStorage.getItem('megarealms_hotkeys');return s?{...DEFAULT_HOTKEYS,...JSON.parse(s)}:{...DEFAULT_HOTKEYS};}catch(e){return {...DEFAULT_HOTKEYS};}}
function saveHotkeys(){try{localStorage.setItem('megarealms_hotkeys',JSON.stringify(G.hotkeys));}catch(e){}}
// Vocation skill XP multipliers: higher = harder to level (more XP needed)
// Knight: best at melee/shielding, weak at magic/distance
// Paladin: best at distance, good at shielding, moderate melee, weak magic
// Mage: best at magic, weak at melee/distance/shielding
const VOC_SKILL_MULT={
  knight:{melee:1.0,distance:2.5,magic:3.0,shielding:1.0},
  paladin:{melee:1.8,distance:1.0,magic:2.0,shielding:1.2},
  mage:{melee:3.0,distance:3.0,magic:1.0,shielding:2.5}
};
function getSkillMult(voc,sk){return(VOC_SKILL_MULT[voc]&&VOC_SKILL_MULT[voc][sk])||1.5;}
let G={maps:[],floor:0,player:null,mons:[],npcs:[],bags:[],floats:[],msgs:[],
  target:null,lw:0,la:0,keys:{},tick:0,shop:0,mmap:1,cv:null,cx:null,
  quests:[],spellCDs:{},buffs:{},dayTime:0,kills:{},nightAlpha:0,otherPlayers:[],hotkeys:loadHotkeys(),mmZoom:1,autoPath:null,autoTarget:null,training:{active:false,itemIdx:-1,lastTick:0,dummy:null}};

// MAP GENERATION
function genMap(floor){
  const m=[];
  // Simple noise function
  function hash(x,y){let h=x*374761393+y*668265263;h=(h^(h>>13))*1274126177;return(h^(h>>16))&0x7fffffff;}
  function noise(x,y,s){const ix=Math.floor(x/s),iy=Math.floor(y/s),fx=x/s-ix,fy=y/s-iy;
    const sf=t=>(6*t*t*t*t*t-15*t*t*t*t+10*t*t*t);
    const sx=sf(fx),sy=sf(fy);
    const v00=hash(ix,iy)/0x7fffffff,v10=hash(ix+1,iy)/0x7fffffff,v01=hash(ix,iy+1)/0x7fffffff,v11=hash(ix+1,iy+1)/0x7fffffff;
    return v00*(1-sx)*(1-sy)+v10*sx*(1-sy)+v01*(1-sx)*sy+v11*sx*sy;
  }
  function fbm(x,y,s){return noise(x,y,s)*0.5+noise(x+100,y+100,s/2)*0.3+noise(x+200,y+200,s/4)*0.2;}

  let _fStairs=null;
  for(let y=0;y<(floor===0?MH:80);y++){m[y]=[];for(let x=0;x<(floor===0?MW:100);x++){
    let t=TT.G;
    if(floor===0){
      const e=fbm(x,y,80);const m2=fbm(x+500,y+500,60);const t2=fbm(x+1000,y+1000,40);
      const lat=y/MH;const lon=x/MW;
      // Base terrain from elevation
      if(e<0.25)t=TT.W; // water
      else if(e<0.32){t=TT.SA;if(Math.random()<0.02)t=TT.TR;} // beaches
      else if(e>0.8){t=TT.MT;if(Math.random()<0.15)t=TT.G;} // mountains
      else if(e>0.7&&m2>0.5)t=TT.MT; // rocky hills
      else{
        // Biome selection based on position + noise
        if(lat<0.25){// Northern forest - scattered trees
          t=TT.G;if(t2>0.78)t=TT.TR;else if(m2>0.7)t=TT.D;
        }else if(lat>0.7&&lon>0.4){// Southern desert - open
          t=m2>0.6?TT.SA:TT.D;if(Math.random()<0.02)t=TT.MT;
        }else if(lon<0.2&&lat>0.25&&lat<0.7){// Western swamp - some trees
          t=TT.SWAMP;if(t2>0.65)t=TT.W;else if(t2<0.15)t=TT.TR;else if(t2<0.35)t=TT.G;
        }else if(lon>0.8&&lat>0.2&&lat<0.55){// Eastern mountains
          t=e>0.55?TT.MT:TT.G;if(Math.random()<0.03)t=TT.TR;
        }else if(lat>0.55&&lon<0.25){// Dark woods - moderate trees
          t=TT.G;if(t2>0.68)t=TT.TR;if(m2>0.7)t=TT.SWAMP;
        }else if(lat>0.4&&lat<0.7&&lon>0.2&&lon<0.5){// Savanna - very open
          t=TT.G;if(t2>0.82)t=TT.TR;if(Math.random()<0.08)t=TT.D;
        }else if(lon>0.7&&lat>0.55){// Coastal - open
          t=TT.SA;if(e>0.45)t=TT.G;if(t2>0.82)t=TT.TR;
        }else if(lat>0.3&&lat<0.55&&lon>0.35&&lon<0.6){// Ice region
          t=TT.IC;if(t2>0.5)t=TT.G;if(e>0.65)t=TT.MT;
        }else{// General plains - mostly open with tree clusters
          t=TT.G;if(t2>0.78)t=TT.TR;else if(m2>0.65)t=TT.D;
        }
      }
      // Rivers using sine curves
      for(let r=0;r<3;r++){
        const rx=r===0?1000:r===1?500:1500;
        const ry=Math.floor(Math.sin(x/120+r*2)*80+400+r*400);
        if(Math.abs(y-ry)<3)t=TT.W;
        if(Math.abs(y-ry)<1&&x%80<3)t=TT.BRIDGE;
      }
      // Town center (800-1100, 700-900)
      if(x>=800&&x<=1100&&y>=700&&y<=900){
        t=TT.FL;
        if(x===800||x===1100||y===700||y===900)t=TT.WL;
        if((x===950&&y===700)||(x===950&&y===900)||(x===800&&y===800)||(x===1100&&y===800))t=TT.DR;
        if(x>=920&&x<=980&&y>=770&&y<=830)t=TT.TM;
        // Houses
        const hx=(x-800)%40,hy=(y-700)%40;
        if(x>=810&&x<=850&&y>=710&&y<=740){t=TT.FL;if(x===810||x===850||y===710||y===740)t=TT.WL;if(x===830&&y===740)t=TT.DR;}
        if(x>=860&&x<=900&&y>=710&&y<=740){t=TT.FL;if(x===860||x===900||y===710||y===740)t=TT.WL;if(x===880&&y===740)t=TT.DR;}
        if(x>=1010&&x<=1050&&y>=710&&y<=740){t=TT.FL;if(x===1010||x===1050||y===710||y===740)t=TT.WL;if(x===1030&&y===740)t=TT.DR;}
        if(x>=1010&&x<=1050&&y>=860&&y<=890){t=TT.FL;if(x===1010||x===1050||y===860||y===890)t=TT.WL;if(x===1030&&y===860)t=TT.DR;}
        if(x>=810&&x<=850&&y>=860&&y<=890){t=TT.FL;if(x===810||x===850||y===860||y===890)t=TT.WL;if(x===830&&y===860)t=TT.DR;}
      }
      // Farm near town
      if(x>=870&&x<=930&&y>=660&&y<=695)t=TT.FARM;
      // Roads from town - main N/S and E/W roads (wide)
      if((Math.abs(x-950)<4&&(y<700||y>900)&&y>50&&y<1550)||
         (Math.abs(y-800)<4&&(x<800||x>1100)&&x>50&&x<1950))t=TT.D;
      // Additional road N/S at x‚âà400 connecting spawn area
      if(Math.abs(x-400)<3&&y>30&&y<850)t=TT.D;
      // Road connecting x400 road to main E/W road
      if(Math.abs(y-500)<3&&x>380&&x<960)t=TT.D;
      // NE diagonal road from town
      {const dx=x-1100,dy=y-700;if(dx>0&&dy<0&&dx<500&&Math.abs(dx+dy)<5)t=TT.D;}
      // NW diagonal road from town
      {const dx=x-800,dy=y-700;if(dx<0&&dy<0&&dx>-500&&Math.abs(-dx+dy+0)<5)t=TT.D;}
      // SE diagonal road
      {const dx=x-1100,dy=y-900;if(dx>0&&dy>0&&dx<400&&Math.abs(dx-dy)<5)t=TT.D;}
      // SW diagonal road
      {const dx=x-800,dy=y-900;if(dx<0&&dy>0&&Math.abs(dx)< 400&&Math.abs(dx+dy)<5)t=TT.D;}
      // Dungeon entrances
      const stairs=[[880,800],[1500,550],[300,1200],[1800,400]];
      stairs.forEach(s=>{if(x===s[0]&&y===s[1])t=TT.SD;});
      // Tower footprints (7x7 structures)
      const towers=[[1700,350],[900,450],[250,900],[1600,1200]];
      towers.forEach(tc=>{const dx=x-tc[0]+3,dy=y-tc[1]+3;if(dx>=0&&dx<7&&dy>=0&&dy<7){if((dx===0||dx===6||dy===0||dy===6)&&!(dx===3&&(dy===0||dy===6)))t=TT.WL;else if(dx===3&&dy===3)t=TT.SD;else t=TT.FL;}});
    }
    else if(floor===10){
      // Premium Sanctuary: lit temple - open floor with golden walls
      t=TT.FL;
      // Outer walls
      if(x===0||x===99||y===0||y===79)t=TT.WL;
      // Central chamber walls
      if((x===15||x===85)&&y>=10&&y<=70)t=TT.WL;
      if((y===10||y===70)&&x>=15&&x<=85)t=TT.WL;
      // Doors in chamber walls
      if(x===15&&(y===30||y===50))t=TT.DR;
      if(x===85&&(y===30||y===50))t=TT.DR;
      if(y===10&&(x===50))t=TT.DR;
      if(y===70&&(x===50))t=TT.DR;
      // Inner temple area (golden floor)
      if(x>=16&&x<=84&&y>=11&&y<=69)t=TT.TM;
      // Portal platforms (raised areas for the 3 portals)
      if(x>=35&&x<=45&&y>=45&&y<=55)t=TT.FL;
      if(x>=55&&x<=65&&y>=45&&y<=55)t=TT.FL;
      if(x>=75&&x<=85&&y>=45&&y<=55)t=TT.FL;
      // Shop house (small building for merchants)
      if(x>=20&&x<=30&&y>=32&&y<=40){
        t=TT.FL;
        if(x===20||x===30||y===32||y===40)t=TT.WL;
        if(x===25&&y===40)t=TT.DR;
      }
      // Water decorations (fountains)
      if((x===30||x===70)&&(y===30||y===40)){if(Math.abs(x-30)<2||Math.abs(x-70)<2)t=TT.W;}
      // Entrance area
      if(x>=8&&x<=12&&y>=8&&y<=12)t=TT.FL;
    }
    else if(floor>=14&&floor<=33){
      // Tower floors
      const towerIdx=Math.floor((floor-14)/5);
      const towerFloor=(floor-14)%5;
      t=TT.FL;
      if(x===0||x===99||y===0||y===79)t=TT.WL;
      if((x===25||x===50||x===75)&&(y===20||y===40||y===60)&&towerFloor>=1)t=TT.WL;
      if(towerFloor>=2&&((x===40&&y>=15&&y<=35)||(x===60&&y>=45&&y<=65)))t=TT.WL;
      if(towerFloor>=3&&((y===30&&x>=20&&x<=45)||(y===50&&x>=55&&x<=80)))t=TT.WL;
      if(towerFloor>=2&&x===40&&y===25)t=TT.DR;
      if(towerFloor>=2&&x===60&&y===55)t=TT.DR;
      if(towerFloor>=3&&y===30&&x===32)t=TT.DR;
      if(towerFloor>=3&&y===50&&x===68)t=TT.DR;
      const nv=noise(x+floor*1000,y+floor*1000,12);
      if(towerIdx===0&&nv>0.72)t=TT.LV;
      if(towerIdx===1&&nv>0.72)t=TT.IC;
      if(towerIdx===2&&nv>0.72)t=TT.SWAMP;
      if(towerIdx===3&&nv>0.72)t=TT.CW;
      const _tStairs=STAIRS.filter(s=>s.fx===floor);
      _tStairs.forEach(s=>{const dx2=Math.abs(x-s.x),dy2=Math.abs(y-s.y);if(dx2<=3&&dy2<=3)t=TT.FL;});
      _tStairs.forEach(s=>{if(x===s.x&&y===s.y){t=s.tx<s.fx?TT.SU:TT.SD;}});
      const _tArrivals=STAIRS.filter(s=>s.tx===floor);
      _tArrivals.forEach(s=>{const dx2=Math.abs(x-s.dx),dy2=Math.abs(y-s.dy);if(dx2<=3&&dy2<=3)t=TT.FL;});
      _tArrivals.forEach(s=>{if(x===s.dx&&y===s.dy){t=s.fx<s.tx?TT.SD:TT.SU;}});
    }
    else{
      // Underground floors (1-9, 11+): cave generation
      t=TT.CW;
      const cv=noise(x+floor*1000,y+floor*1000,8);
      const cv2=noise(x+floor*2000,y+floor*2000,12);
      const cft=(floor>=3&&floor<=5)?TT.FL:TT.CV;
      // Organic cave shapes using noise - very open caves
      if(cv>0.25||cv2>0.35){
        t=cft;
        if(floor>=7&&Math.random()<0.12)t=TT.LV;
        if(floor>=8&&Math.random()<0.18)t=TT.LV;
      }
      // Premium hunting floors (11-13): central spawn clearing for portal arrival
      if(floor>=11&&floor<=13){const sdx=Math.abs(x-50),sdy=Math.abs(y-40);if(sdx<=6&&sdy<=6)t=cft;}
      // Dense corridor grid every 15 tiles
      for(let cy=10;cy<=70;cy+=15){if(y>=cy-2&&y<=cy+2&&x>=2&&x<=95)t=cft;}
      for(let cx=10;cx<=90;cx+=15){if(x>=cx-2&&x<=cx+2&&y>=2&&y<=75)t=cft;}
      // Stairs: 11x11 clearing + direct corridors between ALL stair pairs
      if(!_fStairs)_fStairs=STAIRS.filter(s=>s.fx===floor);
      _fStairs.forEach(s=>{
        const dx2=Math.abs(x-s.x),dy2=Math.abs(y-s.y);
        if(dx2<=5&&dy2<=5)t=cft;
      });
      // Direct L-shaped corridors between every pair of stairs
      for(let i=0;i<_fStairs.length;i++){for(let j=i+1;j<_fStairs.length;j++){
        const a=_fStairs[i],b=_fStairs[j];
        const xMn=Math.min(a.x,b.x),xMx=Math.max(a.x,b.x);
        const yMn=Math.min(a.y,b.y),yMx=Math.max(a.y,b.y);
        if(x>=xMn&&x<=xMx&&Math.abs(y-a.y)<=2)t=cft;
        if(Math.abs(x-b.x)<=2&&y>=yMn&&y<=yMx)t=cft;
      }}
      // Re-apply stair tiles AFTER corridors so they don't get overwritten
      _fStairs.forEach(s=>{if(x===s.x&&y===s.y)t=s.dir==='up'?TT.SU:TT.SD;});
    }
    m[y][x]=t;
  }}
  // Post-process underground floors: flood-fill to eliminate disconnected pockets
  if(floor>=1&&floor!==10&&!(floor>=14&&floor<=33)){
    const W=m[0].length,H=m.length;
    const walkable=new Set([TT.CV,TT.FL,TT.SU,TT.SD,TT.LV,TT.IC,TT.DR]);
    const cft2=(floor>=3&&floor<=5)?TT.FL:TT.CV;
    // Seed BFS from ALL stairs AND their destination positions
    const fSt=STAIRS.filter(s=>s.fx===floor);
    // Also find stairs that ARRIVE on this floor (destination positions)
    const arrivals=STAIRS.filter(s=>s.tx===floor);
    // For premium hunting floors with no stairs, add portal spawn as seed
    if(fSt.length===0&&floor>=11&&floor<=13){fSt.push({x:50,y:40,dir:'up'});arrivals.push({dx:50,dy:40});}
    if(fSt.length>0){
      // First ensure all stairs & arrivals are connected by carving corridors
      const allPts=[...fSt.map(s=>({x:s.x,y:s.y})),...arrivals.map(s=>({x:s.dx,y:s.dy}))];
      for(let i=0;i<allPts.length;i++){for(let j=i+1;j<allPts.length;j++){
        const a=allPts[i],b=allPts[j];
        // Carve L-shaped corridor between a and b
        const xd=b.x>a.x?1:-1,yd=b.y>a.y?1:-1;
        for(let cx=a.x;cx!==b.x;cx+=xd){
          for(let d=-1;d<=1;d++){const ny=a.y+d;if(ny>=0&&ny<H&&m[ny][cx]===TT.CW)m[ny][cx]=cft2;}
        }
        for(let cy=a.y;cy!==b.y;cy+=yd){
          for(let d=-1;d<=1;d++){const nx=b.x+d;if(nx>=0&&nx<W&&m[cy][nx]===TT.CW)m[cy][nx]=cft2;}
        }
      }}
      // BFS from first stair
      const reached=new Set();
      const q=[{x:fSt[0].x,y:fSt[0].y}];let qi2=0;
      reached.add(fSt[0].y*W+fSt[0].x);
      while(qi2<q.length){
        const c=q[qi2++];
        for(const[dx,dy]of[[0,-1],[1,0],[0,1],[-1,0]]){
          const nx=c.x+dx,ny=c.y+dy;
          if(nx<0||ny<0||nx>=W||ny>=H)continue;
          const k=ny*W+nx;
          if(reached.has(k))continue;
          if(!walkable.has(m[ny][nx]))continue;
          reached.add(k);q.push({x:nx,y:ny});
        }
      }
      // Convert all unreachable walkable tiles to walls
      for(let y2=0;y2<H;y2++){
        for(let x2=0;x2<W;x2++){
          if(walkable.has(m[y2][x2])&&!reached.has(y2*W+x2)){
            m[y2][x2]=TT.CW;
          }
        }
      }
    }
  }
  return m;
}

// PLAYER CLASS
class Player{
  constructor(n,v){
    const vc=VOCS[v];
    this.name=n;this.voc=v;this.x=950;this.y=800;this.dir=2;
    this.lv=1;this.xp=0;this.mhp=vc.hp;this.hp=vc.hp;this.mmp=vc.mp;this.mp=vc.mp;
    this.batk=vc.atk;this.bdef=vc.def;this.gold=100000;
    this.inv=[];this.eq={helmet:null,armor:null,weapon:null,shield:null,legs:null,boots:null,amulet:null,ring:null};
    this.out=vc.out;this.lr=0;
    this.skills={melee:10,distance:10,magic:0,shielding:10};
    this.skillXp={melee:0,distance:0,magic:0,shielding:0};
    this.spells=[];this.premium={active:false,expiry:0,addr:''};this.blessings=[];this.softBootCharges=0;this.premium={active:false,expiry:0,addr:''};this.blessings=[];this.softBootCharges=0;
    this.inv.push({id:'hp_pot',q:10},{id:'mp_pot',q:5},{id:'club',q:1},{id:'leather',q:1},{id:'leather_legs',q:1},{id:'sandals',q:1});
    for(const sp of SPELLS){if(sp.voc.includes(v)&&sp.lvl<=1)this.spells.push(sp.id);}
  }
  get atk(){let a=this.batk;const w=this.eq.weapon;if(w){a+=(ITEMS[w].atk||0);const sk=ITEMS[w].sk;if(sk&&this.skills[sk])a+=Math.floor(this.skills[sk]/5);}if(G.buffs.atk_boost&&performance.now()<G.buffs.atk_boost)a=Math.floor(a*1.3);return a;}
  get matk(){let m=0;const w=this.eq.weapon;if(w)m+=(ITEMS[w].matk||0);m+=Math.floor(this.skills.magic/3);return m;}
  get def(){let d=this.bdef;['helmet','armor','shield','legs','boots','amulet','ring'].forEach(s=>{const e=this.eq[s];if(e)d+=(ITEMS[e].def||0);});d+=Math.floor(this.skills.shielding/5);if(G.buffs.mshield&&performance.now()<G.buffs.mshield)d=Math.floor(d*1.5);return d;}
  get speed(){if(this.name==='Mike Kina')return 20;let s=Math.max(60,WCOOL-Math.floor(this.lv*1.5));if(this.eq.boots){const b=ITEMS[this.eq.boots];if(b.spd)s+=b.spd;}if(G.buffs.haste&&performance.now()<G.buffs.haste)s=Math.floor(s*0.5);return Math.max(60,s);}
  xpN(){return Math.floor(50*Math.pow(this.lv,2.2));}
  lvUp(){while(this.xp>=this.xpN()){this.xp-=this.xpN();this.lv++;const v=VOCS[this.voc];this.mhp+=v.hpL;this.mmp+=v.mpL;this.batk+=v.aL;this.bdef+=v.dL;this.hp=this.mhp;this.mp=this.mmp;msg(` LEVEL UP! Level ${this.lv}!`,'level');
    for(const sp of SPELLS){if(sp.voc.includes(this.voc)&&sp.lvl<=this.lv&&!this.spells.includes(sp.id)){this.spells.push(sp.id);msg(` New spell: ${sp.n}!`,'spell');}}
    if(typeof triggerSave==='function')triggerSave();
  }}
  regen(n){const premRegen=isPrem()?1500:3000;if(n-this.lr<premRegen)return;this.lr=n;if(this.hp<this.mhp)this.hp=Math.min(this.mhp,Math.floor(this.hp+Math.max(1,this.mhp*(isPrem()?.04:.02))));if(this.mp<this.mmp)this.mp=Math.min(this.mmp,Math.floor(this.mp+Math.max(1,this.mmp*(isPrem()?.06:.03))));}
  addItem(id,q=1){const d=ITEMS[id];if(!d)return 0;if(id==='gold_coin'){this.gold=Math.min(this.gold+q,99999999);return 1;}if(d.stk){const e=this.inv.find(i=>i.id===id);if(e){e.q=Math.min(e.q+q,9999);return 1;}}if(this.inv.length>=30)return 0;this.inv.push({id,q});return 1;}
  rmItem(idx,q=1){const it=this.inv[idx];if(!it)return;it.q=Math.max(0,it.q-q);if(it.q<=0)this.inv.splice(idx,1);}
}

// MONSTER CLASS
class Mon{
  constructor(t,x,y){this.t=t;this.x=x;this.y=y;this.alive=true;this.hp=MONS[t].hp;this.rt=0;this.la=0;this.lm=0;this.dir=2;this.spawnAnim=0;}
  respawnTime(){
    const base=MONS[this.t].hp;
    // Tower monsters respawn faster (floors 14-33)
    if(G.floor>=14&&G.floor<=33){
      if(base<=100)return 8000+Math.random()*5000;
      if(base<=200)return 10000+Math.random()*8000;
      if(base<=400)return 15000+Math.random()*10000;
      if(base<=600)return 20000+Math.random()*15000;
      return 25000+Math.random()*15000;
    }
    if(base<=30)return 10000+Math.random()*8000;
    if(base<=60)return 15000+Math.random()*10000;
    if(base<=130)return 20000+Math.random()*15000;
    if(base<=350)return 30000+Math.random()*20000;
    if(base<=1200)return 45000+Math.random()*30000;
    return 60000+Math.random()*60000;
  }
  update(n){
    if(!this.alive){if(this.rt&&n>this.rt){this.alive=true;this.hp=MONS[this.t].hp;this.spawnAnim=n;
      if(!G._zoneCache||G._zoneCacheFloor!==G.floor){G._zoneCache=getFloorZones(G.floor);G._zoneCacheFloor=G.floor;}
      const z=G._zoneCache.find(zn=>zn.c.some(cr=>cr.id===this.t));
      if(z){let x,y,tr=0;do{x=z.x+Math.floor(Math.random()*z.w);y=z.y+Math.floor(Math.random()*z.h);tr++;}while((!canW(x,y)||monAt(x,y))&&tr<20);if(tr<20){this.x=x;this.y=y;}}
    }return;}
    const p=G.player;if(!p)return;
    const dx=Math.abs(p.x-this.x),dy=Math.abs(p.y-this.y),dist=Math.max(dx,dy);
    const M=MONS[this.t];
    if(dist<=1&&n-this.la>M.spd){
      this.la=n;let dmg=Math.floor(M.atk-p.def/2);dmg=Math.max(1,dmg+Math.floor(Math.random()*3-1));
      p.hp-=dmg;floatText(p.x,p.y,'-'+dmg,'#f44');
      if(p.hp<=0){p.hp=0;stopTraining('You died');const bc=p.blessings?p.blessings.length:0;const xl=bc>=5?'2%':bc>=3?'5%':'10%';const dm=document.getElementById('death-msg');if(dm){let dt='Lost '+xl+' of XP.';const hasAoL=p.eq.amulet&&ITEMS[p.eq.amulet]&&ITEMS[p.eq.amulet].onDeath==='prevent_loss';if(bc===0&&!hasAoL)dt+=' Without blessings, you will lose an equipped item!';else if(bc===0&&hasAoL)dt+=' Your Amulet of Loss will protect your equipment!';dm.textContent=dt;}document.getElementById('death-ov').style.display='flex';}
      p.skillXp.shielding+=1;const shMult=getSkillMult(p.voc,'shielding');if(p.skillXp.shielding>=Math.floor(p.skills.shielding*8*shMult)){p.skillXp.shielding=0;p.skills.shielding++;msg(`Shielding increased to ${p.skills.shielding}!`,'level');updSkills();}
    }else if(dist<=10&&n-this.lm>M.spd){
      this.lm=n;
      let mx=0,my=0,moved=false;
      if(dist<=3){
        // Close to player: find best open tile adjacent to player and move toward it
        const d8=[[0,-1],[-1,-1],[-1,0],[-1,1],[0,1],[1,1],[1,0],[1,-1]];
        let btx=-1,bty=-1,bd=999;
        for(const[ax,ay]of d8){
          const tx=p.x+ax,ty=p.y+ay;
          if(!canW(tx,ty))continue;
          if(tx===this.x&&ty===this.y){btx=tx;bty=ty;bd=0;break;}
          if(monAt(tx,ty))continue;
          const md=Math.max(Math.abs(tx-this.x),Math.abs(ty-this.y));
          if(md<bd){bd=md;btx=tx;bty=ty;}
        }
        if(bd>0&&btx>=0){
          mx=0;my=0;
          if(btx>this.x)mx=1;else if(btx<this.x)mx=-1;
          if(bty>this.y)my=1;else if(bty<this.y)my=-1;
          if(mx&&my){
            let nx=this.x+mx,ny=this.y+my;
            if(canW(nx,ny)&&!monAt(nx,ny)&&!(nx===p.x&&ny===p.y)){this.x=nx;this.y=ny;moved=true;}
            else if(canW(this.x+mx,this.y)&&!monAt(this.x+mx,this.y)&&!(this.x+mx===p.x&&this.y===p.y)){this.x+=mx;moved=true;}
            else if(canW(this.x,this.y+my)&&!monAt(this.x,this.y+my)&&!(this.x===p.x&&this.y+my===p.y)){this.y+=my;moved=true;}
          }else if(mx||my){
            let nx=this.x+mx,ny=this.y+my;
            if(canW(nx,ny)&&!monAt(nx,ny)&&!(nx===p.x&&ny===p.y)){this.x=nx;this.y=ny;moved=true;}
          }
        }else if(bd===0){moved=true;}
      }
      if(!moved){
        mx=0;my=0;
        if(p.x>this.x)mx=1;else if(p.x<this.x)mx=-1;
        if(p.y>this.y)my=1;else if(p.y<this.y)my=-1;
        if(mx&&my){
          const nx=this.x+mx,ny=this.y+my;
          if(canW(nx,ny)&&!monAt(nx,ny)&&!(nx===p.x&&ny===p.y)){this.x=nx;this.y=ny;}
          else if(canW(this.x+mx,this.y)&&!monAt(this.x+mx,this.y)&&!(this.x+mx===p.x&&this.y===p.y)){this.x+=mx;}
          else if(canW(this.x,this.y+my)&&!monAt(this.x,this.y+my)&&!(this.x===p.x&&this.y+my===p.y)){this.y+=my;}
        }else{
          const nx=this.x+mx,ny=this.y+my;
          if(canW(nx,ny)&&!monAt(nx,ny)&&!(nx===p.x&&ny===p.y)){this.x=nx;this.y=ny;}
        }
      }
      if(p.x>this.x)this.dir=3;else if(p.x<this.x)this.dir=1;else if(p.y>this.y)this.dir=2;else if(p.y<this.y)this.dir=0;
    }else if(dist>10&&n-this.lm>M.spd*2){
      this.lm=n;if(Math.random()<.2){
        const d=Math.floor(Math.random()*8);const dx2=[0,-1,-1,-1,0,1,1,1][d],dy2=[-1,-1,0,1,1,1,0,-1][d];
        const nx=this.x+dx2,ny=this.y+dy2;if(canW(nx,ny)&&!monAt(nx,ny)&&!(p&&nx===p.x&&ny===p.y)){this.x=nx;this.y=ny;if(dx2===1)this.dir=3;else if(dx2===-1)this.dir=1;else if(dy2===1)this.dir=2;else if(dy2===-1)this.dir=0;}
      }
    }
  }
}

// NPC CLASS
class NPC{constructor(name,x,y,items,type,quests){this.name=name;this.x=x;this.y=y;this.items=items||[];this.type=type||'shop';this.quests=quests||[];}}

// HELPER FUNCTIONS
function canW(x,y){if(x<0||y<0||x>=MW||y>=MH)return false;return WALK.has(G.maps[G.floor][y][x]);}
let _monGrid={};function rebuildMonGrid(){_monGrid={};for(let i=0;i<G.mons.length;i++){const m=G.mons[i];if(m.alive)_monGrid[m.x+','+m.y]=m;}}function monAt(x,y){return _monGrid[x+','+y]||null;}
function npcAt(x,y){return G.npcs.find(n=>n.x===x&&n.y===y);}
function findPath(sx,sy,gx,gy){
  if(!canW(gx,gy)||(sx===gx&&sy===gy))return null;
  const dirs=[[0,-1],[1,0],[0,1],[-1,0]];
  const key=(x,y)=>x+','+y;
  const visited=new Set();visited.add(key(sx,sy));
  const parent=new Map();
  const queue=[{x:sx,y:sy}];let qi=0;let found=false;
  while(qi<queue.length&&qi<8000){
    const c=queue[qi++];
    if(c.x===gx&&c.y===gy){found=true;break;}
    for(const[dx,dy]of dirs){
      const nx=c.x+dx,ny=c.y+dy;const k=key(nx,ny);
      if(visited.has(k))continue;
      if(!canW(nx,ny))continue;
      visited.add(k);parent.set(k,{x:c.x,y:c.y});
      queue.push({x:nx,y:ny});
    }
  }
  if(!found)return null;
  const path=[];let cur={x:gx,y:gy};
  while(cur.x!==sx||cur.y!==sy){path.push(cur);cur=parent.get(key(cur.x,cur.y));}
  path.reverse();
  return path;
}
function msg(text,type='system'){
  G.msgs.push({text,type,t:performance.now()});if(G.msgs.length>100)G.msgs.shift();
  const log=document.getElementById('chat-log');if(!log)return;
  const d=document.createElement('div');d.className='mg '+type;d.textContent=text;
  log.appendChild(d);log.scrollTop=log.scrollHeight;
}
function floatText(x,y,text,col){G.floats.push({x,y,text,col,t:performance.now()});}

// COMBAT
function atkTgt(){
  const p=G.player,m=G.target;if(!m||!m.alive)return;
  const n=performance.now();if(n-G.la<ACOOL)return;
  const w=p.eq.weapon,ww=w?ITEMS[w]:null;
  const rng=ww&&ww.rng?ww.rng:1;
  const dx=Math.abs(p.x-m.x),dy=Math.abs(p.y-m.y);
  if(Math.max(dx,dy)>rng)return;
  G.la=n;
  const M=MONS[m.t];
  let dmg=Math.floor((ww&&ww.matk?p.matk:p.atk)-M.def/2);
  dmg=Math.max(1,dmg+Math.floor(Math.random()*dmg*0.2-dmg*0.1));
  m.hp-=dmg;floatText(m.x,m.y,'-'+dmg,'#ff4');
  const sk=ww?ww.sk:'melee';if(sk&&p.skills[sk]!==undefined){p.skillXp[sk]+=1;const skMult=getSkillMult(p.voc,sk);if(p.skillXp[sk]>=Math.floor(p.skills[sk]*8*skMult)){p.skillXp[sk]=0;p.skills[sk]++;msg(`${sk} increased to ${p.skills[sk]}!`,'level');}updSkills();}
  if(m.hp<=0){m.alive=false;m.rt=performance.now()+m.respawnTime();
    p.xp+=M.xp;msg(`${M.n} derrotado! +${M.xp} XP`,'combat');
    p.lvUp();dropLoot(m);G.kills[m.t]=(G.kills[m.t]||0)+1;checkQuests();
    sendAction('attack', {tid: m.t}).then(r => { if(r) applyServerState(r); });
  }
}

function dropLoot(m){
  const M=MONS[m.t];if(!M.loot)return;
  const items=[];M.loot.forEach(l=>{if(Math.random()<l.ch){const q=l.mn+Math.floor(Math.random()*(l.mx-l.mn+1));items.push({id:l.id,q});}});
  if(items.length){G.bags.push({x:m.x,y:m.y,items,tm:performance.now()});msg('Loot: '+items.map(i=>`${ITEMS[i.id].n}(${i.q})`).join(', '),'loot');}
}

function pickup(){
  const p=G.player;const b=G.bags.find(l=>l.x===p.x&&l.y===p.y);if(!b)return;
  b.items.forEach(i=>{if(!p.addItem(i.id,i.q))msg(`Full! ${ITEMS[i.id].n}`,'system');else{
    msg(`+${i.q} ${ITEMS[i.id].n}`,'loot');
    G.quests.forEach(q=>{if(q.type==='collect'&&q.target===i.id)checkQuests();});
  }});G.bags=G.bags.filter(l=>l!==b);
}

function getSpell(key){return SPELLS.find(s=>s.id===key)||SPELLS[key];}

function castSpell(idx){
  const p=G.player;if(idx>=p.spells.length)return;
  const key=p.spells[idx];const sp=getSpell(key);if(!sp)return;
  const now=performance.now();
  if(G.spellCDs[key]&&now<G.spellCDs[key])return;
  if(p.mp<sp.mana){msg('Not enough mana!','system');return;}
  p.mp-=sp.mana;G.spellCDs[key]=now+sp.cd;
  if(sp.heal){const h=sp.heal;p.hp=Math.min(p.mhp,p.hp+h);floatText(p.x,p.y,'+'+h,'#4f4');msg(`${sp.n}: +${h} HP`,'heal');const hxp=Math.max(1,Math.floor(sp.mana/10));p.skillXp.magic+=hxp;const hmm=getSkillMult(p.voc,'magic');if(p.skillXp.magic>=Math.floor(p.skills.magic*8*hmm)){p.skillXp.magic=0;p.skills.magic++;msg(`Magic increased to ${p.skills.magic}!`,'level');}updSkills();}
  else if(sp.buff){G.buffs[sp.buff]=now+sp.dur;msg(`${sp.n} ativado!`,'spell');const bxp=Math.max(1,Math.floor(sp.mana/10));p.skillXp.magic+=bxp;const bmm=getSkillMult(p.voc,'magic');if(p.skillXp.magic>=Math.floor(p.skills.magic*8*bmm)){p.skillXp.magic=0;p.skills.magic++;msg(`Magic increased to ${p.skills.magic}!`,'level');}updSkills();}
  else if(sp.dmg&&G.target&&G.target.alive){
    const M=MONS[G.target.t];const rng=sp.rng||1;
    const dx=Math.abs(p.x-G.target.x),dy=Math.abs(p.y-G.target.y);
    if(dx+dy<=rng){
      let dmg=Math.floor((p.matk||p.atk)*sp.dmg);dmg=Math.max(1,Math.floor(dmg-M.def/3));
      G.target.hp-=dmg;floatText(G.target.x,G.target.y,'-'+dmg,'#f8f');msg(`${sp.n}: -${dmg}`,'spell');
      const mgXp=Math.max(1,Math.floor(sp.mana/10));p.skillXp.magic+=mgXp;const mgMult=getSkillMult(p.voc,'magic');if(p.skillXp.magic>=Math.floor(p.skills.magic*8*mgMult)){p.skillXp.magic=0;p.skills.magic++;msg(`Magic increased to ${p.skills.magic}!`,'level');}updSkills();
      if(G.target.hp<=0){G.target.alive=false;G.target.rt=performance.now()+G.target.respawnTime();
        const premXp=isPrem()?Math.floor(M.xp*1.15):M.xp;p.xp+=premXp;msg(`${M.n} derrotado! +${M.xp} XP`,'combat');p.lvUp();dropLoot(G.target);G.kills[G.target.t]=(G.kills[G.target.t]||0)+1;checkQuests();
        sendAction('spell', {sid: idx, tid: G.target ? G.target.t : null}).then(r => { if(r) applyServerState(r); });}
    }else msg('Too far!','system');
  }
}

function updSpells(){
  const bar=document.getElementById('spell-bar');if(!bar||!G.player)return;
  bar.innerHTML='';const now=performance.now();
  G.player.spells.forEach((k,i)=>{
    if(i>=8)return;
    const sp=getSpell(k);if(!sp)return;
    const cd=G.spellCDs[k]&&now<G.spellCDs[k];
    const d=document.createElement('div');d.className='sp-slot'+(cd?' cd':'');
    const hkLabel=G.hotkeys['spell'+(i+1)]||('F'+(i+1));
    d.innerHTML=`<span class="sk">${hkLabel}</span><span class="si2">${sp.i}</span>`;
    d.title=`${sp.n}: ${sp.d} (${sp.mana} MP) [${hkLabel}]`;
    d.addEventListener('click',()=>castSpell(i));
    d.addEventListener('contextmenu',(e)=>{
      e.preventDefault();hideCtxMenu();
      const curKey=G.hotkeys['spell'+(i+1)]||('F'+(i+1));
      showCtxMenu(e.clientX,e.clientY,sp.n+' ['+curKey+']',[
        {icon:'\u2328',label:'Change Hotkey ['+curKey+']',fn:()=>{assignSpellHotkey(i,sp.n);}},
        {icon:'\u2139',label:sp.d+' ('+sp.mana+' MP)',fn:()=>{msg(sp.n+': '+sp.d+' | Mana: '+sp.mana+' | CD: '+(sp.cd/1000)+'s','system');}}
      ]);
    });
    bar.appendChild(d);
  });
}

function checkQuests(){
  const p=G.player;
  G.quests.forEach(q=>{
    if(q.done&&q.doneAt)return;
    if(q.type==='kill'){q.progress=G.kills[q.target]||0;}
    else if(q.type==='collect'){const it=p.inv.find(i=>i.id===q.target);q.progress=it?it.q:0;}
    if(q.progress>=q.need&&!q.done){
      q.done=true;q.doneAt=Date.now();p.xp+=q.xp;p.gold+=q.gold;
      if(q.type==='collect'){const idx=p.inv.findIndex(i=>i.id===q.target);if(idx>=0)p.rmItem(idx,q.need);}
      msg(`QUEST COMPLETA: ${q.n}! +${q.xp}XP +${q.gold}g`,'quest');p.lvUp();triggerSave();
      sendAction('quest_check').then(r => { if(r) applyServerState(r); });
    }
  });
  updQuests();
}

function acceptQuest(qid){
  const qd=QUEST_DEFS.find(d=>d.id===qid);
  if(!qd||G.quests.find(q=>q.id===qid))return;
  if(G.player.lv<qd.lvl){msg(`Precisa level ${qd.lvl}!`,'system');return;}
  G.quests.push({...qd,progress:0,done:false});
  msg(`Quest accepted: ${qd.n}`,'quest');updQuests();
}

// SHOP SYSTEM
function openShop(npc){
  G.shop=1;const p=document.getElementById('shop-p');
  p.querySelector('h3').textContent=npc.name;
  const cont=document.getElementById('sitems');cont.innerHTML='';
  npc.items.forEach(id=>{
    const it=ITEMS[id];if(!it)return;
    const stats=[];
    if(it.atk)stats.push('Atk +'+it.atk);if(it.matk)stats.push('MAtk +'+it.matk);
    if(it.def)stats.push('Def +'+it.def);if(it.rng)stats.push('Rng '+it.rng);
    if(it.spd)stats.push('Spd '+(it.spd<0?it.spd:'+'+it.spd));
    if(it.heal)stats.push('Heal +'+it.heal);if(it.mana)stats.push('Mana +'+it.mana);
    const attrLine=stats.length?stats.join(' | '):'';
    let tipStats='';
    if(it.atk)tipStats+='<div class="tt-stat">Attack: +'+it.atk+'</div>';
    if(it.matk)tipStats+='<div class="tt-stat">Magic Atk: +'+it.matk+'</div>';
    if(it.def)tipStats+='<div class="tt-stat">Defense: +'+it.def+'</div>';
    if(it.rng)tipStats+='<div class="tt-stat">Range: '+it.rng+'</div>';
    if(it.spd)tipStats+='<div class="tt-stat">Speed: '+(it.spd<0?it.spd:'+'+it.spd)+'</div>';
    if(it.heal)tipStats+='<div class="tt-stat">Heals: +'+it.heal+' HP</div>';
    if(it.mana)tipStats+='<div class="tt-stat">Restores: +'+it.mana+' MP</div>';
    if(it.s)tipStats+='<div class="tt-stat">Slot: '+it.s+'</div>';
    if(it.sk)tipStats+='<div class="tt-stat">Skill: '+it.sk+'</div>';
    if(it.charges)tipStats+='<div class="tt-stat">Charges: '+it.charges+'</div>';
    if(it.xpPerCharge)tipStats+='<div class="tt-stat">XP/Charge: '+it.xpPerCharge+'</div>';
    const d=document.createElement('div');d.className='si';
    d.innerHTML=`<span>${it.i}</span><div><div class="sn">${it.n}</div><div class="sd">${it.d}${attrLine?' ‚Äî '+attrLine:''}</div></div><span class="sp">${it.p}g</span><div class="si-tip"><div class="tt-name">${it.i} ${it.n}</div>${tipStats}<div class="tt-desc">${it.d}</div><div class="tt-stat" style="color:#f0c040;margin-top:3px;">Price: ${it.p}g</div></div>`;
    d.addEventListener('click',()=>buyItem(id));
    cont.appendChild(d);
  });
  document.getElementById('shop-ov').style.display='flex';
}
function closeShop(){G.shop=0;document.getElementById('shop-ov').style.display='none';}
function buyItem(id){const it=ITEMS[id];const p=G.player;if(it.premium&&!isPrem()){msg('This item requires Premium Account!','system');return;}if(it.vocs&&!it.vocs.includes(p.voc)){msg('Your vocation cannot use this item!','system');return;}if(p.gold<it.p){msg('Not enough gold!','system');return;}if(!p.addItem(id)){msg('Inventory full!','system');return;}const oldGold=p.gold;p.gold-=it.p;if(it.t==='training'&&it.charges){const added=p.inv[p.inv.length-1];if(added&&added.id===id)added.charges=it.charges;}msg(`Bought ${it.n}`,'system');updInv();sendAction('buy', {itemId: id}).then(r => { if(!r) { p.gold=oldGold; updInv(); msg('Purchase failed - reverted','system'); } else { applyServerState(r); } });}
function sellItem(idx){const p=G.player;const it=p.inv[idx];if(!it)return;const d=ITEMS[it.id];if(d.premium&&!isPrem()){msg('Cannot sell premium items without Premium Account!','system');return;}const price=Math.floor(d.p/3);if(!G._sellCd){G._sellCd=0;}if(Date.now()-G._sellCd<500){msg('Please wait before selling again!','system');return;}G._sellCd=Date.now();const oldGold=p.gold;p.gold+=price;msg(`Sold ${d.n} for ${price}g`,'loot');p.rmItem(idx,1);updInv();sendAction('sell', {itemId: it.id}).then(r => { if(!r) { p.gold=oldGold; updInv(); msg('Sale failed - reverted','system'); } else { applyServerState(r); } });}
function openSkills(){
  document.getElementById('skill-ov').style.display='flex';
  const list=document.getElementById('skill-list');list.innerHTML='';
  const p=G.player;
  Object.entries(p.skills).forEach(([k,v])=>{
    const d=document.createElement('div');d.className='skr';
    d.innerHTML=`<span class="skn">${k}</span><span class="skv">${v}</span>`;
    list.appendChild(d);
  });
}
function closeSkills(){document.getElementById('skill-ov').style.display='none';}

function updSkills(){
  const panel=document.getElementById('skill-panel');
  if(!panel||!G.player)return;
  const p=G.player;
  panel.innerHTML='';
  const skillNames={melee:'Melee',distance:'Distance',magic:'Magic',shielding:'Shielding'};
  const SKILL_XP_MULT=8;
  Object.entries(p.skills).forEach(([key,lv])=>{
    const xp=p.skillXp[key]||0;
    const mult=getSkillMult(p.voc,key);
    const needed=Math.floor(lv*SKILL_XP_MULT*mult);
    const pct=needed>0?Math.min(100,Math.floor(xp/needed*100)):0;
    const row=document.createElement('div');
    row.className='sk-row';
    const multLabel=mult<=1.0?'':mult<=1.5?' ¬∑':mult<=2.0?' ¬∑¬∑':' ¬∑¬∑¬∑';
    row.innerHTML=`<span class="sk-name">${skillNames[key]||key}${multLabel}</span>`+
      `<div class="sk-bar"><div class="sk-fill" style="width:${pct}%"></div></div>`+
      `<span class="sk-lv">${lv}</span>`;
    panel.appendChild(row);
  });
  if(G.training&&G.training.active){
    const tr=document.createElement('div');
    tr.className='sk-train';tr.textContent='Training...';
    panel.appendChild(tr);
  }
}

// FLOOR SWITCHING
// DJINN TRADE SYSTEM
const DJINN_LOOT_PRICES={snake_skin:50,wolf_paw:40,bear_paw:80,orc_tooth:60,minotaur_horn:150,bone:20,scorpion_tail:70,dragon_scale:800,demon_horn:1200,spider_silk:45,mummy_bandage:55,cyclops_eye:200,lich_staff_piece:1500,warlock_rune:1800,hydra_head:1000,juggernaut_plate:3000,hellhound_fang:900,ancient_rune:500,boar_tusk:30,deer_antler:25};
function getDjinnPrice(itemId){
  if(DJINN_LOOT_PRICES[itemId])return DJINN_LOOT_PRICES[itemId];
  const it=ITEMS[itemId];if(!it)return 0;
  if(it.t==='weapon'||it.t==='armor'||it.t==='boots'||it.t==='amulet'||it.t==='ring')return Math.floor(it.p*0.3);
  if(it.t==='potion'||it.t==='food')return Math.floor(it.p*0.2);
  return 0;
}
function openDjinnShop(){
  const p=G.player;
  let html='<div style="padding:12px;max-height:400px;overflow-y:auto;">';
  html+='<div style="font-size:9px;color:#4af;margin-bottom:8px;text-align:center;">Blue Djinn - Item Buyer</div>';
  html+='<div style="font-size:6px;color:#aaa;margin-bottom:8px;text-align:center;">Equipment: 30% value | Loot: special prices</div>';
  let hasItems=false;
  let sellableItems=[];
  for(let i=0;i<30;i++){
    const it=p.inv[i];if(!it)continue;
    const dd=ITEMS[it.id];if(!dd)continue;
    const price=getDjinnPrice(it.id);
    if(price<=0)continue;
    hasItems=true;
    sellableItems.push({idx:i,item:it,def:dd,price:price});
  }
  if(hasItems&&sellableItems.length>1){
    let totalAll=0;
    sellableItems.forEach(s=>{totalAll+=s.price*s.item.q;});
    html+='<div style="display:flex;align-items:center;justify-content:center;gap:6px;padding:6px;margin-bottom:6px;background:rgba(240,192,64,0.15);border:2px solid rgba(240,192,64,0.4);border-radius:6px;cursor:pointer;" onclick="djinnSellAll()">';
    html+='<span style="font-size:9px;">üí∞</span>';
    html+='<span style="font-size:8px;color:#f0c040;font-weight:bold;">Sell All - '+totalAll+'g</span>';
    html+='</div>';
  }
  for(const s of sellableItems){
    const totalPrice=s.price*s.item.q;
    html+='<div style="display:flex;align-items:center;justify-content:space-between;padding:4px 6px;margin:2px 0;background:rgba(64,128,255,0.1);border:1px solid rgba(64,128,255,0.3);border-radius:4px;gap:4px;">';
    html+='<span style="font-size:8px;flex:1;">'+s.def.i+' '+s.def.n+(s.item.q>1?' x'+s.item.q:'')+'</span>';
    html+='<span style="font-size:6px;color:#f0c040;white-space:nowrap;">'+s.price+'g ea</span>';
    html+='<div style="display:flex;gap:2px;">';
    html+='<button onclick="djinnSell('+s.idx+',1)" style="background:#224;border:1px solid #448;color:#8af;font-family:inherit;font-size:6px;padding:3px 6px;border-radius:3px;cursor:pointer;" title="Sell 1">x1</button>';
    if(s.item.q>=5)html+='<button onclick="djinnSell('+s.idx+',5)" style="background:#224;border:1px solid #448;color:#8af;font-family:inherit;font-size:6px;padding:3px 6px;border-radius:3px;cursor:pointer;" title="Sell 5">x5</button>';
    if(s.item.q>=10)html+='<button onclick="djinnSell('+s.idx+',10)" style="background:#224;border:1px solid #448;color:#8af;font-family:inherit;font-size:6px;padding:3px 6px;border-radius:3px;cursor:pointer;" title="Sell 10">x10</button>';
    if(s.item.q>1)html+='<button onclick="djinnSell('+s.idx+','+s.item.q+')" style="background:#432;border:1px solid #f0c040;color:#f0c040;font-family:inherit;font-size:6px;padding:3px 6px;border-radius:3px;cursor:pointer;" title="Sell all">ALL</button>';
    html+='</div></div>';
  }
  if(!hasItems)html+='<div style="font-size:7px;color:#888;text-align:center;padding:20px;">No sellable items in inventory.</div>';
  html+='<div style="text-align:center;margin-top:8px;"><button onclick="closeDjinnShop()" style="background:#333;color:#fff;border:1px solid #666;padding:4px 16px;font-family:inherit;font-size:7px;border-radius:4px;cursor:pointer;">Close</button></div>';
  html+='</div>';
  let ov=document.getElementById('djinn-ov');
  if(!ov){ov=document.createElement('div');ov.id='djinn-ov';ov.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,40,0.8);display:flex;align-items:center;justify-content:center;z-index:200;';document.body.appendChild(ov);}
  ov.innerHTML='<div style="background:linear-gradient(180deg,#1a1a3e,#0e0e2e);border:2px solid #4af;border-radius:8px;min-width:300px;max-width:380px;box-shadow:0 0 30px rgba(64,128,255,0.4);">'+html+'</div>';
  ov.style.display='flex';
}
function djinnSell(idx,qty){
  const p=G.player;const it=p.inv[idx];if(!it)return;
  const price=getDjinnPrice(it.id);if(price<=0)return;
  const sellQty=Math.min(qty,it.q);
  const total=price*sellQty;
  if(p.gold+total>99999999){msg('Gold limit reached!','system');return;}
  const oldGold=p.gold;
  p.gold+=total;
  msg('Sold '+sellQty+'x '+ITEMS[it.id].n+' for '+total+'g to Blue Djinn','loot');
  p.rmItem(idx,sellQty);
  updInv();triggerSave();
  sendAction('djinn_sell', {itemId: it.id, qty: sellQty}).then(r => { if(!r) { p.gold=oldGold; updInv(); msg('Sale failed - reverted','system'); } else { applyServerState(r); } });
  openDjinnShop();
}
function closeDjinnShop(){const ov=document.getElementById('djinn-ov');if(ov)ov.style.display='none';}
function djinnSellAll(){
  const p=G.player;let totalGold=0;let totalItems=0;
  const toSell=[];
  for(let i=29;i>=0;i--){
    const it=p.inv[i];if(!it)continue;
    const price=getDjinnPrice(it.id);if(price<=0)continue;
    toSell.push({idx:i,qty:it.q,price:price*it.q,name:ITEMS[it.id].n});
  }
  for(const s of toSell){
    if(p.gold+totalGold+s.price>99999999)break;
    totalGold+=s.price;totalItems+=s.qty;
    p.rmItem(s.idx,s.qty);
  }
  if(totalGold>0){
    const oldGold=p.gold;
    p.gold+=totalGold;
    msg('Sold '+totalItems+' items for '+totalGold+'g to Blue Djinn','loot');
    updInv();triggerSave();
    sendAction('djinn_sell_all').then(r => { if(!r) { p.gold=oldGold; updInv(); msg('Sale failed - reverted','system'); } else { applyServerState(r); } });
  }
  openDjinnShop();
}
// GREY DJINN - 60% of Blue Djinn prices (available to all players)
function getGreyDjinnPrice(itemId){
  return Math.floor(getDjinnPrice(itemId)*0.6);
}
function openGreyDjinnShop(){
  const p=G.player;
  let html='<div style="padding:12px;max-height:400px;overflow-y:auto;">';
  html+='<div style="font-size:9px;color:#aaa;margin-bottom:4px;text-align:center;">Grey Djinn - Item Buyer</div>';
  html+='<div style="font-size:6px;color:#888;margin-bottom:8px;text-align:center;">Pays 60% of Blue Djinn prices'+(isPrem()?'<br><span style="color:#f0c040;">Premium members get better deals at the Blue Djinn!</span>':'')+'</div>';
  let sellableItems=[];
  for(let i=0;i<30;i++){
    const it=p.inv[i];if(!it)continue;
    const dd=ITEMS[it.id];if(!dd)continue;
    const price=getGreyDjinnPrice(it.id);
    if(price<=0)continue;
    sellableItems.push({idx:i,item:it,def:dd,price:price});
  }
  if(sellableItems.length>1){
    let totalAll=0;sellableItems.forEach(s=>{totalAll+=s.price*s.item.q;});
    html+='<div style="display:flex;align-items:center;justify-content:center;gap:6px;padding:6px;margin-bottom:6px;background:rgba(160,160,160,0.15);border:2px solid rgba(160,160,160,0.4);border-radius:6px;cursor:pointer;" onclick="greyDjinnSellAll()">';
    html+='<span style="font-size:9px;">üí∞</span>';
    html+='<span style="font-size:8px;color:#ccc;font-weight:bold;">Sell All - '+totalAll+'g</span>';
    html+='</div>';
  }
  for(const s of sellableItems){
    html+='<div style="display:flex;align-items:center;justify-content:space-between;padding:4px 6px;margin:2px 0;background:rgba(160,160,160,0.1);border:1px solid rgba(160,160,160,0.3);border-radius:4px;gap:4px;">';
    html+='<span style="font-size:8px;flex:1;">'+s.def.i+' '+s.def.n+(s.item.q>1?' x'+s.item.q:'')+'</span>';
    html+='<span style="font-size:6px;color:#ccc;white-space:nowrap;">'+s.price+'g ea</span>';
    html+='<div style="display:flex;gap:2px;">';
    html+='<button onclick="greyDjinnSell('+s.idx+',1)" style="background:#333;border:1px solid #666;color:#ccc;font-family:inherit;font-size:6px;padding:3px 6px;border-radius:3px;cursor:pointer;">x1</button>';
    if(s.item.q>=5)html+='<button onclick="greyDjinnSell('+s.idx+',5)" style="background:#333;border:1px solid #666;color:#ccc;font-family:inherit;font-size:6px;padding:3px 6px;border-radius:3px;cursor:pointer;">x5</button>';
    if(s.item.q>=10)html+='<button onclick="greyDjinnSell('+s.idx+',10)" style="background:#333;border:1px solid #666;color:#ccc;font-family:inherit;font-size:6px;padding:3px 6px;border-radius:3px;cursor:pointer;">x10</button>';
    if(s.item.q>1)html+='<button onclick="greyDjinnSell('+s.idx+','+s.item.q+')" style="background:#432;border:1px solid #f0c040;color:#f0c040;font-family:inherit;font-size:6px;padding:3px 6px;border-radius:3px;cursor:pointer;">ALL</button>';
    html+='</div></div>';
  }
  if(sellableItems.length===0)html+='<div style="font-size:7px;color:#888;text-align:center;padding:20px;">No sellable items in inventory.</div>';
  html+='<div style="text-align:center;margin-top:8px;"><button onclick="closeGreyDjinn()" style="background:#333;color:#fff;border:1px solid #666;padding:4px 16px;font-family:inherit;font-size:7px;border-radius:4px;cursor:pointer;">Close</button></div>';
  html+='</div>';
  let ov=document.getElementById('gdjinn-ov');
  if(!ov){ov=document.createElement('div');ov.id='gdjinn-ov';ov.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(20,20,20,0.8);display:flex;align-items:center;justify-content:center;z-index:200;';document.body.appendChild(ov);}
  ov.innerHTML='<div style="background:linear-gradient(180deg,#2a2a2a,#1a1a1a);border:2px solid #888;border-radius:8px;min-width:300px;max-width:380px;box-shadow:0 0 30px rgba(128,128,128,0.3);">'+html+'</div>';
  ov.style.display='flex';
}
function greyDjinnSell(idx,qty){
  const p=G.player;const it=p.inv[idx];if(!it)return;
  const price=getGreyDjinnPrice(it.id);if(price<=0)return;
  const sellQty=Math.min(qty,it.q);const total=price*sellQty;
  if(p.gold+total>99999999){msg('Gold limit reached!','system');return;}
  p.gold+=total;
  msg('Sold '+sellQty+'x '+ITEMS[it.id].n+' for '+total+'g to Grey Djinn','loot');
  p.rmItem(idx,sellQty);updInv();triggerSave();
  openGreyDjinnShop();
}
function closeGreyDjinn(){const ov=document.getElementById('gdjinn-ov');if(ov)ov.style.display='none';}
function greyDjinnSellAll(){
  const p=G.player;let totalGold=0;let totalItems=0;
  const toSell=[];
  for(let i=29;i>=0;i--){
    const it=p.inv[i];if(!it)continue;
    const price=getGreyDjinnPrice(it.id);if(price<=0)continue;
    toSell.push({idx:i,qty:it.q,price:price*it.q,name:ITEMS[it.id].n});
  }
  for(const s of toSell){
    if(p.gold+totalGold+s.price>99999999)break;
    totalGold+=s.price;totalItems+=s.qty;
    p.rmItem(s.idx,s.qty);
  }
  if(totalGold>0){p.gold+=totalGold;msg('Sold '+totalItems+' items for '+totalGold+'g to Grey Djinn','loot');updInv();triggerSave();}
  openGreyDjinnShop();
}
function switchFloor(newFloor,px,py){if(!G._floorCd){G._floorCd=0;}if(Date.now()-G._floorCd<3000){return;}G._floorCd=Date.now();G._zoneCache=null;G._zoneCacheFloor=-1;if((newFloor>=7&&newFloor<=13)&&!isPrem()){msg('Premium Account required to access this area!','system');return;}
  const oldFloor=G.floor;const dir=newFloor>oldFloor?'Descendo...':'Subindo...';
  const fi=FLOOR_INFO[newFloor];
  const trans=document.getElementById('floor-trans');
  const bg=trans.querySelector('.ft-bg');
  const txt=document.getElementById('ft-text');
  const sub=document.getElementById('ft-sub');
  bg.style.background=fi.bg;txt.textContent=fi.icon+' '+fi.name;txt.style.color=fi.col;sub.textContent=dir;
  trans.classList.add('active');
  setTimeout(()=>{
    G.floor=newFloor;G.player.x=px;G.player.y=py;
    G.mons=[];G.bags=[];G.target=null;G.autoPath=null;G.autoTarget=null;wsSwitchFloor(newFloor);
    if(newFloor>0){const mc=document.getElementById('mm');G.mmZoom=Math.min(Math.floor(mc.width/100),Math.floor(mc.height/80));}else{G.mmZoom=1;}
    spawnMons();placeNPCs();
    const ind=document.getElementById('floor-ind');ind.className=fi.cls;
    ind.querySelector('.fi-icon').innerHTML=fi.icon;
    document.getElementById('fl-name').textContent=fi.name;
    ind.querySelector('.fi-name').textContent='Floor '+(newFloor===0?'0':'-'+newFloor);
    msg(`${dir} ${fi.icon} ${fi.name}`,'system');
    triggerSave();
    setTimeout(()=>trans.classList.remove('active'),600);
  },500);
}
function checkStairs(){const p=G.player;STAIRS.forEach(s=>{if(s.fx===G.floor&&s.x===p.x&&s.y===p.y){switchFloor(s.tx,s.dx,s.dy);}});}

// NPC PLACEMENT
function placeNPCs(){
G.npcs=[];
if(G.floor===0){
G.npcs.push(new NPC('Merchant',930,780,['hp_pot','mp_pot','ghp','gmp','uhp','ump','club','sword','axe','bow','spear','leather','chain','leather_cap','steel_helm','wood_shield','steel_shield','leather_legs','steel_legs','sandals','leather_boots'],'shop'));
G.npcs.push(new NPC('Alchemist',940,780,['hp_pot','mp_pot','ghp','gmp','uhp','ump','supreme_hp','gsp','usp','cheese','meat','fish','bread','ham'],'shop_alchemist'));
G.npcs.push(new NPC('Armorer',950,780,['plate','knight_armor','magic_plate','golden_armor','halberd','morning_star','fire_sword','crossbow','royal_crossbow','crown_helm','royal_helmet','tower_shield','demon_shield','golden_legs','steel_boots','golden_boots','boh','bronze_amulet','silver_amulet','gold_amulet','amulet_of_loss','bronze_ring','silver_ring','gold_ring'],'shop_armor'));
G.npcs.push(new NPC('Grey Djinn',955,790,[],'grey_djinn'));
G.npcs.push(new NPC('Mage',960,780,['magic_staff','wand_fire','wand_ice','wand_death','wand_cosmic','staff_destruction','druid_rod','snakebite_rod','terra_rod','hailstorm_rod','springsprout_rod'],'shop_mage'));
G.npcs.push(new NPC('Priest',950,800,[],'priest'));
G.npcs.push(new NPC('Scout',935,815,[],'quest',['q_bugs','q_rats','q_deer','q_snakes','q_poison_spiders','q_boars']));
G.npcs.push(new NPC('Ranger',945,815,[],'quest',['q_wolves','q_wolf_paws','q_bears','q_scorpions','q_rotworms','q_trolls']));
G.npcs.push(new NPC('Captain',955,815,[],'quest',['q_cave_rats','q_skeletons','q_mummies','q_orcs','q_orc_warriors','q_spiders','q_spider_silk']));
G.npcs.push(new NPC('Commander',965,815,[],'quest',['q_demon_skeletons','q_minotaurs','q_horns','q_cyclops','q_cyclops_eyes','q_lichs','q_warlocks']));
G.npcs.push(new NPC('Legend',950,825,[],'quest',['q_wyrms','q_serpent_spawns','q_dragons','q_scales','q_hydras','q_dragon_lords','q_hellhounds','q_demons','q_undead_dragons','q_juggernauts']));
G.npcs.push(new NPC('King Aldric',980,800,[],'king'));
G.npcs.push(new NPC('Royal Guard',976,800,[],'knight_guard'));
G.npcs.push(new NPC('Royal Guard',984,800,[],'knight_guard'));
G.npcs.push(new NPC('Banker',970,780,[],'banker'));
G.npcs.push(new NPC('Premium Herald',920,800,[],'premium'));
G.npcs.push(new NPC('Blessing Priest',910,800,[],'blessing'));
G.npcs.push(new NPC('Portal Master',940,800,[],'teleporter'));
G.npcs.push(new NPC('Training Dummy',970,815,[],'trainer_dummy'));
}
if(G.floor===10){
G.npcs.push(new NPC('Premium Merchant',30,25,['soft_boots','firewalker_boots','demon_armor','demon_blade','demon_helmet','demon_legs','demon_shield','golden_armor','golden_boots','boh','supreme_hp','platinum_amulet','amulet_of_loss','dragon_necklace','might_ring','ring_of_healing','energy_ring'],'shop'));
G.npcs.push(new NPC('Blessing Master',40,25,[],'blessing'));
G.npcs.push(new NPC('Boot Cobbler',50,25,[],'cobbler'));
G.npcs.push(new NPC('Priest of Light',60,25,[],'priest'));
G.npcs.push(new NPC('Portal Master',20,25,[],'teleporter'));
G.npcs.push(new NPC('Blue Djinn',70,25,[],'djinn'));
G.npcs.push(new NPC('Merchant',22,35,['hp_pot','mp_pot','ghp','gmp','uhp','ump','club','sword','axe','bow','spear','leather','chain','leather_cap','steel_helm','wood_shield','steel_shield','leather_legs','steel_legs','sandals','leather_boots'],'shop'));
G.npcs.push(new NPC('Alchemist',24,35,['hp_pot','mp_pot','ghp','gmp','uhp','ump','supreme_hp','gsp','usp','cheese','meat','fish','bread','ham'],'shop_alchemist'));
G.npcs.push(new NPC('Armorer',26,35,['plate','knight_armor','magic_plate','golden_armor','halberd','morning_star','fire_sword','crossbow','royal_crossbow','crown_helm','royal_helmet','tower_shield','demon_shield','golden_legs','steel_boots','golden_boots','boh'],'shop_armor'));
G.npcs.push(new NPC('Mage',28,35,['magic_staff','wand_fire','wand_ice','wand_death','wand_cosmic','staff_destruction','druid_rod','snakebite_rod','terra_rod','hailstorm_rod','springsprout_rod'],'shop_mage'));
G.npcs.push(new NPC('Training Master',35,45,['exercise_sword','exercise_bow','exercise_wand','exercise_shield','durable_exercise_sword','durable_exercise_bow','durable_exercise_wand','durable_exercise_shield'],'shop'));
G.npcs.push(new NPC('Training Dummy',38,45,[],'trainer_dummy'));
G.npcs.push(new NPC('Training Dummy',41,45,[],'trainer_dummy'));
G.npcs.push(new NPC('Training Dummy',44,45,[],'trainer_dummy'));
G.npcs.push(new NPC('Dragon Portal',40,50,[],'zone_portal'));
G.npcs.push(new NPC('Demon Portal',60,50,[],'zone_portal'));
G.npcs.push(new NPC('Abyssal Portal',80,50,[],'zone_portal'));
}
if(G.floor===11){
G.npcs.push(new NPC('Return Portal',50,40,[],'zone_return'));
}
if(G.floor===12){
G.npcs.push(new NPC('Return Portal',50,40,[],'zone_return'));
}
if(G.floor===13){
G.npcs.push(new NPC('Return Portal',50,40,[],'zone_return'));
}
}

// QUESTS UI
function updQuests(){
  const qp=document.getElementById('quest-panel');if(!qp||!G.player)return;qp.innerHTML='';
  const p=G.player;
  const active=G.quests.filter(q=>!(q.done&&q.doneAt));
  if(active.length===0){
    const empty=document.createElement('div');
    empty.style.cssText='font-size:5px;color:#666;padding:4px;text-align:center;';
    empty.textContent='No active quests. Click "Available" to find quests!';
    qp.appendChild(empty);return;
  }
  active.forEach(q=>{
    const d=document.createElement('div');d.className='qt';
    const pct=q.need>0?Math.min(100,Math.floor(q.progress/q.need*100)):0;
    const complete=q.progress>=q.need;
    d.innerHTML=`<b>${q.n}</b>: ${q.progress}/${q.need} `+
      `<span style="color:#666;font-size:4px;">(${pct}%)</span> `+
      `<span class="qp">${complete?'COMPLETE!':''}</span>`;
    d.addEventListener('contextmenu',(e)=>{ctxQuest(q,e);});
    qp.appendChild(d);
  });
  // Update available count badge
  const btn=document.getElementById('quest-avail-btn');
  if(btn){
    const acceptedIds=G.quests.map(q=>q.id);
    const availCount=QUEST_DEFS.filter(qd=>!acceptedIds.includes(qd.id)&&p.lv>=qd.lvl).length;
    btn.textContent=availCount>0?'Available ('+availCount+')':'Available';
    btn.style.background=availCount>0?'#4a2080':'#3a2060';
  }
}
function openQuestBoard(){
  const p=G.player;if(!p)return;
  const acceptedIds=G.quests.map(q=>q.id);
  const avail=QUEST_DEFS.filter(qd=>!acceptedIds.includes(qd.id));
  // Group by level tiers
  const tiers=[
    {label:'Beginner (Lv 1-10)',min:1,max:10},
    {label:'Intermediate (Lv 11-25)',min:11,max:25},
    {label:'Advanced (Lv 26-40)',min:26,max:40},
    {label:'Expert (Lv 41+)',min:41,max:999}
  ];
  let ov=document.getElementById('qb-ov');
  if(!ov){ov=document.createElement('div');ov.id='qb-ov';ov.className='qb-ov';document.body.appendChild(ov);}
  let html='<div class="qb-box">';
  html+='<div class="qb-title">Quest Board</div>';
  html+='<div style="font-size:6px;color:#888;text-align:center;margin-bottom:8px;">Accept quests to track them in your quest log</div>';
  let totalAvail=0;
  tiers.forEach(tier=>{
    const quests=avail.filter(q=>q.lvl>=tier.min&&q.lvl<=tier.max);
    if(quests.length===0)return;
    html+='<div class="qb-cat">'+tier.label+'</div>';
    quests.forEach(qd=>{
      const locked=p.lv<qd.lvl;
      totalAvail++;
      html+='<div class="qb-item" style="'+(locked?'opacity:0.4;':'')+'"><div style="flex:1;"><div class="qb-name">'+(locked?'üîí ':'')+qd.n+'</div>';
      html+='<div class="qb-desc">'+qd.d+'</div>';
      html+='<div class="qb-reward">Reward: +'+qd.xp+' XP, +'+qd.gold+'g</div>';
      html+='<div class="qb-lvl">Level '+qd.lvl+' required'+(locked?' (You: Lv'+p.lv+')':'')+'</div>';
      html+='</div>';
      if(!locked)html+='<button class="qb-accept" onclick="acceptQuestFromBoard(\''+qd.id+'\')">Accept</button>';
      html+='</div>';
    });
  });
  if(totalAvail===0)html+='<div style="font-size:7px;color:#888;text-align:center;padding:20px;">All quests accepted or completed!</div>';
  html+='<div style="text-align:center;margin-top:10px;"><button onclick="closeQuestBoard()" style="background:#333;color:#fff;border:1px solid #666;padding:4px 16px;font-family:inherit;font-size:7px;border-radius:4px;cursor:pointer;">Close</button></div>';
  html+='</div>';
  ov.innerHTML=html;
  ov.style.display='flex';
  ov.onclick=(e)=>{if(e.target===ov)closeQuestBoard();};
}
function acceptQuestFromBoard(qid){
  acceptQuest(qid);
  openQuestBoard();
}
function closeQuestBoard(){const ov=document.getElementById('qb-ov');if(ov)ov.style.display='none';}
function ctxQuest(q,e){
  e.preventDefault();hideCtxMenu();
  const opts=[];
  const complete=q.progress>=q.need;
  opts.push({icon:'\u2139',label:'Info: '+q.n,fn:()=>{
    let info=q.n+' ‚Äî '+q.d;
    info+=' | Progress: '+q.progress+'/'+q.need;
    info+=' | Reward: +'+q.xp+' XP, +'+q.gold+'g';
    info+=' | Min Level: '+q.lvl;
    if(complete)info+=' | STATUS: COMPLETE!';
    msg(info,'system');
  }});
  if(!complete){
    opts.push({sep:true});
    opts.push({icon:'\u274C',label:'Abandon Quest',danger:true,fn:()=>{
      G.quests=G.quests.filter(qq=>qq.id!==q.id);
      msg('Abandoned quest: '+q.n,'system');
      updQuests();triggerSave();
    }});
  }
  showCtxMenu(e.clientX,e.clientY,q.n,opts);
}
// MOVEMENT
function handleMov(n){
  const p=G.player;if(n-G.lw<p.speed)return;
  let dx=0,dy=0;
  const hasKey=G.keys.ArrowUp||G.keys.w||G.keys.W||G.keys.ArrowDown||G.keys.s||G.keys.S||G.keys.ArrowLeft||G.keys.a||G.keys.A||G.keys.ArrowRight||G.keys.d||G.keys.D;
  if(hasKey){G.autoPath=null;G.autoTarget=null;}
  if(G.keys.ArrowUp||G.keys.w||G.keys.W){dy=-1;p.dir=0;}
  if(G.keys.ArrowDown||G.keys.s||G.keys.S){dy=1;p.dir=2;}
  if(G.keys.ArrowLeft||G.keys.a||G.keys.A){dx=-1;p.dir=1;}
  if(G.keys.ArrowRight||G.keys.d||G.keys.D){dx=1;p.dir=3;}
  if(!dx&&!dy&&G.autoPath&&G.autoPath.length>0){
    const next=G.autoPath[0];dx=next.x-p.x;dy=next.y-p.y;
    if(dx<0)p.dir=1;else if(dx>0)p.dir=3;else if(dy<0)p.dir=0;else if(dy>0)p.dir=2;
  }
  if(!dx&&!dy)return;
  const nx=p.x+dx,ny=p.y+dy;
  if(!canW(nx,ny)&&dx&&dy){
    // Diagonal blocked: try cardinal fallback
    if(canW(p.x+dx,p.y)){dy=0;}else if(canW(p.x,p.y+dy)){dx=0;}
  }
  const nx2=p.x+dx,ny2=p.y+dy;
  if(!canW(nx2,ny2)){
    const npc=npcAt(nx2,ny2);
    if(npc){interactNPC(npc);G.autoPath=null;G.autoTarget=null;}
    return;
  }
  const mBlock=monAt(nx2,ny2);
  if(mBlock){G.target=mBlock;atkTgt();G.lw=n;return;}
  p.x=nx2;p.y=ny2;G.lw=n;wsSendMove();
  if(G.training.active)stopTraining('You moved');
  if(G.autoPath&&G.autoPath.length>0&&p.x===G.autoPath[0].x&&p.y===G.autoPath[0].y){
    G.autoPath.shift();
    if(G.autoPath.length===0){G.autoPath=null;G.autoTarget=null;msg('Arrived at destination!','system');}
  }
  checkStairs();pickup();
}

// NPC INTERACTION
function interactNPC(npc){
  if(npc.type==='shop'||npc.type==='shop_alchemist'||npc.type==='shop_armor'||npc.type==='shop_mage'){openShop(npc);}
  else if(npc.type==='priest'){
    G.player.hp=G.player.mhp;G.player.mp=G.player.mmp;
    msg('The priest healed you completely!','heal');
    floatText(G.player.x,G.player.y,'FULL HEAL','#4f4');
  }
  else if(npc.type==='quest'){
    const avail=npc.quests.filter(qid=>!G.quests.find(q=>q.id===qid));
    if(avail.length===0){msg(`${npc.name}: No new quests available! You've accepted them all.`,'system');return;}
    msg(`${npc.name}: Check the Quest Board for available missions!`,'system');
    openQuestBoard();
  }
  else if(npc.type==='banker'){msg(`${npc.name}: You have ${G.player.gold} gold.`,'system');}
  else if(npc.type==='premium'){openPremPanel();}
  else if(npc.type==='blessing'){openBlessShop();}
  else if(npc.type==='cobbler'){if(!isPrem()){msg('This service requires Premium Account!','system');return;}const p=G.player;const wsb=p.inv.findIndex(i=>i.id==='worn_soft_boots');if(wsb>=0){if(p.gold<10000){msg('Recharge costs 10,000 gold!','system');return;}p.gold-=10000;p.inv[wsb].id='soft_boots';p.softBootCharges=14400;msg('Soft Boots recharged!','quest');updInv();triggerSave();}else{msg(`${npc.name}: Bring me Worn Soft Boots and 10,000 gold to recharge them!`,'system');}}
  else if(npc.type==='king'){msg(`King Aldric: Welcome, brave ${G.player.name}! The kingdom needs heroes like you. Prove yourself in battle and great rewards await...`,'system');}
  else if(npc.type==='knight_guard'){msg(`Royal Guard: Stand back! The King must not be disturbed.`,'system');}
  else if(npc.type==='trainer_dummy'){openTrainingDummy(npc);}
  else if(npc.type==='trainer'){msg(`${npc.name}: Keep training, adventurer!`,'system');}
  else if(npc.type==='teleporter'){if(!isPrem()){msg(`${npc.name}: Only Premium Account holders may use the portal. Speak to the Premium Herald to upgrade!`,'system');return;}if(G.floor===0){msg(`${npc.name}: Teleporting to Premium Sanctuary...`,'spell');switchFloor(10,30,35);}else if(G.floor===10){msg(`${npc.name}: Teleporting back to Surface Temple...`,'spell');switchFloor(0,940,801);}else{msg(`${npc.name}: I can only teleport you from the main temples!`,'system');}}
  else if(npc.type==='djinn'){if(!isPrem()){msg('The Blue Djinn only trades with Premium adventurers!','system');return;}openDjinnShop();}
  else if(npc.type==='grey_djinn'){openGreyDjinnShop();}
  else if(npc.type==='zone_portal'){if(!isPrem()){msg('Premium Account required!','system');return;}if(npc.name==='Dragon Portal'){msg('Entering the Dragon Lair...','spell');switchFloor(11,50,39);}else if(npc.name==='Demon Portal'){msg('Entering the Demon Pit...','spell');switchFloor(12,50,39);}else if(npc.name==='Abyssal Portal'){msg('Entering the Abyssal Core...','spell');switchFloor(13,50,39);}}
  else if(npc.type==='zone_return'){if(!isPrem()){msg('Premium Account required!','system');return;}msg('Returning to Premium Sanctuary...','spell');switchFloor(10,50,40);}
}

// TRAINING DUMMY SYSTEM
function openTrainingDummy(npc){
  if(!isPrem()){msg('Training Dummies require a Premium Account!','system');return;}
  if(G.training.active){msg('You are already training! Move to stop.','system');return;}
  const p=G.player;
  const trainItems=[];
  p.inv.forEach((item,idx)=>{
    const def=ITEMS[item.id];
    if(def&&def.t==='training'){
      const charges=item.charges!==undefined?item.charges:def.charges;
      if(charges>0)trainItems.push({idx,item,def,charges});
    }
  });
  if(trainItems.length===0){msg('Training Dummy: You need Exercise items to train here! Buy them from the Training Master.','system');return;}
  // Build selection dialog
  const overlay=document.createElement('div');
  overlay.id='train-overlay';
  overlay.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;';
  const box=document.createElement('div');
  box.style.cssText='background:#1a1a10;border:2px solid #c9a959;border-radius:8px;padding:16px;max-width:320px;width:90%;color:#e0d8c0;font-family:monospace;';
  box.innerHTML='<div style="text-align:center;color:#f0c040;font-size:14px;margin-bottom:12px;font-weight:bold;">Training Dummy</div><div style="font-size:11px;color:#aaa;margin-bottom:10px;">Select an exercise item to begin training:</div>';
  trainItems.forEach(ti=>{
    const btn=document.createElement('div');
    btn.style.cssText='padding:8px;margin:4px 0;background:#2a2a1a;border:1px solid #555;border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;font-size:11px;';
    btn.innerHTML=`<span>${ti.def.i||''} ${ti.def.n}</span><span style="color:#fa3;">${ti.charges} charges</span>`;
    btn.onmouseover=()=>btn.style.borderColor='#f0c040';
    btn.onmouseout=()=>btn.style.borderColor='#555';
    btn.onclick=()=>{
      overlay.remove();
      startTraining(ti.idx,npc);
    };
    box.appendChild(btn);
  });
  const closeBtn=document.createElement('div');
  closeBtn.style.cssText='text-align:center;margin-top:10px;padding:6px;background:#3a1a1a;border:1px solid #a33;border-radius:4px;cursor:pointer;font-size:11px;color:#f88;';
  closeBtn.textContent='Cancel';
  closeBtn.onclick=()=>overlay.remove();
  box.appendChild(closeBtn);
  overlay.appendChild(box);
  overlay.onclick=(e)=>{if(e.target===overlay)overlay.remove();};
  document.body.appendChild(overlay);
}

function startTraining(invIdx,dummy){
  const p=G.player;
  const item=p.inv[invIdx];
  if(!item)return;
  const def=ITEMS[item.id];
  if(!def||def.t!=='training')return;
  if(item.charges===undefined)item.charges=def.charges;
  if(item.charges<=0){msg('This item has no charges left!','system');return;}
  G.training={active:true,itemIdx:invIdx,lastTick:performance.now(),dummy:dummy};
  msg(`Started training ${def.sk} on the Training Dummy! (${item.charges} charges remaining)`,'quest');
  floatText(p.x,p.y,'TRAINING','#f0c040');
  updSkills();
}

function stopTraining(reason){
  if(!G.training.active)return;
  G.training={active:false,itemIdx:-1,lastTick:0,dummy:null};
  if(reason)msg(`Training stopped: ${reason}`,'system');
  updSkills();
}

function tickTraining(now){
  if(!G.training.active)return;
  if(now-G.training.lastTick<1000)return;
  G.training.lastTick=now;
  const p=G.player;
  const invIdx=G.training.itemIdx;
  const item=p.inv[invIdx];
  if(!item){stopTraining('Item removed');return;}
  const def=ITEMS[item.id];
  if(!def||def.t!=='training'){stopTraining('Invalid item');return;}
  if(item.charges===undefined)item.charges=def.charges;
  if(item.charges<=0){stopTraining('No charges remaining');updInv();return;}
  // Consume 1 charge, give XP
  item.charges--;
  const sk=def.sk;
  const xpGain=def.xpPerCharge||3;
  p.skillXp[sk]=(p.skillXp[sk]||0)+xpGain;
  floatText(p.x,p.y,sk.charAt(0).toUpperCase()+sk.slice(1),'#6aba6a');
  // Check skill level up (with vocation multiplier)
  const SKILL_XP_MULT=8;
  const trMult=getSkillMult(p.voc,sk);
  if(p.skillXp[sk]>=Math.floor(p.skills[sk]*SKILL_XP_MULT*trMult)){
    p.skillXp[sk]-=Math.floor(p.skills[sk]*SKILL_XP_MULT*trMult);
    p.skills[sk]++;
    msg(`Your ${sk} skill advanced to level ${p.skills[sk]}!`,'quest');
    floatText(p.x,p.y,`${sk.toUpperCase()} UP!`,'#f0c040');
  }
  updSkills();
  // Check if charges depleted
  if(item.charges<=0){
    p.inv.splice(invIdx,1);
    stopTraining('All charges used up!');
    updInv();
    msg('Your exercise item has been fully consumed!','system');
  }
}

// RENDER
function render(){
  const c=G.cx,cv=G.cv;if(!c)return;
  const p=G.player;
  const cw=VW*TS,ch=VH*TS;
  let camX=p.x-Math.floor(VW/2),camY=p.y-Math.floor(VH/2);
  camX=Math.max(0,Math.min(MW-VW,camX));camY=Math.max(0,Math.min(MH-VH,camY));

  c.fillStyle='#000';c.fillRect(0,0,cw,ch);

  const map=G.maps[G.floor];
  for(let ty=0;ty<VH;ty++)for(let tx=0;tx<VW;tx++){
    const mx=camX+tx,my=camY+ty;
    if(mx<0||my<0||mx>=MW||my>=MH)continue;
    const t=map[my][mx];
    const sx=tx*TS,sy=ty*TS;
    let spr=null;
    switch(t){
      case TT.G:{const v=(mx*7+my*13)%3;spr=v===1?spriteCache.grass2:v===2?spriteCache.grass3:spriteCache.grass;break;}
      case TT.D:spr=spriteCache.dirt;break;
      case TT.W:spr=spriteCache.water;break;
      case TT.TR:{const v2=(mx*7+my*13)%3;const gspr=v2===1?spriteCache.grass2:v2===2?spriteCache.grass3:spriteCache.grass;if(gspr)c.drawImage(gspr,sx,sy);spr=spriteCache.tree;break;}
      case TT.WL:spr=spriteCache.wall;break;
      case TT.FL:spr=spriteCache.floor;break;
      case TT.SA:spr=spriteCache.sand;break;
      case TT.CV:spr=spriteCache.cave;break;
      case TT.CW:spr=spriteCache.cavewall;break;
      case TT.DR:spr=spriteCache.door;break;
      case TT.TM:spr=spriteCache.temple;break;
      case TT.IC:spr=spriteCache.ice;break;
      case TT.LV:spr=spriteCache.lava;break;
      case TT.SU:spr=spriteCache.stairsup;break;
      case TT.SD:spr=spriteCache.stairsdown;break;
      case TT.MT:spr=spriteCache.mountain;break;
      case TT.SW:spr=spriteCache.swamp;break;
      case TT.SWAMP:spr=spriteCache.swamp;break;
      case TT.BRIDGE:spr=spriteCache.bridge||spriteCache.floor;break;
      case TT.FARM:spr=spriteCache.farm||spriteCache.dirt;break;
      default:spr=spriteCache.grass;break;
    }
    if(spr)c.drawImage(spr,sx,sy);
  }

  G.bags.forEach(b=>{const sx=(b.x-camX)*TS,sy=(b.y-camY)*TS;if(sx<-TS||sy<-TS||sx>cw+TS||sy>ch+TS)return;drawLootBag(c,sx,sy);});

  G.npcs.forEach(n=>{const sx=(n.x-camX)*TS,sy=(n.y-camY)*TS;if(sx<-TS||sy<-TS||sx>cw+TS||sy>ch+TS)return;drawNPC(c,sx,sy,n.name,n.type);});

  const now=performance.now();
  G.mons.forEach(m=>{
    if(!m.alive)return;
    const sx=(m.x-camX)*TS,sy=(m.y-camY)*TS;
    if(sx<-2*TS||sy<-2*TS||sx>cw+2*TS||sy>ch+2*TS)return;
    drawMonster(c,sx,sy,m.t,m.hp,MONS[m.t].hp);
    if(m.spawnAnim&&now-m.spawnAnim<500){
      const prog=(now-m.spawnAnim)/500;
      c.globalAlpha=1-prog;
      c.strokeStyle='#ff0';c.lineWidth=2;
      c.beginPath();c.arc(sx+TS/2,sy+TS/2,prog*20,0,Math.PI*2);c.stroke();
      c.globalAlpha=1;
    }
  });

  G.otherPlayers.forEach(op=>{
    const sx=(op.x-camX)*TS,sy=(op.y-camY)*TS;
    if(sx<-TS||sy<-TS||sx>cw+TS||sy>ch+TS)return;
    if(typeof drawOtherPlayer==='function')drawOtherPlayer(c,sx,sy,op);
    else drawTibiaChar(c,sx,sy,VOCS[op.voc||'knight'].out,op.dir||2,false);
  });

  drawTibiaChar(c,(p.x-camX)*TS,(p.y-camY)*TS,p.out,p.dir,true);

  G.floats.forEach(f=>{
    const age=now-f.t;if(age>1000)return;
    const a=1-age/1000;
    const sx=(f.x-camX)*TS+TS/2,sy=(f.y-camY)*TS-age/50;
    c.globalAlpha=a;c.fillStyle=f.col;c.font='bold 10px "Press Start 2P"';c.textAlign='center';
    c.fillText(f.text,sx,sy);c.textAlign='left';c.globalAlpha=1;
  });

  if(G.floor===0){
    G.dayTime+=0.0001;if(G.dayTime>1)G.dayTime=0;
    const night=Math.sin(G.dayTime*Math.PI*2)*0.15;
    if(night>0){c.fillStyle=`rgba(0,0,40,${night})`;c.fillRect(0,0,cw,ch);}
  }else if(G.floor===10){
    // Premium Sanctuary: fully illuminated golden temple glow
    c.fillStyle='rgba(255,240,180,0.04)';c.fillRect(0,0,cw,ch);
  }else if(G.floor>=14&&G.floor<=33){
    // Tower floors: fully illuminated with themed ambient glow
    const towerIdx=Math.floor((G.floor-14)/5);
    const towerGlows=['rgba(255,120,40,0.06)','rgba(140,200,255,0.06)','rgba(80,200,80,0.06)','rgba(180,100,255,0.06)'];
    c.fillStyle=towerGlows[towerIdx]||'rgba(255,255,255,0.04)';c.fillRect(0,0,cw,ch);
  }else{
    const px2=(p.x-camX)*TS+TS/2,py2=(p.y-camY)*TS+TS/2;
    const radii=[0,8,7,6,5,4];
    const tints=['','rgba(30,20,5,','rgba(40,10,5,','rgba(50,20,0,','rgba(30,0,30,','rgba(40,0,0,'];
    const rad=(radii[G.floor]||6)*TS;
    const flicker=Math.sin(now/200)*0.02;
    const grad=c.createRadialGradient(px2,py2,rad*0.15,px2,py2,rad);
    const tint=tints[G.floor]||'rgba(0,0,0,';
    grad.addColorStop(0,tint+(0+flicker)+')');
    grad.addColorStop(0.5,tint+(0.4+flicker)+')');
    grad.addColorStop(0.8,tint+'0.85)');
    grad.addColorStop(1,tint+'0.95)');
    c.fillStyle=grad;c.fillRect(0,0,cw,ch);
    if(G.floor>=3){
      const pulse=Math.sin(now/500)*0.05+0.05;
      c.fillStyle=`rgba(255,80,0,${pulse})`;c.fillRect(0,0,cw,ch);
    }
  }

  G.floats=G.floats.filter(f=>now-f.t<1000);
  G.bags=G.bags.filter(l=>now-l.tm<60000);if(G.bags.length>30)G.bags=G.bags.slice(-30);
}

// HUD UPDATE
function updHUD(){
  const p=G.player;if(!p)return;
  const hpPct=Math.floor(p.hp/p.mhp*100);
  document.getElementById('hpb').style.width=hpPct+'%';
  document.getElementById('hpt').textContent=Math.floor(p.hp)+'/'+p.mhp;
  const mpPct=Math.floor(p.mp/p.mmp*100);
  document.getElementById('mpb').style.width=mpPct+'%';
  document.getElementById('mpt').textContent=Math.floor(p.mp)+'/'+p.mmp;
  const xpPct=Math.floor(p.xp/p.xpN()*100);
  document.getElementById('xpb').style.width=xpPct+'%';
  document.getElementById('xpt').textContent=xpPct+'%';
  document.getElementById('lvt').textContent=p.lv;
  document.getElementById('glt').textContent=p.gold;
  const pbBtn=document.getElementById('prem-buy-btn');
  if(pbBtn)pbBtn.style.display=isPrem()?'none':'inline-block';
  const tgt=document.getElementById('tgt');
  if(G.target&&G.target.alive){
    tgt.style.display='block';
    tgt.querySelector('.tn').textContent=MONS[G.target.t].n+' (HP:'+G.target.hp+'/'+MONS[G.target.t].hp+')';
    tgt.querySelector('.tf').style.width=Math.floor(G.target.hp/MONS[G.target.t].hp*100)+'%';
  }else{tgt.style.display='none';G.target=null;}
}

// INVENTORY UPDATE
// ============ CONTEXT MENU SYSTEM ============
let _ctxIdx=-1,_ctxSlot=null;
function showCtxMenu(x,y,title,options){
  const menu=document.getElementById('ctx-menu');
  const titleEl=document.getElementById('ctx-title');
  const optsEl=document.getElementById('ctx-opts');
  titleEl.textContent=title;optsEl.innerHTML='';
  options.forEach(opt=>{
    if(opt.sep){const s=document.createElement('div');s.className='ctx-sep';optsEl.appendChild(s);return;}
    const d=document.createElement('div');
    d.className='ctx-opt'+(opt.danger?' danger':'');
    d.innerHTML='<span class="ctx-icon">'+(opt.icon||'')+'</span>'+opt.label;
    d.addEventListener('click',()=>{hideCtxMenu();opt.fn();});
    optsEl.appendChild(d);
  });
  menu.style.display='block';
  const mw=menu.offsetWidth,mh=menu.offsetHeight;
  const vw=window.innerWidth,vh=window.innerHeight;
  menu.style.left=Math.min(x,vw-mw-8)+'px';
  menu.style.top=Math.min(y,vh-mh-8)+'px';
}
function hideCtxMenu(){document.getElementById('ctx-menu').style.display='none';_ctxIdx=-1;_ctxSlot=null;}
document.addEventListener('click',e=>{if(!e.target.closest('#ctx-menu'))hideCtxMenu();});
document.addEventListener('contextmenu',e=>{if(!e.target.closest('.is')&&!e.target.closest('.es'))hideCtxMenu();});

function ctxInvItem(idx,e){
  e.preventDefault();hideCtxMenu();
  const p=G.player;const it=p.inv[idx];if(!it)return;
  const dd=ITEMS[it.id];
  const opts=[];
  if(dd.s){opts.push({icon:'\u2694',label:'Equip',fn:()=>{const old=p.eq[dd.s];p.eq[dd.s]=it.id;p.inv.splice(idx,1);if(old)p.addItem(old);msg('Equipped '+dd.n,'system');updInv();triggerSave();}});}
  if(dd.t==='potion'||dd.t==='food'){
    const canUse=!dd.vocs||dd.vocs.includes(p.voc);
    const vocTag=dd.vocs?' ['+dd.vocs.join('/')+']':'';
    if(!canUse){opts.push({icon:'\u26D4',label:'Restricted'+vocTag,cls:'danger',fn:()=>{msg('Your vocation cannot use '+dd.n+'!','system');}});}
    else{
      if(dd.heal)opts.push({icon:'\u2764',label:'Use (HP+'+(dd.heal)+')',fn:()=>{p.hp=Math.min(p.mhp,p.hp+dd.heal);floatText(p.x,p.y,'+'+dd.heal,'#4f4');if(dd.mana){p.mp=Math.min(p.mmp,p.mp+dd.mana);floatText(p.x,p.y,'+'+dd.mana,'#44f');}p.rmItem(idx);updInv();}});
      else if(dd.mana)opts.push({icon:'\u2728',label:'Use (MP+'+(dd.mana)+')',fn:()=>{p.mp=Math.min(p.mmp,p.mp+dd.mana);floatText(p.x,p.y,'+'+dd.mana,'#44f');p.rmItem(idx);updInv();}});
      if(it.q>1)opts.push({icon:'\u26A1',label:'Use All ('+it.q+'x)',fn:()=>{if(dd.vocs&&!dd.vocs.includes(p.voc)){msg('Your vocation cannot use '+dd.n+'!','system');return;}for(let i=0;i<it.q;i++){if(dd.heal)p.hp=Math.min(p.mhp,p.hp+dd.heal);if(dd.mana)p.mp=Math.min(p.mmp,p.mp+dd.mana);}floatText(p.x,p.y,'Full!','#4f4');p.rmItem(idx,it.q);updInv();}});
    }
  }
  if(dd.t==='training'){const ch=it.charges!==undefined?it.charges:dd.charges;opts.push({icon:'\u2694',label:'Train ('+ch+' charges)',fn:()=>{if(!isPrem()){msg('Training requires Premium Account!','system');return;}const nearDummy=G.npcs.find(n=>n.type==='trainer_dummy'&&Math.abs(n.x-p.x)<=2&&Math.abs(n.y-p.y)<=2);if(!nearDummy){msg('You need to be near a Training Dummy to use this!','system');return;}startTraining(idx,nearDummy);}});}
  if(dd.t==='potion'||dd.t==='food'){
    opts.push({sep:true});
    const curHpKey=Object.entries(G.hotkeys).find(([k,v])=>k==='hp_pot');
    const curMpKey=Object.entries(G.hotkeys).find(([k,v])=>k==='mp_pot');
    if(dd.heal)opts.push({icon:'\u2328',label:'Set as HP Hotkey ['+G.hotkeys.hp_pot+']',fn:()=>{assignItemHotkey('hp_pot',dd.n);}});
    if(dd.mana&&!dd.heal)opts.push({icon:'\u2328',label:'Set as MP Hotkey ['+G.hotkeys.mp_pot+']',fn:()=>{assignItemHotkey('mp_pot',dd.n);}});
  }
  if(G.shop){opts.push({sep:true});opts.push({icon:'\uD83D\uDCB0',label:'Sell ('+Math.floor(dd.p/3)+'g)',fn:()=>{sellItem(idx);}});}
  if(it.q>1){
    opts.push({sep:true});
    opts.push({icon:'\uD83D\uDCE6',label:'Split Stack (half)',fn:()=>{const half=Math.floor(it.q/2);if(half<1)return;it.q-=half;if(!p.addItem(it.id,half)){it.q+=half;msg('Inventory full!','system');}updInv();}});
  }
  opts.push({sep:true});
  opts.push({icon:'\u2139',label:'Info: '+dd.n,fn:()=>{
    let info=dd.n+' | '+dd.d;
    if(dd.atk)info+=' | ATK:'+dd.atk;if(dd.matk)info+=' | MATK:'+dd.matk;if(dd.def)info+=' | DEF:'+dd.def;
    if(dd.heal)info+=' | Heal:'+dd.heal;if(dd.mana)info+=' | Mana:'+dd.mana;
    if(dd.spd)info+=' | Speed:'+dd.spd;if(dd.premium)info+=' | PREMIUM';
    info+=' | Value: '+dd.p+'g | Sell: '+Math.floor(dd.p/3)+'g';
    if(it.q>1)info+=' | Qty: '+it.q;
    msg(info,'system');
  }});
  if(it.q>1){
    opts.push({icon:'\uD83D\uDDD1',label:'Discard 1x',danger:true,fn:()=>{p.rmItem(idx,1);msg('Discarded 1x '+dd.n,'system');updInv();triggerSave();}});
    opts.push({icon:'\u274C',label:'Discard All ('+it.q+'x)',danger:true,fn:()=>{p.rmItem(idx,it.q);msg('Discarded '+it.q+'x '+dd.n,'system');updInv();triggerSave();}});
  }else{
    opts.push({icon:'\uD83D\uDDD1',label:'Discard',danger:true,fn:()=>{p.rmItem(idx,1);msg('Discarded '+dd.n,'system');updInv();triggerSave();}});
  }
  showCtxMenu(e.clientX,e.clientY,dd.n+(it.q>1?' ('+it.q+'x)':''),opts);
}

function ctxEqSlot(slotKey,slotLabel,e){
  e.preventDefault();hideCtxMenu();
  const p=G.player;if(!slotKey||!p.eq[slotKey])return;
  const itemId=p.eq[slotKey];const dd=ITEMS[itemId];
  const opts=[];
  opts.push({icon:'\u21A9',label:'Unequip',fn:()=>{if(!p.addItem(itemId)){msg('Inventory full!','system');return;}p.eq[slotKey]=null;msg('Unequipped '+dd.n,'system');updInv();triggerSave();}});
  if(itemId==='soft_boots'||itemId==='firewalker_boots'){
    const ch=p.softBootCharges||0;opts.push({icon:'\u26A1',label:'Tempo: '+Math.floor(ch*2/60)+'min/480min',fn:()=>{msg(dd.n+': '+Math.floor(ch*2/60)+' minutos restantes ('+Math.floor(ch/14400*100)+'%)','system');}});
  }
  opts.push({sep:true});
  opts.push({icon:'\u2139',label:'Info',fn:()=>{
    let info=dd.n+' | '+dd.d;
    if(dd.atk)info+=' | ATK:'+dd.atk;if(dd.matk)info+=' | MATK:'+dd.matk;if(dd.def)info+=' | DEF:'+dd.def;
    if(dd.spd)info+=' | Speed:'+dd.spd;if(dd.premium)info+=' | PREMIUM';
    info+=' | Value: '+dd.p+'g';
    msg(info,'system');
  }});
  showCtxMenu(e.clientX,e.clientY,dd.n+' ('+slotLabel+')',opts);
}

function updInv(){
  const p=G.player;if(!p)return;
  const eg=document.getElementById('eqg');eg.innerHTML='';
  // Tibia-style 3x4 body layout: Row1=[amulet,helmet,backpack] Row2=[shield,armor,weapon] Row3=[ring,legs,empty] Row4=[empty,boots,empty]
  const layout=[
    {s:'amulet',l:'Amulet',icon:'&#128141;'},{s:'helmet',l:'Helmet'},{s:null,l:'Backpack',icon:'&#127890;'},
    {s:'shield',l:'Shield'},{s:'armor',l:'Armor'},{s:'weapon',l:'Weapon'},
    {s:'ring',l:'Ring',icon:'&#128141;'},{s:'legs',l:'Legs'},{s:null,l:'',icon:''},
    {s:null,l:'',icon:''},{s:'boots',l:'Boots'},{s:null,l:'',icon:''}
  ];
  layout.forEach(sl=>{
    const d=document.createElement('div');
    const hasItem=sl.s&&p.eq[sl.s];
    d.className='es'+(hasItem?' f':'');
    const it=hasItem?ITEMS[p.eq[sl.s]]:null;
    if(it){d.innerHTML=it.i+'<span class="sl">'+sl.l+'</span>';d.title=it.n+' ('+it.d+')';}
    else{d.innerHTML=(sl.icon||'')+'<span class="sl">'+sl.l+'</span>';d.title=sl.l;}
    if(!sl.s&&!sl.l){d.style.cssText='visibility:hidden;';} // empty spacer
    if(sl.s){d.addEventListener('click',()=>{
      if(p.eq[sl.s]){p.addItem(p.eq[sl.s]);p.eq[sl.s]=null;msg('Unequipped '+sl.l,'system');updInv();}
    });d.addEventListener('contextmenu',e=>{ctxEqSlot(sl.s,sl.l,e);});}
    eg.appendChild(d);
  });
  const ig=document.getElementById('ivg');ig.innerHTML='';
  for(let i=0;i<30;i++){
    const d=document.createElement('div');d.className='is';
    const it=p.inv[i];
    if(it){
      const dd=ITEMS[it.id];
      const chg=dd.t==='training'&&it.charges!==undefined?it.charges:0;
      d.innerHTML=dd.i+(it.q>1?'<span class="q">'+it.q+'</span>':'')+(chg>0?'<span class="q" style="color:#fa3">'+chg+'</span>':'');
      d.innerHTML+='<span class="tip">'+dd.n+(dd.atk?' ATK:'+dd.atk:'')+(dd.matk?' MATK:'+dd.matk:'')+(dd.def?' DEF:'+dd.def:'')+(dd.heal?' HP:+'+dd.heal:'')+(dd.mana?' MP:+'+dd.mana:'')+(chg>0?' Charges:'+chg:'')+' | '+dd.p+'g</span>';
      const idx=i;
      d.addEventListener('click',()=>{
        if(dd.s){
          const old=p.eq[dd.s];p.eq[dd.s]=it.id;p.inv.splice(idx,1);
          if(old)p.addItem(old);msg('Equipped '+dd.n,'system');updInv();
        }else if(dd.t==='potion'||dd.t==='food'){
          if(dd.heal){p.hp=Math.min(p.mhp,p.hp+dd.heal);floatText(p.x,p.y,'+'+dd.heal,'#4f4');}
          if(dd.mana){p.mp=Math.min(p.mmp,p.mp+dd.mana);floatText(p.x,p.y,'+'+dd.mana,'#44f');}
          p.rmItem(idx);updInv();
        }
      });
      d.addEventListener('contextmenu',e=>{ctxInvItem(idx,e);});
    }
    ig.appendChild(d);
  }
}

// MINIMAP
function renderMM(){
  const mc=document.getElementById('mm');if(!mc||!G.player)return;
  const ctx=mc.getContext('2d');
  const mw=mc.width,mh=mc.height;
  const map=G.maps[G.floor];if(!map)return;
  const mapW=map[0].length,mapH=map.length;
  ctx.fillStyle='#0a0a0a';ctx.fillRect(0,0,mw,mh);
  // Radar: show area around player, configurable zoom
  const scale=G.mmZoom;
  const viewTilesX=Math.floor(mw/scale),viewTilesY=Math.floor(mh/scale);
  const px=G.player.x,py=G.player.y;
  const startX=Math.max(0,Math.min(mapW-viewTilesX,px-Math.floor(viewTilesX/2)));
  const startY=Math.max(0,Math.min(mapH-viewTilesY,py-Math.floor(viewTilesY/2)));
  const colors={};colors[TT.G]='#3a7a28';colors[TT.D]='#a08050';colors[TT.W]='#1a44aa';colors[TT.TR]='#1a5a0a';
  colors[TT.WL]='#808080';colors[TT.FL]='#9a8a70';colors[TT.SA]='#d4bc80';colors[TT.CV]='#4a3a2a';
  colors[TT.CW]='#1a0a00';colors[TT.DR]='#8a6a20';colors[TT.TM]='#c0b090';colors[TT.IC]='#a8d8ea';
  colors[TT.LV]='#cc3300';colors[TT.MT]='#666';colors[TT.SW]='#2a4a2a';colors[TT.SWAMP]='#2a4a2a';
  colors[TT.BRIDGE]='#8a6a20';colors[TT.FARM]='#5a8a30';
  for(let dy=0;dy<viewTilesY;dy++){
    const my=startY+dy;if(my<0||my>=mapH)continue;
    for(let dx=0;dx<viewTilesX;dx++){
      const mx=startX+dx;if(mx<0||mx>=mapW)continue;
      const t=map[my][mx];
      if(t===TT.SU){ctx.fillStyle='#0f0';}
      else if(t===TT.SD){ctx.fillStyle='#f00';}
      else{ctx.fillStyle=colors[t]||'#333';}
      ctx.fillRect(dx*scale,dy*scale,scale,scale);
    }
  }
  // Draw stairs labels
  ctx.font='bold 9px "Press Start 2P"';
  STAIRS.forEach(s=>{
    if(s.fx!==G.floor)return;
    const sx2=(s.x-startX)*scale,sy2=(s.y-startY)*scale;
    if(sx2<0||sx2>mw||sy2<0||sy2>mh)return;
    const lbl=s.dir==='up'?'UP':'DN';
    ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(sx2-1,sy2-10,22,12);
    ctx.fillStyle=s.dir==='up'?'#0f0':'#f00';
    ctx.fillText(lbl,sx2+1,sy2-1);
  });
  // Draw entities
  G.mons.forEach(m=>{if(!m.alive)return;const ex=(m.x-startX)*scale,ey=(m.y-startY)*scale;if(ex>=0&&ex<mw&&ey>=0&&ey<mh){ctx.fillStyle='#f44';ctx.fillRect(ex,ey,scale,scale);}});
  G.npcs.forEach(n=>{const ex=(n.x-startX)*scale,ey=(n.y-startY)*scale;if(ex>=0&&ex<mw&&ey>=0&&ey<mh){ctx.fillStyle='#44f';ctx.fillRect(ex,ey,scale+1,scale+1);}});
  // Player: bright pulsing crosshair
  const cx=(px-startX)*scale,cy=(py-startY)*scale;
  const pulse=Math.sin(performance.now()/300)*0.3+0.7;
  const alpha=Math.floor(pulse*255).toString(16).padStart(2,'0');
  ctx.fillStyle='#ffffff'+alpha;ctx.fillRect(cx-1,cy-1,scale+2,scale+2);
  ctx.strokeStyle='#ffff00';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(cx+1,cy-5);ctx.lineTo(cx+1,cy-1);ctx.stroke();
  ctx.beginPath();ctx.moveTo(cx+1,cy+scale+1);ctx.lineTo(cx+1,cy+scale+5);ctx.stroke();
  ctx.beginPath();ctx.moveTo(cx-5,cy+1);ctx.lineTo(cx-1,cy+1);ctx.stroke();
  ctx.beginPath();ctx.moveTo(cx+scale+1,cy+1);ctx.lineTo(cx+scale+5,cy+1);ctx.stroke();
  // Auto-walk destination marker
  if(G.autoTarget){
    const tx=(G.autoTarget.x-startX)*scale,ty=(G.autoTarget.y-startY)*scale;
    if(tx>=0&&tx<mw&&ty>=0&&ty<mh){
      const tp=Math.sin(performance.now()/250)*0.4+0.6;
      ctx.strokeStyle='rgba(255,50,50,'+tp+')';ctx.lineWidth=2;
      ctx.beginPath();ctx.arc(tx+scale/2,ty+scale/2,scale*2+3,0,Math.PI*2);ctx.stroke();
      ctx.fillStyle='rgba(255,50,50,'+tp+')';ctx.fillRect(tx,ty,Math.max(scale,2),Math.max(scale,2));
    }
  }
  // Coordinates label
  ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(0,mh-12,mw,12);
  ctx.fillStyle='#f0c040';ctx.font='7px "Press Start 2P"';ctx.textAlign='center';
  ctx.fillText(px+', '+py+' | '+FLOOR_INFO[G.floor].name,mw/2,mh-3);
  ctx.textAlign='left';
}

// INPUT
function useHpPot(){
  const p=G.player;if(!p)return;
  const pot=p.inv.findIndex(i=>{const d=ITEMS[i.id];return d&&d.heal&&d.t==='potion'&&(!d.vocs||d.vocs.includes(p.voc));});
  if(pot>=0){const d=ITEMS[p.inv[pot].id];p.hp=Math.min(p.mhp,p.hp+d.heal);floatText(p.x,p.y,'+'+d.heal,'#4f4');if(d.mana){p.mp=Math.min(p.mmp,p.mp+d.mana);floatText(p.x,p.y,'+'+d.mana,'#44f');}p.rmItem(pot);updInv();}
}
function useMpPot(){
  const p=G.player;if(!p)return;
  const pot=p.inv.findIndex(i=>{const d=ITEMS[i.id];return d&&d.mana&&d.t==='potion'&&(!d.vocs||d.vocs.includes(p.voc));});
  if(pot>=0){const d=ITEMS[p.inv[pot].id];p.mp=Math.min(p.mmp,p.mp+d.mana);floatText(p.x,p.y,'+'+d.mana,'#44f');if(d.heal){p.hp=Math.min(p.mhp,p.hp+d.heal);floatText(p.x,p.y,'+'+d.heal,'#4f4');}p.rmItem(pot);updInv();}
}
function assignItemHotkey(action,itemName){
  G.editingHotkey=true;
  msg('Press a key to assign as hotkey for '+itemName+' ('+action.replace('_',' ')+')...','system');
  const handler=function(ev){ev.preventDefault();ev.stopPropagation();
    G.hotkeys[action]=ev.key;saveHotkeys();
    msg(itemName+' hotkey set to ['+ev.key+']','system');
    G.editingHotkey=false;updSpells();
    document.removeEventListener('keydown',handler,true);
  };
  document.addEventListener('keydown',handler,true);
  setTimeout(()=>{if(G.editingHotkey){G.editingHotkey=false;document.removeEventListener('keydown',handler,true);msg('Hotkey assignment cancelled (timeout)','system');}},5000);
}
function assignSpellHotkey(spellIdx,spellName){
  const action='spell'+(spellIdx+1);
  G.editingHotkey=true;
  msg('Press a key to assign as hotkey for '+spellName+'...','system');
  const handler=function(ev){ev.preventDefault();ev.stopPropagation();
    G.hotkeys[action]=ev.key;saveHotkeys();
    msg(spellName+' hotkey set to ['+ev.key+']','system');
    G.editingHotkey=false;updSpells();
    document.removeEventListener('keydown',handler,true);
  };
  document.addEventListener('keydown',handler,true);
  setTimeout(()=>{if(G.editingHotkey){G.editingHotkey=false;document.removeEventListener('keydown',handler,true);msg('Hotkey assignment cancelled (timeout)','system');}},5000);
}
function matchHotkey(ekey){
  const hk=G.hotkeys;
  for(let i=1;i<=8;i++){if(ekey===hk['spell'+i])return {type:'spell',idx:i-1};}
  if(ekey===hk.hp_pot)return {type:'hp_pot'};
  if(ekey===hk.mp_pot)return {type:'mp_pot'};
  return null;
}
function setupInput(){
  document.addEventListener('keydown',e=>{
    if(G.editingHotkey){e.preventDefault();return;}
    G.keys[e.key]=true;
    if(e.key==='Enter'){const ci=document.getElementById('chat-in');if(document.activeElement===ci){const t=ci.value.trim();if(t){if(t==='/unstuck'){msg('Teleporting to surface...','system');G.player.hp=G.player.mhp;G.player.mp=G.player.mmp;G.target=null;switchFloor(0,950,800);msg('Returned to temple!','system');}else{msg(G.player.name+': '+t,'system');}ci.value='';}ci.blur();}else ci.focus();e.preventDefault();}
    if(e.key==='Escape'){closeShop();closeSkills();closeHotkeys();document.getElementById('bless-ov').style.display='none';document.getElementById('prem-ov').style.display='none';}
    if(e.key==='m'||e.key==='M'){const mmw=document.getElementById('mm-wrap');G.mmap=!G.mmap;mmw.style.display=G.mmap?'block':'none';if(G.mmap)renderMM();}
    if(e.key==='k'||e.key==='K')openSkills();
    if(e.key==='h'||e.key==='H')openHotkeys();
    const action=matchHotkey(e.key);
    if(action){e.preventDefault();if(action.type==='spell')castSpell(action.idx);else if(action.type==='hp_pot')useHpPot();else if(action.type==='mp_pot')useMpPot();}
  });
  document.addEventListener('keyup',e=>{G.keys[e.key]=false;});
  G.cv.addEventListener('click',e=>{
    const rect=G.cv.getBoundingClientRect();
    const scaleX=G.cv.width/rect.width,scaleY=G.cv.height/rect.height;
    const cx=Math.floor((e.clientX-rect.left)*scaleX/TS),cy=Math.floor((e.clientY-rect.top)*scaleY/TS);
    const camX=Math.max(0,Math.min(MW-VW,G.player.x-Math.floor(VW/2)));
    const camY=Math.max(0,Math.min(MH-VH,G.player.y-Math.floor(VH/2)));
    const mx=camX+cx,my=camY+cy;
    const mob=monAt(mx,my);if(mob){G.target=mob;msg(`Alvo: ${MONS[mob.t].n}`,'system');return;}
    const npc=npcAt(mx,my);if(npc){interactNPC(npc);return;}
    G.target=null;
    if(canW(mx,my)&&(mx!==G.player.x||my!==G.player.y)){const path=findPath(G.player.x,G.player.y,mx,my);if(path&&path.length>0){G.autoPath=path;G.autoTarget={x:mx,y:my};}else{G.autoPath=null;G.autoTarget=null;}}
  });
  G.cv.addEventListener('contextmenu',e=>e.preventDefault());
}

// SPAWN
const PREM_ZONES={f11:{x:0,y:0,w:100,h:80,c:[{id:'dragon',n:10},{id:'dragon_lord',n:8},{id:'hydra',n:6},{id:'serpent_spawn',n:5}]},f12:{x:0,y:0,w:100,h:80,c:[{id:'demon',n:10},{id:'hellhound',n:8},{id:'lich',n:6},{id:'warlock',n:5}]},f13:{x:0,y:0,w:100,h:80,c:[{id:'juggernaut',n:6},{id:'undead_dragon',n:5},{id:'demon',n:6},{id:'dragon_lord',n:4},{id:'hydra',n:4}]}};
const TOWER_ZONES={f14:{x:10,y:10,w:80,h:60,c:[{id:'fire_sprite',n:16}]},f15:{x:10,y:10,w:80,h:60,c:[{id:'lava_golem',n:14}]},f16:{x:10,y:10,w:80,h:60,c:[{id:'fire_elemental',n:12}]},f17:{x:10,y:10,w:80,h:60,c:[{id:'inferno_guardian',n:10}]},f18:{x:10,y:10,w:80,h:60,c:[{id:'flame_lord',n:6}]},f19:{x:10,y:10,w:80,h:60,c:[{id:'ice_sprite',n:16}]},f20:{x:10,y:10,w:80,h:60,c:[{id:'frost_golem',n:14}]},f21:{x:10,y:10,w:80,h:60,c:[{id:'blizzard_elemental',n:12}]},f22:{x:10,y:10,w:80,h:60,c:[{id:'glacier_guardian',n:10}]},f23:{x:10,y:10,w:80,h:60,c:[{id:'frost_wyrm',n:6}]},f24:{x:10,y:10,w:80,h:60,c:[{id:'swamp_toad',n:16}]},f25:{x:10,y:10,w:80,h:60,c:[{id:'decay_crawler',n:14}]},f26:{x:10,y:10,w:80,h:60,c:[{id:'poison_beast',n:12}]},f27:{x:10,y:10,w:80,h:60,c:[{id:'nature_wraith',n:10}]},f28:{x:10,y:10,w:80,h:60,c:[{id:'swamp_hydra',n:6}]},f29:{x:10,y:10,w:80,h:60,c:[{id:'shadow_wisp',n:16}]},f30:{x:10,y:10,w:80,h:60,c:[{id:'umbral_wraith',n:14}]},f31:{x:10,y:10,w:80,h:60,c:[{id:'void_stalker',n:12}]},f32:{x:10,y:10,w:80,h:60,c:[{id:'shadow_lord',n:10}]},f33:{x:10,y:10,w:80,h:60,c:[{id:'void_dragon',n:6}]}};
function getFloorZones(f){
  const out=[];
  for(const[k,z] of Object.entries(ZONES)){
    if(f===0&&k.startsWith('f0_'))out.push(z);
    else if(k==='f'+f&&!k.startsWith('f0'))out.push(z);
  }
  for(const[k,z] of Object.entries(PREM_ZONES)){
    if(k==='f'+f)out.push(z);
  }
  for(const[k,z] of Object.entries(TOWER_ZONES)){
    if(k==='f'+f)out.push(z);
  }
  return out;
}
function spawnMons(){
  const zones=getFloorZones(G.floor);const used=new Set();
  zones.forEach(z=>{z.c.forEach(cr=>{for(let i=0;i<cr.n;i++){let x,y,tr=0;do{x=z.x+Math.floor(Math.random()*z.w);y=z.y+Math.floor(Math.random()*z.h);tr++;}while((!canW(x,y)||used.has(x+','+y))&&tr<50);if(tr<50){used.add(x+','+y);G.mons.push(new Mon(cr.id,x,y));}}});});
  rebuildMonGrid();
}
let lastDynSpawn=0;
function dynamicSpawn(n){
  const isTower=G.floor>=14&&G.floor<=33;
  const spawnInterval=isTower?5000:7000;
  if(n-lastDynSpawn<spawnInterval)return;lastDynSpawn=n;
  const before=G.mons.length;G.mons=G.mons.filter(m=>m.alive);if(G.mons.length>120)return;
  const zones=getFloorZones(G.floor);
  const counts={};G.mons.forEach(m=>{if(m.alive){const k=m.t+'|'+Math.floor(m.x/100)+'|'+Math.floor(m.y/80);counts[k]=(counts[k]||0)+1;}});
  zones.forEach(z=>{z.c.forEach(cr=>{
    const k=cr.id+'|'+Math.floor(z.x/100)+'|'+Math.floor(z.y/80);
    const alive=counts[k]||0;
    const spawnChance=isTower?0.6:0.4;
    if(alive<cr.n&&Math.random()<spawnChance){
      let x,y,tr=0;
      do{x=z.x+Math.floor(Math.random()*z.w);y=z.y+Math.floor(Math.random()*z.h);tr++;}
      while((!canW(x,y)||monAt(x,y)||(G.player&&Math.abs(G.player.x-x)+Math.abs(G.player.y-y)<5))&&tr<50);
      if(tr<50){const m=new Mon(cr.id,x,y);m.spawnAnim=n;G.mons.push(m);}
    }
  });});
  rebuildMonGrid();
}

// SERVER-SIDE AUTHORITATIVE ACTIONS
async function sendAction(type, data={}) {
  const charId = G.player && G.player._charId;
  if (!charId || !sessionToken) return null;
  try {
    const res = await fetch(location.origin + '/player/action', {
      method: 'POST',
      headers: {'Content-Type':'application/json','Authorization':'Bearer '+sessionToken},
      body: JSON.stringify({charId, action: {type, ...data}})
    });
    if (!res.ok) return null;
    const result = await res.json();
    if (result.success) return result.result;
    if (result.error) msg(result.error, 'system');
    return null;
  } catch(e) { console.warn('sendAction failed:', e); return null; }
}

async function loadPlayerState(charId) {
  if (!sessionToken) return null;
  try {
    const res = await fetch(location.origin + '/player/load', {
      method: 'POST',
      headers: {'Content-Type':'application/json','Authorization':'Bearer '+sessionToken},
      body: JSON.stringify({charId, data: null})
    });
    if (!res.ok) return null;
    return await res.json();
  } catch(e) { return null; }
}

function applyServerState(result) {
  if (!result || !G.player) return;
  const p = G.player;
  if (result.gold !== undefined) p.gold = result.gold;
  if (result.xp !== undefined) p.xp = result.xp;
  if (result.lv !== undefined && result.lv > p.lv) {
    p.lv = result.lv;
    if (result.mhp) p.mhp = result.mhp;
    if (result.mmp) p.mmp = result.mmp;
    if (result.batk) p.batk = result.batk;
    if (result.bdef) p.bdef = result.bdef;
    p.hp = p.mhp; p.mp = p.mmp;
    msg('LEVEL UP! Level ' + p.lv + '!', 'level');
  }
  if (result.hp !== undefined) p.hp = Math.min(result.hp, p.mhp);
  if (result.mp !== undefined) p.mp = Math.min(result.mp, p.mmp);
  if (result.inv) p.inv = result.inv;
  if (result.eq) p.eq = result.eq;
  if (result.quests) G.quests = result.quests;
  if (result.kills) G.kills = result.kills;
  if (result.spells) { p.spells = result.spells; updSpells(); }
  if (result.premium) p.premium = result.premium;
  if (result.blessings) p.blessings = result.blessings;
  if (result.skills) p.skills = result.skills;
  if (result.skillXp) p.skillXp = result.skillXp;
  updInv();
}

// MULTIPLAYER WEBSOCKET
let ws=null;
let wsMyId=null;
let wsReconnectTimer=null;
let wsFloor=-1;

function wsConnect(floor){
  if(ws&&ws.readyState<=1&&wsFloor===floor)return; // already connected to this floor
  wsDisconnect();
  wsFloor=floor;
  const proto=location.protocol==='https:'?'wss:':'ws:';
  const url=proto+'//'+location.host+'/ws?floor='+floor;
  try{
    ws=new WebSocket(url);
  }catch(e){console.warn('WS connect failed:',e);return;}
  ws.onopen=()=>{
    console.log('WS connected to floor',floor);
    if(G.player){
      ws.send(JSON.stringify({t:'j',name:G.player.name,voc:G.player.voc,lv:G.player.lv,x:G.player.x,y:G.player.y,dir:G.player.dir}));
    }
  };
  ws.onmessage=(e)=>{
    try{
      const msg=JSON.parse(e.data);
      switch(msg.t){
        case 'init': // initial state with existing players
          wsMyId=msg.id;
          G.otherPlayers=msg.players||[];
          break;
        case 'j': // player joined
          if(msg.p&&msg.p.id!==wsMyId){
            const idx=G.otherPlayers.findIndex(p=>p.id===msg.p.id);
            if(idx>=0)G.otherPlayers[idx]=msg.p;
            else G.otherPlayers.push(msg.p);
          }
          break;
        case 'm': // player moved
          if(msg.id!==wsMyId){
            const op=G.otherPlayers.find(p=>p.id===msg.id);
            if(op){op.x=msg.x;op.y=msg.y;op.dir=msg.d;}
          }
          break;
        case 'l': // player left
          G.otherPlayers=G.otherPlayers.filter(p=>p.id!==msg.id);
          break;
        case 'p': break; // pong
      }
    }catch(ex){}
  };
  ws.onclose=()=>{
    G.otherPlayers=[];
    if(!wsReconnectTimer)wsReconnectTimer=setTimeout(()=>{wsReconnectTimer=null;if(G.player)wsConnect(G.floor);},3000);
  };
  ws.onerror=()=>{};
}

function wsDisconnect(){
  if(ws){try{ws.close();}catch(e){}ws=null;}
  G.otherPlayers=[];
}

function wsSendMove(){
  if(ws&&ws.readyState===1&&G.player){
    ws.send(JSON.stringify({t:'m',x:G.player.x,y:G.player.y,dir:G.player.dir,lv:G.player.lv}));
  }
}

function wsSwitchFloor(newFloor){
  wsDisconnect();
  wsConnect(newFloor);
}

// Heartbeat every 5s
setInterval(()=>{if(ws&&ws.readyState===1)ws.send(JSON.stringify({t:'p'}));},5000);
// Sync state with server every 60 seconds
setInterval(async () => {
  if (!G.player || !G.player._charId || !sessionToken) return;
  const r = await sendAction('save');
}, 60000);

function updatePlayerList(){
  const cont=document.getElementById('player-panel');if(!cont||!G.player)return;
  const icons={knight:'&#9876;',paladin:'&#127993;',mage:'&#9733;'};
  const online=G.otherPlayers.length+1;
  let html='<div class="pe" style="color:#8f8;margin-bottom:2px;font-size:5px;">'+online+' online</div>';
  html+='<div class="pe">'+icons[G.player.voc]+' '+G.player.name+' Lv'+G.player.lv+'</div>';
  G.otherPlayers.forEach(op=>{html+='<div class="pe" style="color:#4af;">'+icons[op.voc||'knight']+' '+(op.name||'Player')+' Lv'+(op.lv||1)+'</div>';});
  cont.innerHTML=html;
}

// DEATH/RESPAWN
function resp(){
  const p=G.player;
  const bCount=p.blessings?p.blessings.length:0;
  const xpLoss=bCount>=5?0.02:bCount>=3?0.05:0.10;
  p.xp=Math.max(0,Math.floor(p.xp*(1-xpLoss)));
  // Check Amulet of Loss
  const amuletEquipped=p.eq.amulet?ITEMS[p.eq.amulet]:null;
  const hasAmuletOfLoss=amuletEquipped&&amuletEquipped.onDeath==='prevent_loss';
  // Without blessings: lose a random equipped item (unless Amulet of Loss)
  if(bCount===0){
    if(hasAmuletOfLoss){
      msg('Your Amulet of Loss protected your equipment!','quest');
      p.eq.amulet=null; // Amulet is consumed
      msg('The Amulet of Loss shattered!','combat');
    }else{
      const slots=['helmet','armor','weapon','shield','legs','boots','amulet','ring'];
      const equipped=slots.filter(s=>p.eq[s]!==null);
      if(equipped.length>0){
        const lostSlot=equipped[Math.floor(Math.random()*equipped.length)];
        const lostId=p.eq[lostSlot];
        const lostName=ITEMS[lostId]?ITEMS[lostId].n:lostId;
        p.eq[lostSlot]=null;
        msg('You lost your '+lostName+' on death!','combat');
      }
    }
  }
  if(bCount>0){p.blessings=[];msg('Lost all blessings on death!','combat');}
  p.hp=p.mhp;p.mp=p.mmp;G.target=null;
  document.getElementById('death-ov').style.display='none';
  switchFloor(0,950,800);
  msg('Respawned at the temple.','system');
  updInv();triggerSave();
}

// GAME LOOP
function loop(n){
  if(!G.player||G.player.hp<=0){requestAnimationFrame(loop);return;}
  if(!G.shop)handleMov(n);
  if(G.target&&G.target.alive)atkTgt();
  rebuildMonGrid();{const px=G.player.x,py=G.player.y;G.mons.forEach(m=>{if(!m.alive)return;const d=Math.abs(m.x-px)+Math.abs(m.y-py);if(d>20)return;m.update(n);});}
  G.player.regen(n);
  tickSoftBoots(n);
  tickTraining(n);
  dynamicSpawn(n);if(G.tick%60===0){checkPremExpiry();_integrityCheck();_rateCheck();}
  autoSave(n);
  render();updHUD();
  if(G.tick%20===0){updInv();renderMM();updSpells();updQuests();updatePlayerList();}
  G.tick++;requestAnimationFrame(loop);
}
// ===== BACKEND API CLIENT =====
const API_URL='https://megarealms-api.warlet-invest.workers.dev';
let sessionToken=null;
let lastBackendSave=0;
const BACKEND_SAVE_INTERVAL=120000; // 2 minutes debounce for backend saves

const api={
  async request(method,path,body){
    if(!sessionToken)return null;
    try{
      const opts={method,headers:{'Content-Type':'application/json','Authorization':'Bearer '+sessionToken}};
      if(body)opts.body=JSON.stringify(body);
      const res=await fetch(API_URL+path,opts);
      if(!res.ok){
        if(res.status===401){sessionToken=null;console.warn('Session expired');}
        return null;
      }
      return await res.json();
    }catch(e){console.warn('API request failed:',e);return null;}
  },
  async getNonce(wallet){
    try{
      const res=await fetch(API_URL+'/auth/nonce?wallet='+encodeURIComponent(wallet));
      if(!res.ok)return null;
      return await res.json();
    }catch(e){console.warn('getNonce failed:',e);return null;}
  },
  async verifySignature(wallet,signature,nonceId){
    try{
      const res=await fetch(API_URL+'/auth/verify',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({wallet,signature,nonceId})
      });
      if(!res.ok)return null;
      return await res.json();
    }catch(e){console.warn('verifySignature failed:',e);return null;}
  },
  async listCharacters(){return await this.request('GET','/characters');},
  async saveCharacter(charId,data){return await this.request('POST','/characters/save',{charId,data});},
  async loadCharacter(charId){return await this.request('GET','/characters/'+charId);},
  async deleteCharacter(charId){return await this.request('DELETE','/characters/'+charId);}
};

async function backendAuth(wallet){
  try{
    const nonceData=await api.getNonce(wallet);
    if(!nonceData)return false;
    const message='Sign in to MegaRealms\nNonce: '+nonceData.nonce;
    const signature=await window.ethereum.request({method:'personal_sign',params:[message,wallet]});
    const result=await api.verifySignature(wallet,signature,nonceData.nonceId);
    if(result&&result.token){
      sessionToken=result.token;
      console.log('Backend auth successful');
      return true;
    }
    return false;
  }catch(e){
    console.warn('Backend auth failed:',e);
    return false;
  }
}

async function backendSaveIfNeeded(charId,data){
  if(!sessionToken)return;
  const now=Date.now();
  if(now-lastBackendSave<BACKEND_SAVE_INTERVAL)return;
  lastBackendSave=now;
  api.saveCharacter(charId,data).then(r=>{
    if(r&&r.success){
      const ind=document.getElementById('save-ind');
      ind.textContent='Synced \u2601';
      ind.classList.add('show');
      setTimeout(()=>{ind.classList.remove('show');ind.textContent='Saving...';},2000);
    }
  }).catch(()=>{});
}

// ===== SAVE SYSTEM =====
let SAVE_KEY='megarealms_save_';
let activeSlot=0;
let lastAutoSave=0;

function getCharListKey(){
  if(!walletAddr)return 'megarealms_charlist';
  return 'megarealms_'+walletAddr.toLowerCase()+'_charlist';
}

function getCharKey(charId){
  if(!walletAddr)return 'megarealms_char_'+charId;
  return 'megarealms_'+walletAddr.toLowerCase()+'_char_'+charId;
}

function getCharList(){
  try{
    const raw=localStorage.getItem(getCharListKey());
    return raw?JSON.parse(raw):[];
  }catch(e){return [];}
}

function saveCharList(list){
  try{localStorage.setItem(getCharListKey(),JSON.stringify(list));}catch(e){}
}

function generateCharId(){
  return Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,6);
}

function saveGame(slot){
  if(!G.player)return;
  const p=G.player;
  const charId=typeof slot==='string'?slot:p._charId;
  if(!charId)return;
  const data={
    v:3,ts:Date.now(),charId:charId,
    name:p.name,voc:p.voc,lv:p.lv,xp:p.xp,
    hp:Math.floor(p.hp),mhp:p.mhp,mp:Math.floor(p.mp),mmp:p.mmp,
    batk:p.batk,bdef:p.bdef,gold:p.gold,
    x:p.x,y:p.y,dir:p.dir,floor:G.floor,
    inv:p.inv,eq:p.eq,
    skills:p.skills,skillXp:p.skillXp,
    quests:G.quests.map(q=>({id:q.id,progress:q.progress,done:q.done})),
    kills:G.kills,spells:p.spells,_ck:_hash(p.name+p.voc+p.lv),
    premium:p.premium||{active:false,expiry:0,addr:''},
    blessings:p.blessings||[],softBootCharges:p.softBootCharges||0,
  };
  try{
    localStorage.setItem(getCharKey(charId),JSON.stringify(data));
    // Update char list metadata
    const list=getCharList();
    const idx=list.findIndex(c=>c.id===charId);
    const meta={id:charId,name:p.name,voc:p.voc,lv:p.lv,gold:p.gold,ts:Date.now()};
    if(idx>=0)list[idx]=meta;else list.push(meta);
    saveCharList(list);
    showSaveInd();
    // Backend save (async, debounced)
    backendSaveIfNeeded(charId,data);
  }catch(e){console.error('Save failed:',e);}
}

function loadGame(charId){
  const raw=localStorage.getItem(getCharKey(charId));
  if(!raw)return null;
  try{return JSON.parse(raw);}catch(e){return null;}
}

async function loadGameWithBackend(charId){
  const localData=loadGame(charId);
  if(!sessionToken)return localData;
  try{
    const result=await api.loadCharacter(charId);
    if(result&&result.data){
      const backendData=result.data;
      // Use whichever has the more recent timestamp
      if(!localData)return backendData;
      if(backendData.ts>localData.ts){
        // Backend is newer ‚Äî also update localStorage
        localStorage.setItem(getCharKey(charId),JSON.stringify(backendData));
        return backendData;
      }
      return localData;
    }
  }catch(e){console.warn('Backend load failed, using local:',e);}
  return localData;
}

function deleteSave(charId){
  localStorage.removeItem(getCharKey(charId));
  const list=getCharList().filter(c=>c.id!==charId);
  saveCharList(list);
  // Also delete from backend (async, non-blocking)
  if(sessionToken)api.deleteCharacter(charId).catch(()=>{});
  renderSaveSlots();
}

function getSaves(){
  const list=getCharList();
  return list.sort((a,b)=>b.lv-a.lv||b.ts-a.ts);
}

function mergeBackendCharList(backendChars){
  // Merge backend character metadata with local list
  if(!backendChars||!backendChars.length)return;
  const localList=getCharList();
  let changed=false;
  for(const bc of backendChars){
    const localIdx=localList.findIndex(c=>c.id===bc.id);
    if(localIdx<0){
      // Character exists on backend but not locally ‚Äî add to local list
      localList.push({id:bc.id,name:bc.name,voc:bc.voc,lv:bc.lv,gold:bc.gold,ts:bc.ts});
      changed=true;
    }else if(bc.ts>localList[localIdx].ts){
      // Backend version is newer ‚Äî update local metadata
      localList[localIdx]={id:bc.id,name:bc.name,voc:bc.voc,lv:bc.lv,gold:bc.gold,ts:bc.ts};
      changed=true;
    }
  }
  if(changed)saveCharList(localList);
}

function migrateOldSaves(){
  if(!walletAddr)return;
  const oldKey='megarealms_'+walletAddr.toLowerCase()+'_save_';
  let migrated=false;
  for(let i=0;i<3;i++){
    const raw=localStorage.getItem(oldKey+i);
    if(!raw)continue;
    try{
      const data=JSON.parse(raw);
      const charId=generateCharId();
      data.charId=charId;
      localStorage.setItem(getCharKey(charId),JSON.stringify(data));
      const list=getCharList();
      list.push({id:charId,name:data.name,voc:data.voc,lv:data.lv,gold:data.gold,ts:data.ts||Date.now()});
      saveCharList(list);
      localStorage.removeItem(oldKey+i);
      migrated=true;
    }catch(e){}
  }
  return migrated;
}

function showSaveInd(){
  const ind=document.getElementById('save-ind');
  ind.textContent=sessionToken?'Saved \uD83D\uDCBE':'Saved';
  ind.classList.remove('synced');
  ind.classList.add('show');
  setTimeout(()=>ind.classList.remove('show'),1500);
}

function autoSave(n){
  if(!G.player||G.player.hp<=0||!G.player._charId)return;
  if(n-lastAutoSave<60000)return;
  lastAutoSave=n;
  saveGame(G.player._charId);
}

function triggerSave(){if(G.player&&G.player.hp>0&&G.player._charId)saveGame(G.player._charId);}

// ===== INIT FROM SAVE =====
function initFromSave(data){
  document.getElementById('start-screen').style.display='none';
  document.getElementById('game-screen').style.display='flex';
  document.getElementById('mm-wrap').style.display='block';
  SHEET=new Image();
  SHEET.onload=function(){buildTileSprites();};
  SHEET.onerror=function(){buildTileSprites();};
  SHEET.src='sprites.png';
  buildTileSprites();
  G.maps=[];G.mons=[];G.npcs=[];G.bags=[];G.floats=[];G.target=null;G.tick=0;G.otherPlayers=[];
  for(let f=0;f<FLOORS;f++)G.maps.push(genMap(f));
  G.floor=data.floor||0;
  G.player=new Player(data.name,data.voc);
  const p=G.player;
  p.lv=data.lv;p.xp=data.xp;
  p.hp=data.hp;p.mhp=data.mhp;p.mp=data.mp;p.mmp=data.mmp;
  p.batk=data.batk;p.bdef=data.bdef;p.gold=data.gold;
  p.x=data.x;p.y=data.y;p.dir=data.dir||2;
  p.inv=data.inv||[];p.eq={helmet:null,armor:null,weapon:null,shield:null,legs:null,boots:null,amulet:null,ring:null,...(data.eq||{})};
  p.skills=data.skills||{melee:10,distance:10,magic:0,shielding:10};
  p.skillXp=data.skillXp||{melee:0,distance:0,magic:0,shielding:0};
  if(data.voc==='sorcerer'||data.voc==='druid'){data.voc='mage';p.voc='mage';}if(data.spells)p.spells=data.spells;if(data.premium)p.premium=data.premium;if(data._ck)p._ck=data._ck;if(data.blessings)p.blessings=data.blessings;if(data.softBootCharges)p.softBootCharges=data.softBootCharges;
  p._charId=data._charId||data.charId||generateCharId();
  migrateSpells();
  G.quests=(data.quests||[]).map(q=>{const qd=QUEST_DEFS.find(d=>d.id===q.id);return qd?{...qd,progress:q.progress,done:q.done}:null;}).filter(Boolean);
  G.kills=data.kills||{};
  G.cv=document.getElementById('gc');G.cx=G.cv.getContext('2d');
  function resize(){const mid=document.getElementById('mid');const w=mid.clientWidth-260,h=mid.clientHeight;G.cv.width=VW*TS;G.cv.height=VH*TS;G.cv.style.width=w+'px';G.cv.style.height=h+'px';}
  setTimeout(resize,50);window.addEventListener('resize',resize);
  spawnMons();placeNPCs();setupInput();updInv();updSpells();updQuests();updSkills();updPremInd();updPremInd();
  const fi=FLOOR_INFO[G.floor];
  const ind=document.getElementById('floor-ind');
  ind.className=fi.cls;ind.querySelector('.fi-icon').innerHTML=fi.icon;
  document.getElementById('fl-name').textContent=fi.name;
  ind.querySelector('.fi-name').textContent='Floor '+(G.floor===0?'0':'-'+G.floor);
  msg('Welcome back, '+p.name+'!','system');msg('Anti-cheat system active. Exploits are logged.','system');wsConnect(G.floor);
  if(p.name==='Mike Kina'&&!p._devGold){p.gold+=150000;p._devGold=true;msg('Dev bonus: +150,000 gold granted!','level');triggerSave();}
  msg(`Level ${p.lv} | ${p.gold} gold`,'system');
  loadPlayerState(p._charId).then(r => {
    if (r && r.player) {
      applyServerState(r.player);
      msg('State synced with server', 'system');
    }
  });
  requestAnimationFrame(loop);
}

// ===== RENDER SAVE SLOTS =====
function renderSaveSlots(){
  const cont=document.getElementById('save-slots');cont.innerHTML='';
  const chars=getSaves();
  const vocIcons={knight:'&#9876;',paladin:'&#127993;',mage:'&#9733;'};
  if(chars.length===0){
    cont.innerHTML='<div style="font-size:7px;color:#666;text-align:center;padding:20px;">No characters found.<br>Create your first character!</div>';
    showNewCharView();
    return;
  }
  const listView=document.getElementById('char-list-view');
  const newView=document.getElementById('tab-new');
  if(listView)listView.style.display='block';
  if(newView)newView.style.display='none';
  for(const c of chars){
    const div=document.createElement('div');
    div.className='save-slot';
    const dt=new Date(c.ts);
    const timeStr=dt.toLocaleDateString()+' '+dt.toLocaleTimeString().slice(0,5);
    const lvColor=c.lv>=50?'#f44':c.lv>=30?'#fa3':c.lv>=15?'#4af':'#f0c040';
    div.innerHTML=`<span class="sv-icon">${vocIcons[c.voc]||'?'}</span><div class="sv-info"><div class="sv-name">${c.name} <span style="color:${lvColor};">[Lv ${c.lv}]</span></div><div class="sv-detail">${c.voc} | ${c.gold}g | ${timeStr}</div></div>`;
    const del=document.createElement('button');del.className='sv-del';del.textContent='X';
    const charId=c.id;
    del.addEventListener('click',e=>{e.stopPropagation();if(confirm('Delete character '+c.name+'?'))deleteSave(charId);});
    div.appendChild(del);
    div.addEventListener('click',async()=>{
      div.style.opacity='0.5';div.style.pointerEvents='none';
      const data=sessionToken?await loadGameWithBackend(charId):loadGame(charId);
      div.style.opacity='1';div.style.pointerEvents='';
      if(data){data._charId=charId;initFromSave(data);}
    });
    cont.appendChild(div);
  }
}

function showNewCharView(){
  const listView=document.getElementById('char-list-view');
  const newView=document.getElementById('tab-new');
  if(listView)listView.style.display='none';
  if(newView)newView.style.display='block';
}

function showCharListView(){
  const listView=document.getElementById('char-list-view');
  const newView=document.getElementById('tab-new');
  if(listView)listView.style.display='block';
  if(newView)newView.style.display='none';
  renderSaveSlots();
}

function switchTab(tab){
  if(tab==='new')showNewCharView();
  else showCharListView();
}

// ===== BLOCKCHAIN / WALLET LOGIN =====
let walletAddr=null;
let charContract=null;

function getSaveKeyForWallet(addr){
  return 'megarealms_'+addr.toLowerCase()+'_save_';
}

async function loginWithWallet(){
  if(typeof window.ethereum==='undefined'){
    document.getElementById('login-status').innerHTML='<span style="color:#f44;">No wallet detected! Please install MetaMask or Rabby.</span>';
    return null;
  }
  try{
    document.getElementById('login-status').innerHTML='<span style="color:#f0c040;">Connecting wallet...</span>';
    const accs=await window.ethereum.request({method:'eth_requestAccounts'});
    walletAddr=accs[0];
    SAVE_KEY=getSaveKeyForWallet(walletAddr);
    migrateOldSaves();
    // Backend auth (sign message for persistent saves)
    document.getElementById('login-status').innerHTML='<span style="color:#f0c040;">Signing in to backend...</span>';
    const authOk=await backendAuth(walletAddr);
    if(authOk){
      document.getElementById('login-status').innerHTML='<span style="color:#4f4;">Backend connected!</span>';
    }else{
      document.getElementById('login-status').innerHTML='<span style="color:#fa3;">Offline mode ‚Äî saves are local only</span>';
    }
    document.getElementById('login-screen').style.display='none';
    document.getElementById('start-screen').style.display='block';
    const wbtn=document.getElementById('wbtn');
    const shortAddr=walletAddr.slice(0,6)+'...'+walletAddr.slice(-4);
    wbtn.textContent=shortAddr;
    wbtn.style.borderColor=authOk?'#4f4':'#fa3';
    document.getElementById('wallet-info').innerHTML='Connected: <b style="color:#f0c040;">'+shortAddr+'</b>'+(authOk?' <span style="color:#4f4;font-size:6px;">\u2601 Synced</span>':' <span style="color:#fa3;font-size:6px;">Local only</span>');
    // Load character list from backend if authenticated
    if(sessionToken){
      try{
        const backendChars=await api.listCharacters();
        if(backendChars&&backendChars.characters){
          mergeBackendCharList(backendChars.characters);
        }
      }catch(e){}
    }
    renderSaveSlots();
    return walletAddr;
  }catch(e){
    document.getElementById('login-status').innerHTML='<span style="color:#f44;">Connection refused. Please try again.</span>';
    return null;
  }
}

async function connectWallet(){
  if(walletAddr)return walletAddr;
  return await loginWithWallet();
}

async function syncToChain(){
  if(!walletAddr||!G.player)return;
  triggerSave();
}

async function loadFromChain(){
  if(!walletAddr)return;
  renderSaveSlots();
}

// ===== INIT GAME (new character) =====
function initGame(name,voc){
  document.getElementById('start-screen').style.display='none';
  document.getElementById('game-screen').style.display='flex';
  document.getElementById('mm-wrap').style.display='block';
  SHEET=new Image();
  SHEET.onload=function(){console.log('Spritesheet loaded');buildTileSprites();};
  SHEET.onerror=function(){console.log('Spritesheet not found, using fallback');buildTileSprites();};
  SHEET.src='sprites.png';
  buildTileSprites();
  G.maps=[];G.mons=[];G.npcs=[];G.bags=[];G.floats=[];G.target=null;G.tick=0;G.otherPlayers=[];
  for(let f=0;f<FLOORS;f++)G.maps.push(genMap(f));
  G.floor=0;
  G.player=new Player(name,voc);
  G.player._charId=generateCharId();
  G.cv=document.getElementById('gc');G.cx=G.cv.getContext('2d');
  function resize(){
    const mid=document.getElementById('mid');
    const w=mid.clientWidth-260,h=mid.clientHeight;
    G.cv.width=VW*TS;G.cv.height=VH*TS;
    G.cv.style.width=w+'px';G.cv.style.height=h+'px';
  }
  setTimeout(resize,50);
  window.addEventListener('resize',resize);
  spawnMons();placeNPCs();setupInput();updInv();updSpells();updQuests();updSkills();
  msg('Welcome to MegaRealms!','system');msg('Anti-cheat system active. Exploits are logged.','system');
  msg('WASD/Arrows=move | Click=attack | Spells=hotkeys','system');
  msg('M=map | K=skills | H=configure hotkeys','system');
  msg('Blue NPCs=shop | Orange=quest | White=heal','system');
  msg('Enter=chat | Right-click=sell item','system');
  wsConnect(G.floor);
  requestAnimationFrame(loop);
  setTimeout(()=>{
    saveGame(G.player._charId);
    // Force immediate backend save for new characters
    if(sessionToken){lastBackendSave=0;backendSaveIfNeeded(G.player._charId,{
      v:3,ts:Date.now(),charId:G.player._charId,name:G.player.name,voc:G.player.voc,
      lv:G.player.lv,xp:G.player.xp,hp:Math.floor(G.player.hp),mhp:G.player.mhp,
      mp:Math.floor(G.player.mp),mmp:G.player.mmp,batk:G.player.batk,bdef:G.player.bdef,
      gold:G.player.gold,x:G.player.x,y:G.player.y,dir:G.player.dir,floor:G.floor,
      inv:G.player.inv,eq:G.player.eq,skills:G.player.skills,skillXp:G.player.skillXp,
      quests:G.quests.map(q=>({id:q.id,progress:q.progress,done:q.done})),
      kills:G.kills,spells:G.player.spells,_ck:_hash(G.player.name+G.player.voc+G.player.lv),
      premium:G.player.premium||{active:false,expiry:0,addr:''},
      blessings:G.player.blessings||[],softBootCharges:G.player.softBootCharges||0
    });}
  },2000);
}

// ===== HOTKEY CONFIG =====
function openHotkeys(){
  document.getElementById('hk-ov').classList.add('show');
  renderHotkeyList();
}
function closeHotkeys(){
  document.getElementById('hk-ov').classList.remove('show');
  G.editingHotkey=null;
}
function renderHotkeyList(){
  const list=document.getElementById('hk-list');list.innerHTML='';
  const labels={spell1:'Spell 1',spell2:'Spell 2',spell3:'Spell 3',spell4:'Spell 4',spell5:'Spell 5',spell6:'Spell 6',spell7:'Spell 7',spell8:'Spell 8',hp_pot:'HP Potion',mp_pot:'Mana Potion'};
  Object.keys(DEFAULT_HOTKEYS).forEach(action=>{
    const row=document.createElement('div');row.className='hk-row';
    const name=document.createElement('span');name.className='hk-name';name.textContent=labels[action];
    const btn=document.createElement('span');btn.className='hk-key';btn.textContent=G.hotkeys[action];
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.hk-key.editing').forEach(b=>b.classList.remove('editing'));
      btn.classList.add('editing');btn.textContent='...';
      G.editingHotkey=action;
      const handler=ev=>{
        ev.preventDefault();ev.stopPropagation();
        G.hotkeys[action]=ev.key;saveHotkeys();
        btn.textContent=ev.key;btn.classList.remove('editing');
        G.editingHotkey=null;
        document.removeEventListener('keydown',handler,true);
        updSpells();
      };
      document.addEventListener('keydown',handler,true);
    });
    row.appendChild(name);row.appendChild(btn);list.appendChild(row);
  });
  const reset=document.createElement('div');reset.style.cssText='text-align:center;margin-top:8px;';
  const rbtn=document.createElement('button');rbtn.textContent='Reset to Default';
  rbtn.style.cssText='background:#333;border:1px solid #555;color:#ccc;font-family:inherit;font-size:6px;padding:4px 10px;border-radius:3px;cursor:pointer;';
  rbtn.addEventListener('click',()=>{G.hotkeys={...DEFAULT_HOTKEYS};saveHotkeys();renderHotkeyList();updSpells();});
  reset.appendChild(rbtn);list.appendChild(reset);
}

// ===== COLLAPSIBLE SECTIONS =====
function initCollapsible(){
  document.querySelectorAll('.pt[data-toggle]').forEach(pt=>{
    pt.addEventListener('click',()=>{
      const tgt=document.getElementById(pt.dataset.toggle);
      if(!tgt)return;
      pt.classList.toggle('collapsed');
      tgt.classList.toggle('hidden');
    });
  });
}

// ===== MIGRATE OLD SPELLS =====
function migrateSpells(){
  if(!G.player||!G.player.spells.length)return;
  const first=G.player.spells[0];
  if(/^\d+$/.test(first)){
    G.player.spells=G.player.spells.map(k=>{const sp=SPELLS[k];return sp?sp.id:k;}).filter(k=>SPELLS.find(s=>s.id===k));
  }
}

// ===== EVENT LISTENERS =====
let selV=null;
document.querySelectorAll('.vc').forEach(c=>{c.addEventListener('click',()=>{document.querySelectorAll('.vc').forEach(v=>v.classList.remove('sel'));c.classList.add('sel');selV=c.dataset.v;document.getElementById('bgo').disabled=!document.getElementById('cn').value.trim();});});
document.getElementById('cn').addEventListener('input',()=>{document.getElementById('bgo').disabled=!(document.getElementById('cn').value.trim()&&selV);});
document.getElementById('bgo').addEventListener('click',()=>{
  const n=document.getElementById('cn').value.trim();
  if(n&&selV){
    initGame(n,selV);
    setTimeout(()=>saveGame(G.player._charId),2000);
  }
});
document.getElementById('btn-new-char').addEventListener('click',showNewCharView);
document.getElementById('btn-back-list').addEventListener('click',showCharListView);
document.getElementById('scl').addEventListener('click',closeShop);
document.getElementById('skcl').addEventListener('click',closeSkills);
document.getElementById('blcl').onclick=()=>{document.getElementById('bless-ov').style.display='none';};
document.getElementById('hkcl').addEventListener('click',closeHotkeys);
document.getElementById('mm-zin').addEventListener('click',()=>{G.mmZoom=Math.min(6,G.mmZoom<1?G.mmZoom*2:G.mmZoom+1);renderMM();});
document.getElementById('mm-zout').addEventListener('click',()=>{G.mmZoom=Math.max(0.1,G.mmZoom<=1?G.mmZoom/2:G.mmZoom-1);renderMM();});
document.getElementById('mm').addEventListener('click',(e)=>{
  if(!G.player||!G.maps[G.floor])return;
  const mc=e.target;const rect=mc.getBoundingClientRect();
  const clickX=(e.clientX-rect.left)*(mc.width/rect.width);
  const clickY=(e.clientY-rect.top)*(mc.height/rect.height);
  const scale=G.mmZoom;const map=G.maps[G.floor];
  const mapW=map[0].length,mapH=map.length;
  const viewTX=Math.floor(mc.width/scale),viewTY=Math.floor(mc.height/scale);
  const stX=Math.max(0,Math.min(mapW-viewTX,G.player.x-Math.floor(viewTX/2)));
  const stY=Math.max(0,Math.min(mapH-viewTY,G.player.y-Math.floor(viewTY/2)));
  const wx=stX+Math.floor(clickX/scale),wy=stY+Math.floor(clickY/scale);
  if(wx<0||wy<0||wx>=mapW||wy>=mapH)return;
  if(!canW(wx,wy)){msg('No path! Destination is blocked.','system');G.autoPath=null;G.autoTarget=null;return;}
  if(wx===G.player.x&&wy===G.player.y)return;
  msg('Finding path to '+wx+', '+wy+'...','system');
  const path=findPath(G.player.x,G.player.y,wx,wy);
  if(path&&path.length>0){G.autoPath=path;G.autoTarget={x:wx,y:wy};msg('Walking to '+wx+', '+wy+' ('+path.length+' steps)','system');}
  else{G.autoPath=null;G.autoTarget=null;msg('No path found!','system');}
  renderMM();
});
initCollapsible();
document.getElementById('bresp').addEventListener('click',resp);
document.getElementById('wbtn').addEventListener('click',()=>{if(walletAddr){navigator.clipboard.writeText(walletAddr).then(()=>msg('Wallet address copied!','system')).catch(()=>{});}});

// ===== TERMS & LOGIN SCREEN =====
document.getElementById('chk-terms').addEventListener('change',function(){
  document.getElementById('btn-agree').disabled=!this.checked;
});
document.getElementById('btn-agree').addEventListener('click',function(){
  if(!document.getElementById('chk-terms').checked)return;
  localStorage.setItem('megarealms_terms_accepted','1');
  document.getElementById('terms-screen').style.display='none';
  document.getElementById('login-screen').style.display='block';
});
document.getElementById('btn-metamask').addEventListener('click',loginWithWallet);
document.getElementById('btn-rabby').addEventListener('click',loginWithWallet);
document.getElementById('btn-walletconnect').addEventListener('click',loginWithWallet);

// Check if terms already accepted
if(localStorage.getItem('megarealms_terms_accepted')==='1'){
  document.getElementById('terms-screen').style.display='none';
  document.getElementById('login-screen').style.display='block';
}

// Listen for wallet account changes
if(window.ethereum){
  window.ethereum.on('accountsChanged',function(accounts){
    if(accounts.length===0){
      walletAddr=null;
      location.reload();
    }else if(accounts[0]!==walletAddr){
      location.reload();
    }
  });
}

// Skip wallet (dev mode)
document.getElementById('btn-skip-wallet').addEventListener('click',function(){
  walletAddr='0xDEV_TEST_MODE';
  SAVE_KEY='megarealms_devtest_save_';
  migrateOldSaves();
  document.getElementById('login-screen').style.display='none';
  document.getElementById('start-screen').style.display='block';
  const wbtn=document.getElementById('wbtn');
  wbtn.textContent='DEV MODE';
  wbtn.style.borderColor='#f66';
  document.getElementById('wallet-info').innerHTML='<span style="color:#f66;">Dev Mode ‚Äî no wallet connected</span>';
  renderSaveSlots();
});

// renderSaveSlots called after wallet login
</script>
</body>
</html>
